---
title: "[4] Intra-abdominal Infections (IAIs): WHO AWaRe QIs analysis against gPPS data"
author: "CNPI AMR"
date: "Last compiled on `r format(Sys.time(), '%A %d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    df_print: paged
    highlight: tango
    fig_width: 10
    fig_height: 6
    fig_caption: true
    code_folding: hide
editor_options:
  markdown:
    wrap: 72
---

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
  üìä Report Overview
</h1>
<p style="font-size: 1.15em; color: #444; margin-top: -0.4em; margin-bottom: 1em;">
This report presents a summary of the AWaRe-based quality indicator analysis based on gPPS inpatient data for intra-abdominal infections (IAIs).

</p>


This analytical script implements **WHO AWaRe (Access, Watch, Reserve)** antibiotic use **quality indicators (QIs)** for treating **intra-abdominal infections (IAIs)** in adult inpatients with **community-acquired infections (CAIs)**. It utilises standardised data from the Global PPS (gPPS), specifically extracted from Excel-based outputs received by participating hospitals.


**Case Definition:**
<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
<strong>Intra-abdominal Infections</strong> (Based on WHO AWaRe book)<br>
‚ñ∏ <strong>gPPS diagnostic code:</strong> <code>IA</code><br>
‚ñ∏ <strong>gPPS definition:</strong> Includes hepatobiliary infections, intra-abdominal abscesses, and general abdominal sepsis
</div>

The aim is to assess the appropriateness of **empirical antibiotic prescribing** for intra-abdominal infections, benchmarked against WHO AWaRe guidance, and to provide structured feedback at both the hospital and department levels. These insights support **antimicrobial stewardship** by identifying patterns of suboptimal prescribing and opportunities for improvement.

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üéØ WHO AWaRe QIs for IAIs
</h2>

Within the gPPS data structure, **three QIs** have been identified as applicable for evaluating IAIs-related empirical antibiotic prescriptions in adults with CAIs:

<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_IAI_IV_ABX</strong>: Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) given IV antibiotics. <br><br>
2. <strong>H_IAI_WATCH_ABX</strong>:Proportion of patients presenting with any IAI given IV/oral Watch antibiotics.<br><br>
3. <strong>H_IAI_APPROP_DOSAGE</strong>: Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book.
</div>


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üí¨ General Notes:
</h2>
- Analysis includes only **adult patients (‚â•18 years)** with **CAIs** on **empirical** treatment.
- **IV administration** was inferred using the gPPS `"Route"` code `"P"` (Parenteral), recognising that it may include other parenteral routes but predominantly indicates IV use in empirical clinical practice.
- It was assumed that WHO recommendations for CA-IAIs align with the gPPS diagnostic code <code>IA</code>
- **QIs** were mapped and interpreted based on clinical assumptions aligning the WHO AWaRe Book with available gPPS codes.

---

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üîç  Initial Eligible Cases Check
</h1>

This section assesses whether there are enough eligible cases to support meaningful analysis.


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
# Clear environment
rm(list = ls())

# Define required packages
packages <- c(
  "dplyr", 
  "tidyverse", 
  "readxl", 
  "glue", 
  "htmltools",
  "purrr",
  "tidyr",
  "ggtext",
  "scales",
  "forcats",
  "scales",
  "kableExtra"
)

# Install missing packages
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) install.packages(new_packages)

# Load all packages
invisible(lapply(packages, library, character.only = TRUE))

# Read in sheets
data_info <- read_excel(
  "HA-Global-PPS_example_dummy data.xlsx",
  sheet = "Survey",
  col_types = c("guess", "date", "guess", "date")  # to read dates 
)
data_deps <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Department forms")
data_patients_all <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Patient forms")
data_lookup <- read_excel("QIs-Lookup.xlsx")

# Keep needed variables
data_patients <- data_patients_all %>%
  select("Survey Number", "Department name", "Age years", "Weight", "ATC5", "Single Unit Dose", "Unit", "N Doses/day", "Route", "AWaRe", "Diagnosis code", "Indication", "Treatment")


# Convert empty to NA
data_patients[data_patients == ""] <- NA


data_patients <- data_patients %>%
  mutate(
    AWaRe = ifelse(
      toupper(AWaRe) == "NOT_RECOMMENDED",
      "NOT RECOMMENDED",
      AWaRe
    )
  )

# Define AWaRe set
AWaRe_abx <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")

# Filter eligible IA cases
data_IA <- data_patients %>%
  filter(`Diagnosis code` == "IA") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Count eligible patients
eligible_IA_n <- data_IA %>%
  filter(AWaRe_compatible) %>%
  distinct(`Survey Number`) %>%
  nrow()
# Format survey dates (assuming they are stored in data_info)
survey_start <- format(data_info[[2]][3], "%d %b %Y")
survey_end <- format(data_info[[4]][3], "%d %b %Y")

# Feedback block for IAIs
html_feedback <- HTML(glue(
"<div style='background-color: #f0f8ff; border: 1px solid #add8e6; padding: 15px; border-radius: 5px; font-family: sans-serif;'>

  <p style='margin-bottom: 10px;'>
    <strong>üìÖ Survey period:</strong> {survey_start} to {survey_end}
  </p>

  <p>
    This script applies <strong>WHO AWaRe Quality Indicators</strong> to adult inpatients who received empirical antibiotics for community-acquired intra-abdominal infections (CA-IAIs).
  </p>

  <ul>
    <li><strong>Diagnostic code:</strong> IA</li>
    <li><strong>Total eligible cases:</strong> {eligible_IA_n}</li>
  </ul>

  {if(eligible_IA_n == 0){
    '<div style=\"background-color:#fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>üö´ No eligible cases found:</strong> There were no eligible cases for evaluation during this survey period. Please verify data availability.
    </div>'
  } else if(eligible_IA_n < 10){
    '<div style=\"background-color:#ffe0e0; border: 1px solid #ffb3b3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚ö†Ô∏è Caution:</strong> Few eligible cases detected. Interpret results with caution.
    </div>'
  } else {
    '<div style=\"background-color:#e0ffe0; border: 1px solid #b3ffb3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚úÖ Good to go!</strong> Sufficient eligible cases available to proceed with full evaluation.
    </div>'
  }}

</div>"
))

# Display the feedback
htmltools::browsable(html_feedback)


```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üßæ Summary of IAIs Eligible Patients for QI Assessment
</h1>

Eligible patients for **WHO AWaRe QI** assessment are defined as **adult inpatients (‚â•18 years)** who received **empirical antibiotics** for **CA-IAIs**.

This section presents both **prescription-level** and **patient-level** summaries to frame the proportions of the dataset relevant for QI evaluation.


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üë• Patient-Level Summary
</h2>

This table summarises unique patients across various characteristic groups, reflecting the clinical burden of IAIs and the proportion of patients eligible for quality indicator assessment.

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of patients on antibiotics: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong><br>
Total number of eligible patients on antibiotics: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "IA") %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total patients on antibiotics
total_patients <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Patient-level summary
patient_summary <- data.frame(
  Category = c(
    "Number of adult patients (‚â•18 years) who received empirical antibiotic treatment for CAI",
    "Number of all patients with a diagnosis of IAIs on any antibiotics",
    "**Number of eligible patients:** Adult patients (‚â•18 years) with a diagnosis of IAI who were treated empirically with antibiotics"
  ),
  Count = c(
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Diagnosis code` == "IA", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "IA", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_patients)
  )

# Render patient-level table
knitr::kable(
  patient_summary,
  col.names = c("Patient Category", "Number of Patients", "Proportion of All Patients"),
  format = "html",
  align = "lcr"
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")
```

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìë Prescription-Level Summary
</h2>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of antibiotic prescriptions: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% nrow()`</strong><br>
Total number of eligible antibiotic prescriptions: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "IA") %>% nrow()`</strong>

</div>

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Total prescriptions
total_prescriptions <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  nrow()

# Prescription-level summary
prescription_summary <- data.frame(
  Category = c(
    "Number of empirical antibiotic prescriptions administered to adult patients (‚â•18 years) for CAI",
    "Number of all antibiotic prescriptions for patients diagnosed with IAI",
    "**Number of eligible antibiotic prescriptions:** Antibiotics empirically prescribed for adult patients (‚â•18 years) with IAI"
  ),
  Count = c(
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Diagnosis code` == "IA", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "IA", AWaRe %in% AWaRe_abx) %>% nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_prescriptions)
  )

# Render prescription-level table
knitr::kable(
  prescription_summary,
  col.names = c("Prescription Category", "Number of Prescriptions", "Proportion of All Prescriptions"),
  format = "html",
  align = "lcr"
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")
```


<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìò WHO AWaRe-QIs Overview
</h1>

This script evaluates **THREE** WHO AWaRe indicators:


<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_IAI_IV_ABX</strong>: Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) given IV antibiotics. <br><br>
2. <strong>H_IAI_WATCH_ABX</strong>:Proportion of patients presenting with any IAI given IV/oral Watch antibiotics.<br><br>
3. <strong>H_IAI_APPROP_DOSAGE</strong>: Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book.
</div>



<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
<strong>üîç WHO AWaRe Book Recommendation:</strong><br><br>

<ul>
  <li><strong>Amoxicillin + clavulanic acid</strong> (1 g + 200 mg q8h IV or 875 mg + 125 mg q8h ORAL)</li>
  <li><strong>Cefotaxime</strong> (2 g q8h IV) + <strong>Metronidazole</strong> (500 mg q8h IV/ORAL)</li>
  <li><strong>Ceftriaxone</strong> (2 g q24h IV) + <strong>Metronidazole</strong> (500 mg q8h IV/ORAL)</li>
  <li><strong>Ciprofloxacin</strong> (500 mg q12h ORAL) + <strong>Metronidazole</strong> (500 mg q8h IV/ORAL)</li>
  <li><strong>Piperacillin + tazobactam</strong> (4 g + 500 mg q6h IV)</li>
  <li><strong>Meropenem</strong> (1 g q8h IV)</li>
</ul>
</div>

<div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin-top: 10px; margin-bottom: 18px;">
<strong>ü©∫ WHO AWaRe Notes:</strong>
<ul>
  <li>Please refer to the WHO AWaRe Antibiotic Book for detailed case-specific recommendations and considerations for different IAIs</li>

</ul>
</div>

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 1 ‚Äì IV Antibiotic Use
</h1>

> **H_IAI_IV_ABX:** Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) given IV antibiotics.


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of IV Antibiotic Use
</h2>

This section evaluates whether patients with **CA-IAIs** received empiric IV antibiotics.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Filter IA patients & flag eligibility
data_IA <- data_patients %>%
  filter(`Diagnosis code` == "IA") %>%
  mutate(
    Route = toupper(Route),
    Eligible = ifelse(`Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx, TRUE, FALSE)
  )

# Keep eligible patients only
data_IA_eligible <- data_IA %>%
  filter(Eligible == TRUE)

# Global denominators
total_IA <- data_IA %>% distinct(`Survey Number`) %>% nrow()
eligible_IA <- data_IA_eligible %>% distinct(`Survey Number`) %>% nrow()

#  If no eligible patients, show fallback message
if (eligible_IA == 0 || is.na(eligible_IA)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating IV antibiotic use in community-acquired IAIs.<br><br>
    <em>This may indicate that no patients received antibiotics, or none met inclusion criteria.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {

  # Summarise whether IV route was used (unique patient-level)
  summary_iv <- data_IA_eligible %>%
    group_by(`Survey Number`, `Department name`) %>%
    summarise(
      Received_IV = any(Route == "P"),
      .groups = "drop"
    )

  # Department-level summary
  summary_iv_dept <- summary_iv %>%
    group_by(`Department name`) %>%
    summarise(
      Eligible = n(),
      Received_IV = sum(Received_IV),
      Not_IV = Eligible - Received_IV,
      Prop_IV = round(100 * Received_IV / Eligible, 1),
      Prop_Not = round(100 * Not_IV / Eligible, 1),
      .groups = "drop"
    )

  # Add hospital-level summary
  summary_iv_total <- summary_iv %>%
    summarise(
      `Department name` = "Hospital-Wide",
      Eligible = n(),
      Received_IV = sum(Received_IV),
      Not_IV = Eligible - Received_IV,
      Prop_IV = round(100 * Received_IV / Eligible, 1),
      Prop_Not = round(100 * Not_IV / Eligible, 1)
    )

  # Combine summaries
  summary_iv_final <- bind_rows(summary_iv_total, summary_iv_dept)

  # Intro block
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíâ <strong>Denominator:</strong> Number of eligible IAI patients who received any antibiotics (<strong>{eligible_IA}</strong> out of {total_IA})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Format summary cards
  formatted_blocks <- summary_iv_final %>%
    mutate(block = pmap_chr(
      list(`Department name`, Prop_IV, Received_IV, Prop_Not, Not_IV, Eligible),
      function(dept, iv_p, iv_n, not_p, not_n, total_n) {
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

          <ul style='margin-left: 1.2em; line-height: 1.8; padding-left: 0; list-style-type: none;'>
            <li>
              <span style='display: inline-block; background-color: #007bff; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>1</span>
              <strong>Received IV antibiotic</strong>: <strong>{scales::percent(iv_p / 100, accuracy = 0.1)}</strong> ({iv_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #ffc107; color: black; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>2</span>
              <strong>Did not receive IV antibiotic</strong>: <strong>{scales::percent(not_p / 100, accuracy = 0.1)}</strong> ({not_n} out of {total_n})
            </li>
          </ul>

          </div>"
        )
      }
    )) %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Combine all into HTML
  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks$block, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}


```


***

<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The proportions shown reflect the number of unique adult patients with IAIs who received antibiotics via the IV or non-IV (e.g., oral or other) route. Each patient is counted only once per route category, even if multiple antibiotics were prescribed via the same route.
</div>


***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by Route of Administration
</h2>

This visual summarises the proportion of patients with IAIs who received an IV antibiotic across hospital departments by route of administration

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
#  Classify each eligible IAI prescription route
summary_iv_route <- data_IA_eligible %>%
  mutate(
    Route_Group = case_when(
      Route == "P" ~ "IV",
      Route == "O" ~ "Oral",
      TRUE ~ "Other"
    )
  ) %>%
  distinct(`Survey Number`, `Department name`, Route_Group) %>%
  count(`Department name`, Route_Group, name = "Count")

#  Ensure all combinations exist (even with 0s)
dept_list <- unique(data_IA_eligible$`Department name`)
route_levels <- c("IV", "Oral", "Other")

complete_grid <- expand.grid(
  `Department name` = dept_list,
  Route_Group = route_levels,
  stringsAsFactors = FALSE
)

summary_iv_route <- complete_grid %>%
  left_join(summary_iv_route, by = c("Department name", "Route_Group")) %>%
  mutate(Count = replace_na(Count, 0))

#  Add hospital-wide summary
hospital_route_summary <- summary_iv_route %>%
  group_by(Route_Group) %>%
  summarise(Count = sum(Count), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide")

#  Combine and prepare for plotting
plot_data <- bind_rows(summary_iv_route, hospital_route_summary) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Count),
    Proportion = ifelse(Total == 0, 0, Count / Total),
    Label = ifelse(Proportion > 0.05, paste0(round(Proportion * 100), "%\n(n=", Count, ")"), "")
  ) %>%
  ungroup() %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(PlotLabel, levels = c(
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      sort(setdiff(unique(PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
    )),
    Route_Group = factor(Route_Group, levels = route_levels)
  )

#  Donut-style faceted pie chart (with empty plots shown)
ggplot(plot_data, aes(x = 2, y = Proportion, fill = Route_Group)) +
  geom_bar(stat = "identity", width = 0.1) +
  coord_polar(theta = "y") +
  facet_wrap(~ PlotLabel, nrow = 2, strip.position = "bottom", drop = FALSE) +
  geom_text(aes(label = Label), position = position_stack(vjust = 0.5), size = 2.5, color = "white") +
  scale_fill_manual(
    values = c("IV" = "#4682B4", "Oral" = "#CD5C5C", "Other" = "#A9A9A9")
  ) +
  theme_void(base_size = 10) +
  theme(
    strip.text = ggtext::element_markdown(face = "bold", size = 8),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Route of Antibiotic Use by Department (IAIs)",
    fill = "Route"
  )


```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 2 - IV/Oral Watch Antibiotic Use
</h1>

> **H_IAI_WATCH_ABX:** Proportion of patients presenting with any IAI given IV/oral Watch antibiotics.

***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of IV/Oral Antibiotic Use
</h2>

This section summarises IV/Oral antibiotic use for patients with IAI across hospital departments
        
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Filter IAIs patients & flag eligibility
data_IAI3 <- data_patients %>%
  filter(`Diagnosis code` == "IA") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Filter eligible patients only
data_IAI3_eligible <- data_IAI3 %>%
  filter(AWaRe_compatible == TRUE)

# Total patients and eligible count
total_IAI3 <- data_IAI3 %>% distinct(`Survey Number`) %>% nrow()
eligible_IAI3 <- data_IAI3_eligible %>% distinct(`Survey Number`) %>% nrow()

# Handle 0 eligible case
if (eligible_IAI3 == 0 || is.na(eligible_IAI3)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV/Oral WATCH antibiotic use in IAIs.<br><br>
    <em>This may indicate that no patients met the criteria, or none received compatible antibiotics during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {

  # One row per patient per AWaRe + Route group
  summary_watch <- data_IAI3_eligible %>%
    mutate(
      Route_Group = case_when(
        Route %in% c("P", "O") ~ "IV_ORAL",
        TRUE ~ "OTHER"
      ),
      WATCH_IV_ORAL = (AWaRe == "WATCH" & Route_Group == "IV_ORAL"),
      WATCH_OTHER   = (AWaRe == "WATCH" & Route_Group == "OTHER"),
      NON_WATCH     = (AWaRe != "WATCH")
    ) %>%
    group_by(`Survey Number`, `Department name`) %>%
    summarise(
      WATCH_IV_ORAL = any(WATCH_IV_ORAL),
      WATCH_OTHER   = any(WATCH_OTHER),
      NON_WATCH     = any(NON_WATCH),
      .groups = "drop"
    )

  # Department-level summary
  summary_watch_dept <- summary_watch %>%
    group_by(`Department name`) %>%
    summarise(
      Eligible = n(),
      WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
      WATCH_OTHER = sum(WATCH_OTHER),
      NON_WATCH = sum(NON_WATCH),
      Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
      Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
      Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1),
      .groups = "drop"
    )

  # Hospital-wide summary
  summary_watch_total <- summary_watch %>%
    summarise(
      `Department name` = "Hospital-Wide",
      Eligible = n(),
      WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
      WATCH_OTHER = sum(WATCH_OTHER),
      NON_WATCH = sum(NON_WATCH),
      Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
      Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
      Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1)
    )

  # Combine summaries
  summary_watch_final <- bind_rows(summary_watch_total, summary_watch_dept)

  # Intro block
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible IAIs patients who received antibiotics (<strong>{eligible_IAI3}</strong> out of {total_IAI3})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Formatted blocks
  formatted_blocks <- summary_watch_final %>%
    mutate(block = pmap_chr(
      list(
        `Department name`,
        Prop_WATCH_IV_ORAL, WATCH_IV_ORAL,
        Prop_WATCH_OTHER, WATCH_OTHER,
        Prop_NON_WATCH, NON_WATCH,
        Eligible
      ),
      function(dept, ivoral_p, ivoral_n, other_p, other_n, nonwatch_p, nonwatch_n, total_n) {
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

          <ul style='margin-left: 1.2em; line-height: 1.8; padding-left: 0; list-style-type: none;'>
            <li>
              <span style='display: inline-block; background-color: #007bff; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>1</span>
              <strong>Received a WATCH antibiotic via IV or Oral route</strong>: <strong>{scales::percent(ivoral_p / 100, accuracy = 0.1)}</strong> ({ivoral_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #17a2b8; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>2</span>
              <strong>Received a WATCH antibiotic via other route</strong>: <strong>{scales::percent(other_p / 100, accuracy = 0.1)}</strong> ({other_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #ffc107; color: black; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>3</span>
              <strong>Received a NON-WATCH antibiotic</strong>: <strong>{scales::percent(nonwatch_p / 100, accuracy = 0.1)}</strong> ({nonwatch_n} out of {total_n})
            </li>
          </ul>

          </div>"
        )
      }
    ))

  # Reorder Hospital-Wide first
  formatted_blocks <- formatted_blocks %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Render HTML output
  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks$block, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}


```


***

<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The proportions are based on the number of unique IAIs patients per department for each specific combination of WHO AWaRe antibiotic category and route of administration. A patient contributes to the count for each distinct AWaRe category and route combination they received. Receiving the same combination multiple times does not increase the count for that combination for that patient.
  <br>
</div>


***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by AWaRe Classification
</h2>

This visual summarises the proportion of antibiotic prescription for IAIs across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#  Summarise AWaRe category by department
aware_summary <- data_IAI3_eligible %>%
  group_by(`Department name`, Survey_ID = `Survey Number`, AWaRe) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, AWaRe) %>%
  summarise(Patients = n(), .groups = "drop")

#  Create hospital-level summary
hospital_row <- aware_summary %>%
  group_by(AWaRe) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital")

#  Define AWaRe levels
aware_levels_stack <- c("UNCLASSIFIED", "NOT RECOMMENDED", "RESERVE", "WATCH", "ACCESS")
aware_levels_legend <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")

#  Ensure all AWaRe levels are represented per department (even if 0)
all_combos2 <- expand_grid(
  `Department name` = unique(c(aware_summary$`Department name`, "Hospital")),
  AWaRe = aware_levels_stack
)

aware_summary_all <- all_combos2 %>%
  left_join(bind_rows(aware_summary, hospital_row), by = c("Department name", "AWaRe")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()


aware_summary_all$AWaRe <- factor(aware_summary_all$AWaRe, levels = aware_levels_stack)

#  Format Hospital-Wide label and PlotLabel for axis
aware_summary_all <- aware_summary_all %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

aware_summary_all$PlotLabel <- factor(
  aware_summary_all$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(aware_summary_all$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

#  Plot
ggplot(aware_summary_all, aes(x = PlotLabel, y = Proportion, fill = AWaRe)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +

  geom_text(
    data = aware_summary_all %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.03, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0, size = 3.5, color = "gray30"
  ) +

  scale_fill_manual(
    breaks = aware_levels_legend,
    values = c(
      "ACCESS" = "#1b9e77",
      "WATCH" = "#ff7f00",
      "RESERVE" = "#e41a1c",
      "NOT RECOMMENDED" = "#8c510a",
      "UNCLASSIFIED" = "gray70"
    )
  ) +
  coord_flip(ylim = c(0, 1.08)) +
  labs(
    title = "Proportion of IAIs Patients on Antibiotics by AWaRe",
    x = "Department",
    y = "Proportion of Patients",
    fill = "AWaRe Category"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 10),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 12),
    panel.border = element_rect(color = "gray70", fill = NA),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.margin = margin(10, 10, 10, 10)
  )


```

<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The AWaRe classification divides antibiotics into three categories: Access, Watch, and Reserve. Access antibiotics are first-line treatments with a low risk of resistance, typically recommended for common infections. Watch antibiotics are associated with a higher risk of resistance and require careful monitoring. Reserve antibiotics are reserved for critical cases involving resistant infections, typically used only when other options are ineffective </strong>.
  <br>
</div>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Note:</strong> This count in this visual represents the number of unique patients who were prescribed at least one antibiotic within a specific WHO AWaRe category (Access, Watch, or Reserve) during their encounter. A patient is counted once for each distinct AWaRe category they received an antibiotic from.
  <br>
</div>



***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by Route of Administration
</h2>

This visual summarises the proportion of IAIs Patients on **Watch Antibiotics** across hospital departments by Route of Administration


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
#  Filter eligible IAIs patients receiving WATCH antibiotics
watch_route_summary <- data_IAI3_eligible %>%
  filter(AWaRe == "WATCH") %>%
  mutate(
    Route_Clean = case_when(
      Route %in% c("P", "O") ~ "IV/Oral",
      TRUE ~ "Others"
    )
  ) %>%
  group_by(`Department name`, `Survey Number`, Route_Clean) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, Route_Clean) %>%
  summarise(Patients = n_distinct(`Survey Number`), .groups = "drop") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  )


#  Add hospital-level row
hospital_watch_summary <- watch_route_summary %>%
  group_by(Route_Clean) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(
    `Department name` = "Hospital-Wide",
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  select(names(watch_route_summary))  # Match column order

# Combine with main data
watch_route_final <- bind_rows(watch_route_summary, hospital_watch_summary)

# Ensure all department √ó route combinations are present
route_levels <- c("IV/Oral", "Others")
all_combos3 <- expand_grid(
  `Department name` = unique(watch_route_final$`Department name`),
  Route_Clean = route_levels
)

# Rebuild full dataset with 0s where missing
watch_route_final <- all_combos3 %>%
  left_join(watch_route_final, by = c("Department name", "Route_Clean")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total > 0, Patients / Total, 0)
  )


#  Create PlotLabel with HTML styling
watch_route_final <- watch_route_final %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

# Reorder PlotLabel so Hospital-Wide appears first
watch_route_final$PlotLabel <- factor(
  watch_route_final$PlotLabel,
  levels = c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(watch_route_final$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  )
)


#  Plot
ggplot(watch_route_final, aes(x = PlotLabel, y = Proportion, fill = Route_Clean)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.2, color = "black"
  ) +

  geom_text(
    data = watch_route_final %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0.5, size = 3.3, color = "gray30"
  ) +

  scale_fill_manual(
    values = c(
      "IV/Oral" = "#3B8EDE",
      "Others" = "#e41a1c"
    ),
    labels = c("IV/Oral" = "IV or Oral", "Others" = "Other Routes")
  ) +

  labs(
    title = "Route of Administration for WATCH Antibiotics (IAIs Patients)",
    subtitle = "Among eligible patients only",
    x = "Department",
    y = "Proportion of Patients",
    fill = "Route"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_markdown(angle = 45, hjust = 1),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "gray70", fill = NA)
  )

```


<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> This visual shows the proportion of unique IAIs patients in each department who received at least one antibiotic from the WHO AWaRe <strong>Watch</strong> category, considering the route of administration. A patient is counted once for each distinct route through which they received a Watch antibiotic.
  <br>
</div>


***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 3 ‚Äì IV Antibiotic Choice & Dosage Appropriateness
</h1>

> <strong>H_IAI_APPROP_DOSAGE:</strong> Proportion of patients presenting with any IAI (e.g. Cholecystitis, Cholangitis, Acute Appendicitis, Acute Diverticulitis) prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Data preparation: antibiotic choice appropriateness

#  Prepare the data (Select IAs data only)
data_IA_choice <- data_patients %>%
  filter(`Diagnosis code` == "IA") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

#  Lookup ABX names for IAIs QI
lookup_names <- data_lookup %>%
  filter(Code == "H_IAI_APPROP_DOSAGE") %>%
  select(starts_with("ABX-ATC")) %>%
  unlist(use.names = FALSE)

#  Flag matched prescriptions
data_IA_choice <- data_IA_choice %>%
  mutate(
    Drug_Match = ATC5 %in% lookup_names
  )

#  Extract lookup info 
lookup_IA_choice <- data_lookup %>%
  filter(Code == "H_IAI_APPROP_DOSAGE")

# Create long format from lookup
lookup_long <- tibble(
  Drug = unlist(lookup_IA_choice %>% select(starts_with("ABX-ATC")), use.names = FALSE),
  Choice = unlist(lookup_IA_choice %>% select(starts_with("ABX-CHOICE")), use.names = FALSE)
) %>%
  filter(!is.na(Drug))  # Remove empty rows

# Merge choice info with patient-level data
data_IA_choice <- data_IA_choice %>%
  left_join(lookup_long, by = c("ATC5" = "Drug"))

# Patient Summary for Intra-Abdominal Infection (IA)
patient_summary_IA <- data_IA_choice %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    Abx_names = list(unique(ATC5[Route == "P"])),
    
    Match_1_P = any(ATC5 == lookup_names[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names[5] & Route == "P"),
    Match_6_P = any(ATC5 == lookup_names[6] & Route == "P"),
    Match_7_P = any(ATC5 == lookup_names[7] & Route == "P"),

    Any_Oral = any(Route == "O"),
    Any_IV = any(Route == "P"),
    N_ABX = n_distinct(ATC5),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
Num_recommended_given = sum(c_across(c(Match_1_P, Match_2_P, Match_3_P, Match_4_P, Match_6_P, Match_7_P))),
    All_IV_names_flat = paste0(unlist(Abx_names), collapse = ","),

    # Full match = recommended pair given and no extra IV abx
    Received_full_recommended_IV = (
  (
    # Monotherapy cases
    (Match_1_P & Num_recommended_given == 1 & N_ABX == 1) |
    (Match_6_P & Num_recommended_given == 1 & N_ABX == 1) |
    (Match_7_P & Num_recommended_given == 1 & N_ABX == 1)
  ) |
  (
    # Dual therapy cases
    ((Match_2_P & Match_4_P) |
     (Match_3_P & Match_4_P)) &
     Num_recommended_given == 2 & N_ABX == 2
  )
),

    # No match at all with recommended options
    Received_no_recommended_IV = Any_IV & Num_recommended_given == 0,

    # Partial = recommended abx used, but not in full combo or with extra abx
    Received_partial_recommended_IV = Any_IV & !Received_full_recommended_IV & !Received_no_recommended_IV,

    # flag patients who only got oral or non-matching routes
    Received_oral_only = Any_Oral & !Any_IV,
    Other_non_IV_or_oral = !Received_full_recommended_IV & !Received_partial_recommended_IV & 
                           !Received_no_recommended_IV & !Received_oral_only
  ) %>%
  ungroup()


#  Get not eligible patients with department info
not_eligible_patients_IA <- data_IA_choice %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(Ineligible = all(AWaRe_compatible == FALSE), .groups = "drop") %>%
  filter(Ineligible)

#  Create summary table with Department name
eligible_long_IA <- patient_summary_IA %>%
  select(`Survey Number`, `Department name`, Received_full_recommended_IV, Received_partial_recommended_IV, Received_no_recommended_IV, Received_oral_only, Other_non_IV_or_oral) %>%
  pivot_longer(
    cols = -c(`Survey Number`, `Department name`),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(Value = as.logical(Value)) %>%
  filter(Value) %>%
  group_by(`Department name`, Indicator) %>%
  summarise(Patients = n(), .groups = "drop")

# Get all possible combinations of departments and indicators
all_combos <- expand_grid(
  `Department name` = unique(patient_summary_IA$`Department name`),
  Indicator = c("Received_full_recommended_IV", "Received_partial_recommended_IV", "Received_no_recommended_IV", "Received_oral_only", "Other_non_IV_or_oral", "Not_Eligible")
)

# Left join and replace NAs with 0
eligible_long_IA <- all_combos %>%
  left_join(eligible_long_IA, by = c("Department name", "Indicator")) %>%
  mutate(Patients = replace_na(Patients, 0))


# Add not eligible
ineligible_summary_IA <- not_eligible_patients_IA %>%
  count(`Department name`) %>%
  mutate(Indicator = "Not_Eligible") %>%
  rename(Patients = n)

# Combine
qi_long_IA <- bind_rows(eligible_long_IA, ineligible_summary_IA)

# Calculate total per department
dept_totals <- qi_long_IA %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

# Final summary table with proportions
qi_summary_IA <- qi_long_IA %>%
  left_join(dept_totals, by = "Department name") %>%
  mutate(
    Indicator = case_when(
      Indicator == "Received_full_recommended_IV" ~ "Received recommended IV antibiotics",
      Indicator == "Received_partial_recommended_IV" ~ "Partially received recommended IV antibiotics",
      Indicator == "Received_no_recommended_IV" ~ "Received IV antibiotics not among recommended options",
      Indicator == "Received_oral_only" ~ "Received oral antibiotics",
      Indicator == "Other_non_IV_or_oral" ~ "Received other non-IV/oral antibiotics",
      Indicator == "Not_Eligible" ~ "Not eligible for AWaRe IAIs QIs",
      TRUE ~ Indicator
    ),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  select(`Department name`, Indicator, Patients, Total, Proportion)

#  Add Hospital Total row 
hospital_data <- qi_summary_IA %>%
  group_by(Indicator) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  select(`Department name`, Indicator, Patients)

# Combine with original data
qi_summary_IA <- bind_rows(qi_summary_IA, hospital_data)

# Recalculate totals and proportions
qi_summary_IA <- qi_summary_IA %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()

# Format "Hospital" label to bold
qi_summary_IA <- qi_summary_IA %>%
  mutate(`Department name` = ifelse(`Department name` == "Hospital-Wide", "Hospital-Wide", `Department name`))

```
 

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness for IAIs
</h2>


This section assesses whether adult inpatients with **CA-IAIs** were prescribed the appropriate empirical IV antibiotics based on the WHO AWaRe Antibiotic Book.


```{r echo=FALSE, warning=FALSE, message=FALSE}

# Label definitions
indicator_labels <- c(
  "Received_full_recommended_IV"     = "Received recommended IV antibiotics",
  "Received_partial_recommended_IV"  = "Partially received recommended IV antibiotics",
  "Received_no_recommended_IV"       = "Received IV antibiotics not among recommended options",
  "Received_oral_only"               = "Received oral antibiotics",
  "Other_non_IV_or_oral"       = "Received other non-IV/oral antibiotics",
  "Not_Eligible"                     = "Not eligible for AWaRe IAIs QIs"
)

# Color codes
drug_choice_colors <- c(
  "Received recommended IV antibiotics"      = "#1F77B4",
  "Partially received recommended IV antibiotics" = "#4FA9DC",
  "Received IV antibiotics not among recommended options"    = "#EF476F",
  "Received oral antibiotics"                     = "#F9D99E",
  "Received other non-IV/oral antibiotics"        = "#D3D3D3",
  "Not eligible for AWaRe IAIs QIs"             = "#A9A9A9"
)

# Prepare PlotLabel and reorder
qi_summary_IA <- qi_summary_IA %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(
      PlotLabel,
      levels = c("<b style='color:#0072B2;'>Hospital-Wide</b>",
                 sort(setdiff(unique(`Department name`), "Hospital-Wide-Wide")))
    ),
    Indicator = factor(
      Indicator,
      levels = c(
        "Received recommended IV antibiotics",
        "Partially received recommended IV antibiotics",
        "Received IV antibiotics not among recommended options",
        "Received oral antibiotics",
        "Received other non-IV/oral antibiotics",
        "Not eligible for AWaRe IAIs QIs"
      )
    )
  )

# Plot
ggplot(qi_summary_IA, aes(x = PlotLabel, y = Proportion, fill = Indicator)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  geom_text(
    aes(label = ifelse(Patients > 0, Patients, "")),
    position = position_fill(vjust = 0.5),
    size = 3, color = "black"
  ) +
  geom_text(
    data = qi_summary_IA %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0.5
  ) +
  scale_fill_manual(
    values = drug_choice_colors,
    labels = indicator_labels
  ) +
  scale_y_continuous(limits = c(0, 1.09), expand = c(0, 0)) +
  labs(
    title = "Antibiotic Choice Appropriateness Summary for IAIs",
    subtitle = "Each bar shows treatment appropriateness distribution per WHO AWaRe Book (counts shown within segments)",
    x = "Department",
    y = "Proportion of Patients",
    fill = "Treatment Appropriateness Category"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    axis.text.x = element_markdown(size = 8, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 8),
    axis.title = element_text(face = "bold", size = 10),
    legend.position = "right",
    legend.title = element_text(face = "bold", size = 9),
    legend.text = element_text(size = 8, margin = margin(b = 4)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 11),
    plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 7, title.position = "top")
  )
```


---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by AWaRe Classification
</h2>

This visual summarises the proportion of IV antibiotic choice appropriateness for IAIs across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve). 
 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Classify antibiotics into AWaRe groups
data_IA_AWaRe <- data_IA_choice %>%
  mutate(
    AWaRe2 = case_when(
      ATC5 %in% c("J01DD01", "J01DD04") ~ "LOW WATCH", 
      ATC5 == "J01CR05" ~ "MEDIUM WATCH", 
      ATC5 == "J01DH02" ~ "HIGH WATCH",   
      ATC5 %in% c("J01CR02", "J01XD01") ~ "ACCESS", 
      TRUE ~ NA_character_
    )
  )

# Identify primary and secondary antibiotics
data_IA_AWaRe <- data_IA_AWaRe %>%
  filter(AWaRe_compatible, Route == "P", !is.na(AWaRe2))


# Filter only valid cases
aware_expanded <- data_IA_AWaRe %>%
  select(`Survey Number`, `Department name`, AWaRe2) %>%
  distinct()

# Summarise by department and AWaRe2
AWaRe_long <- aware_expanded %>%
  group_by(`Department name`, AWaRe2) %>%
  summarise(Patients = n(), .groups = "drop")

# Add totals and proportions per department
AWaRe_dept_totals <- AWaRe_long %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

AWaRe_long <- AWaRe_long %>%
  left_join(AWaRe_dept_totals, by = "Department name") %>%
  mutate(Proportion = round(Patients / Total, 3))

# Add Hospital-Wide totals
AWaRe_hospital_data <- aware_expanded %>%
  group_by(AWaRe2) %>%
  summarise(Patients = n(), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide")

AWaRe_long <- bind_rows(AWaRe_long, AWaRe_hospital_data)

# Recalculate totals and proportions with Hospital-Wide
AWaRe_long <- AWaRe_long %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()



# --- Plotting ----


#  Ensure AWaRe2 factor has full levels
aware_levels_all <- c("ACCESS", "LOW WATCH", "MEDIUM WATCH", "HIGH WATCH")
aware_levels_stack <- c("HIGH WATCH", "MEDIUM WATCH", "LOW WATCH", "ACCESS")

AWaRe_long <- AWaRe_long %>%
  mutate(AWaRe2 = factor(AWaRe2, levels = aware_levels_stack))

#  Add dummy rows for missing categories (for legend consistency)
missing_levels <- setdiff(aware_levels_all, unique(AWaRe_long$AWaRe2))
if (length(missing_levels) > 0) {
  dummy_rows <- expand.grid(
    `Department name` = unique(AWaRe_long$`Department name`)[1],
    AWaRe2 = missing_levels
  ) %>%
    mutate(Proportion = 0, Total = 0)
  
  AWaRe_long <- bind_rows(AWaRe_long, dummy_rows)
}

#  Format PlotLabel with markdown styling for Hospital-Wide
AWaRe_long <- AWaRe_long %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

AWaRe_long$PlotLabel <- factor(
  AWaRe_long$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(AWaRe_long$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

#  Create color palette
aware_colors <- c(
  "ACCESS"       = "#1B9E77",
  "LOW WATCH"    = "#FDB863",
  "MEDIUM WATCH" = "#E08214",
  "HIGH WATCH"   = "#B35806"
)

#  Create plot
ggplot(AWaRe_long, aes(x = PlotLabel, y = Proportion, fill = AWaRe2)) +
  
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +
  
  geom_text(
    data = AWaRe_long %>%
      distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = ifelse(Total > 0, paste0("n=", Total), "")),
    inherit.aes = FALSE,
    size = 4, color = "gray30", hjust = 0
  ) +
  
  scale_fill_manual(
    breaks = aware_levels_all,
    values = aware_colors,
    drop = FALSE,
    name = "AWaRe Classification"
  ) +
  
  coord_flip() +
  expand_limits(y = 1.05) +
  
  labs(
    title = "Use of Recommended IV Antibiotics by AWaRe Classification",
    subtitle = "Proportions by department (percentages shown inside bars)",
    x = "Department",
    y = "Proportion of Patients"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.border = element_rect(color = "gray70", fill = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(margin = margin(r = 4)),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  
  guides(
    fill = guide_legend(nrow = 2, byrow = TRUE, title.position = "top")
  )

```



<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> Each patient is counted once per AWaRe category if they received at least one recommended IV antibiotic from that category. Patients treated with recommended antibiotic combinations from multiple categories are included in each, so category totals can exceed the number of unique patients.
  <br>
</div>


<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Note:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
    <li>In subgrouping the "Watch" category within the WHO AWaRe classification, we followed the method outlined by Neal J. Russell and colleagues (2023). They divided the "Watch" category into three subgroups‚ÄîLow (e.g., cefotaxime, ceftriaxone), Medium (e.g., piperacillin-tazobactam), and High (e.g., meropenem)‚Äîto better reflect the risk of resistance, based on current WHO guidelines and the potential for resistance development when antibiotics are used outside these recommendations.
 </li>  <br>
    <li>For further details, see Russell NJ, St√∂hr W, Plakkal N, Cook A, Berkley JA, et al. (2023) Patterns of antibiotic use, pathogens, and prediction of mortality in hospitalized neonates and young infants with sepsis: A global neonatal sepsis observational cohort study (NeoOBS). PLOS Medicine 20(6): e1004179. https://doi.org/10.1371/journal.pmed.1004179
</li>
  </ul>
</div>

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by line of treatment
</h2>

This visual summarises the proportion of antibiotic choice appropriateness for IAIs across hospital departments by line of treatment (First choice, Second choice)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#  Summarise choice of IV antibiotic line (First vs Second) for IAIs
choice_summary <- data_IA_choice %>%
  filter(AWaRe_compatible == TRUE, Route == "P", Choice != "Both", !is.na(Choice)) %>%
  group_by(`Department name`, Choice) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Prescriptions),
    Proportion = Prescriptions / Total
  ) %>%
  ungroup()

#  Add Hospital-Wide totals
hospital_summary <- choice_summary %>%
  group_by(Choice) %>%
  summarise(Prescriptions = sum(Prescriptions), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Prescriptions),
    Proportion = Prescriptions / Total
  ) %>%
  ungroup()

#  Combine summaries
choice_summary <- bind_rows(choice_summary, hospital_summary)

#  Ensure all departments √ó choices exist
choice_levels <- c("First choice", "Second choice")
dept_list <- unique(choice_summary$`Department name`)

complete_data <- expand_grid(
  `Department name` = dept_list,
  Choice = choice_levels
) %>%
  left_join(choice_summary, by = c("Department name", "Choice")) %>%
  mutate(
    Prescriptions = replace_na(Prescriptions, 0),
    Total = ave(Prescriptions, `Department name`, FUN = sum),
    Proportion = ifelse(Total > 0, Prescriptions / Total, 0)
  )

#  Apply markdown styling to Hospital-Wide
complete_data <- complete_data %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

# Reorder Hospital-Wide to appear first
complete_data$PlotLabel <- factor(
  complete_data$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(complete_data$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

#  Ensure recommended stacking order
complete_data$Choice <- factor(complete_data$Choice, levels = c("Second choice", "First choice"))

#  Plot
ggplot(complete_data, aes(x = PlotLabel, y = Proportion, fill = Choice)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +

  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +

  geom_text(
    data = complete_data %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3.3, color = "gray30", hjust = 0
  ) +

  scale_fill_manual(
    breaks = choice_levels,
    values = c(
      "First choice"  = "#8E44AD",
      "Second choice" = "#00BCD4"
    ),
    drop = FALSE,
    name = "Treatment Choice"
  ) +

  coord_flip(ylim = c(0, 1.06)) +

  labs(
    title = "Use of Recommended IV Antibiotics by Line of Treatment",
    subtitle = "Proportion of IAIs patients prescribed First vs Second choice empirical treatment (IV route)",
    x = "Department",
    y = "Proportion of Patients"
  ) +

  theme_minimal(base_size = 11) +
  theme(
    axis.text.y = element_markdown(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 9),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 1, byrow = TRUE, title.position = "top")
  )


```
<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> Patients who received metronidazole alone were not included in this analysis, as it serves as adjunct therapy for anaerobic coverage and does not independently define the treatment line for IAIs according to the WHO AWaRe Book.</div>

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice Appropriateness for IAIs
</h2>

This section summarises the proportion of antibiotic **choice appropriateness** for IAIs across hospital departments based on the WHO AWaRe Book.

  
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}

# Total eligible IAI patients (excluding "Not eligible")
total_eligible <- qi_summary_IA %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator != "Not eligible for AWaRe IAIs QIs") %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Total receiving any IV antibiotic in relevant categories
total_iv <- qi_summary_IA %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  )) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Extract relevant subset
relevant_data <- qi_summary_IA %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  ))

# If no relevant data, return message
if (nrow(relevant_data) == 0 || total_iv == 0 || is.na(total_iv)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for IAI.<br><br>
    <em>This may indicate that no patients received IV antibiotics, or that none met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Summarise department-level proportions
  summary_data_IA <- relevant_data %>%
    group_by(`Department name`, Indicator) %>%
    summarise(Patients = sum(Patients), .groups = "drop") %>%
    pivot_wider(
      names_from = Indicator,
      values_from = Patients,
      values_fill = 0
    ) %>%
    mutate(
      Total = `Received recommended IV antibiotics` +
              `Partially received recommended IV antibiotics` +
              `Received IV antibiotics not among recommended options`,
      Prop_Recommended   = `Received recommended IV antibiotics` / Total,
      Prop_Partial       = `Partially received recommended IV antibiotics` / Total,
      Prop_Not_Recommended = `Received IV antibiotics not among recommended options` / Total
    ) %>%
    filter(Total > 0)

  # If pivoted data is empty (e.g., all NA/missing), fallback again
  if (nrow(summary_data_IA) == 0) {
    final_summary_html <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
      ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for IAI.<br><br>
  <em>This may indicate that no patients received IV antibiotics, or that none met the inclusion criteria during the reporting period.</em>
      </div>"
    ))
    htmltools::browsable(final_summary_html)

  } else {
    # Intro block
    intro_text <- glue::glue(
      "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
      üíä <strong>Denominator:</strong> Number of eligible IAI patients who received any IV antibiotic (<strong>{total_iv}</strong> out of <strong>{total_eligible}</strong>)
      </div><br><br>
      <strong>Summary:</strong><br><br>"
    )

    # Format department blocks
    formatted_blocks <- summary_data_IA %>%
      mutate(
        block = pmap_chr(
          list(
            `Department name`,
            Prop_Recommended, `Received recommended IV antibiotics`,
            Prop_Partial, `Partially received recommended IV antibiotics`,
            Prop_Not_Recommended, `Received IV antibiotics not among recommended options`,
            Total
          ),
          function(dept, prop_rec, n_rec, prop_part, n_part, prop_not, n_not, total_n) {
            color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
            bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

            glue::glue(
              "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

              <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

              <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
                <li>‚úÖ <strong>Received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_rec, accuracy = 0.1)}</strong> 
                  ({n_rec} out of {total_n})
                </li>
                <li>‚ö†Ô∏è <strong>Partially received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_part, accuracy = 0.1)}</strong> 
                  ({n_part} out of {total_n})
                </li>
                <li>‚ùå <strong>Received IV antibiotics not among recommended options</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_not, accuracy = 0.1)}</strong> 
                  ({n_not} out of {total_n})
                </li>
              </ul>
              </div>"
            )
          }
        )
      ) %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order) %>%
      pull(block)

    # Combine HTML
    final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks, collapse = "\n")))
    htmltools::browsable(final_summary_html)
  }
}


```

***


<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The partially recommended category</strong> refers to cases where patients received only part of the recommended antibiotic regimen. This includes cases where only part of the recommended antibiotic regimen was given, or where recommended antibiotics were combined with others outside the intended combination.</div>

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice & Dosage Appropriateness for IAIs
</h2>

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Data preparation: antibiotic choice & dosage appropriateness

#   Filter IA Patients and Add AWaRe Eligibility 
data_IA2 <- data_patients %>%
  filter(`Diagnosis code` == "IA") %>%
  mutate(
    Route = toupper(Route),
    ATC5 = trimws(toupper(ATC5)),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx, TRUE, FALSE
    )
  )

#   Lookup Drug & Dose Info for H_IAI_APPROP_DOSAGE 
lookup2 <- data_lookup %>% filter(Code == "H_IAI_APPROP_DOSAGE")
lookup_names2 <- unlist(lookup2[1, c("ABX-ATC-1", "ABX-ATC-2", "ABX-ATC-3", "ABX-ATC-4", "ABX-ATC-5", "ABX-ATC-6", "ABX-ATC-7")], use.names = FALSE)
lookup_names2 <- toupper(trimws(lookup_names2))

#   Compute Total Daily Dose for each row in data_IA2 
data_IA2 <- data_IA2 %>%
  mutate(
    Unit_Factor = case_when(
      Unit == "mg" ~ 1,
      Unit == "g"  ~ 1000,
      TRUE         ~ NA_real_
    ),
    Total_Daily_Dose = as.numeric(`Single Unit Dose`) * as.numeric(`N Doses/day`) * Unit_Factor
  )

#   Match Drug + Dose + Route 
for (i in 1:7) {
  name_col <- paste0("ABX-ATC-", i)
  dose_col <- paste0("ABX-DOSE-", i)
  freq_col <- paste0("ABX-DAY-DOSE-", i)
  unit_col <- paste0("ABX-UNIT-", i)
  route_col <- paste0("ABX-ROUTE-", i)

  dose_match_col <- paste0("Match_Drug_Dose_", i)

  # Standardise lookup info
  expected_dose <- as.numeric(lookup2[[dose_col]]) * as.numeric(lookup2[[freq_col]])
  dose_unit_factor <- case_when(
    lookup2[[unit_col]] == "mg" ~ 1,
    lookup2[[unit_col]] == "g"  ~ 1000,
    TRUE                       ~ NA_real_
  )
  total_expected_dose <- expected_dose * dose_unit_factor
  route_lookup <- toupper(trimws(lookup2[[route_col]]))
  drug_lookup <- toupper(trimws(lookup2[[name_col]]))

  # Create matching column
  data_IA2[[dose_match_col]] <- ifelse(
    data_IA2$ATC5 == drug_lookup &
      abs(data_IA2$Total_Daily_Dose - total_expected_dose) < 1 &
       data_IA2$Route == "P",
    TRUE, FALSE
  )
}   

# Summarise at Patient Level
patient_summary2 <- data_IA2 %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    Match_1_P = any(ATC5 == lookup_names2[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names2[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names2[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names2[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names2[5] & Route == "P"),
    Match_6_P = any(ATC5 == lookup_names2[6] & Route == "P"),
    Match_7_P = any(ATC5 == lookup_names2[7] & Route == "P"),

    Dose_1 = any(Match_Drug_Dose_1),
    Dose_2 = any(Match_Drug_Dose_2),
    Dose_3 = any(Match_Drug_Dose_3),
    Dose_4 = any(Match_Drug_Dose_4),
    Dose_5 = any(Match_Drug_Dose_5),
    Dose_6 = any(Match_Drug_Dose_6),
    Dose_7 = any(Match_Drug_Dose_7),

    Any_IV = any(Route == "P"),
    .groups = "drop"
  ) %>%
  mutate(
    # Define presence of any recommended IV antibiotic
    Any_Recommended_IV_Given = Match_1_P | Match_2_P | Match_3_P |
                                Match_4_P | Match_6_P | Match_7_P,

    # Define if any recommended dosage among recommended ones
    Any_Recommended_Dose_Correct = (Match_1_P & Dose_1) |
                                   (Match_2_P & Dose_2) |
                                   (Match_3_P & Dose_3) |
                                   (Match_4_P & Dose_4) |
                                   (Match_6_P & Dose_6) |
                                   (Match_7_P & Dose_7),

    # Define if all recommended IV antibiotics given had recommended doses
    All_Matched_And_Dosed = (
      (Match_1_P & Dose_1) |
      ((Match_2_P & Dose_2) & (Match_4_P & Dose_4)) |
      ((Match_3_P & Dose_3) & (Match_4_P & Dose_4)) |
      (Match_6_P & Dose_6) |
      (Match_7_P & Dose_7)
    ),

    Dose_Result = case_when(
      # Fully recommended recommended IVs and all at recommended dosage
      All_Matched_And_Dosed ~ "Received recommended IV antibiotics with recommended dosage",

      # At least one recommended IV with recommended dosage
      Any_Recommended_IV_Given & Any_Recommended_Dose_Correct & !All_Matched_And_Dosed ~
        "Received at least one recommended IV antibiotic with only one has recommended dosage",

      # Received recommended IV(s) but none were at recommended dose
      Any_Recommended_IV_Given & !Any_Recommended_Dose_Correct ~
        "Received at least one recommended IV antibiotic with none have recommended dosage",

      # Received IV but none were from recommended list
      Any_IV & !Any_Recommended_IV_Given ~
        "Received IV antibiotics not among recommended options",

      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Dose_Result))

# Create Summary Table by Department (with 0s for missing combos)
all_categories <- unique(patient_summary2$Dose_Result)

iv_dose_counts <- patient_summary2 %>%
  group_by(`Department name`, Dose_Result) %>%
  summarise(Patients = n(), .groups = "drop")

all_combos2 <- expand_grid(
  `Department name` = unique(patient_summary2$`Department name`),
  Dose_Result = all_categories
)

iv_dose_summary <- all_combos2 %>%
  left_join(iv_dose_counts, by = c("Department name", "Dose_Result")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Add Hospital-Wide Summary Row
hospital_row <- iv_dose_summary %>%
  group_by(Dose_Result) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Combine and Sort Final Output
final_summary2 <- bind_rows(iv_dose_summary, hospital_row) %>%
  arrange(`Department name`, Dose_Result)


```



This visual summarises the proportion of antibiotic choice & dosage appropriateness for IAIs across hospital departments based on the WHO AWaRe Book.


 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Define all Dose_Result categories (for legend and completeness)
all_categories2 <- c(
  "Received recommended IV antibiotics with recommended dosage",
  "Received at least one recommended IV antibiotic with only one has recommended dosage",
  "Received at least one recommended IV antibiotic with none have recommended dosage",
  "Received IV antibiotics not among recommended options"
)


# Set Dose_Result as an ordered factor
final_summary2$Dose_Result <- factor(final_summary2$Dose_Result, levels = all_categories2)

# Fill in all missing Department √ó Category combos (0 patients)
complete_summary <- expand_grid(
  `Department name` = unique(final_summary2$`Department name`),
  Dose_Result = all_categories2
) %>%
  left_join(final_summary2, by = c("Department name", "Dose_Result")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1)),
    Dose_Result = factor(Dose_Result, levels = all_categories2)  # reset levels again
  )


# Format Department labels
complete_summary <- complete_summary %>%
  mutate(
    PlotLabel = ifelse(`Department name` == "Hospital-Wide",
                       "<b style='color:#0072B2;'>Hospital-Wide</b>",
                       `Department name`),
    PlotLabel = factor(PlotLabel, levels = c("<b style='color:#0072B2;'>Hospital-Wide</b>",
                                             sort(setdiff(unique(`Department name`), "Hospital-Wide"))))
  )

# Plot
ggplot(complete_summary, aes(x = PlotLabel, y = Proportion, fill = Dose_Result)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1, fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  geom_text(aes(label = ifelse(Proportion > 5, paste0(Proportion, "%"), "")),
            position = position_fill(vjust = 0.5),
            size = 3, color = "black") +
  geom_text(
    data = complete_summary %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0
  ) +
scale_fill_manual(
  values = c(
    "Received recommended IV antibiotics with recommended dosage" = "#084594",
    "Received at least one recommended IV antibiotic with only one has recommended dosage" = "#6BAED6",
    "Received at least one recommended IV antibiotic with none have recommended dosage" = "#FC9272",
    "Received IV antibiotics not among recommended options" = "#D3D3D3"
  ),
  drop = FALSE
) +
  coord_flip(ylim = c(0, 1.05)) +
  labs(
    title = "Antibiotic Choice and Dosage Appropriateness for IAIs Cases",
    subtitle = "Categories reflect combined appropriateness of antibiotic choice and dosage (n = raw patient counts)",
    x = "Department",
    y = "Proportional Stacked Bars",
    fill = "Treatment Classification"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 8),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(margin = margin(r = 2)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 80, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 4, byrow = F, title.position = "top")
  )

```


<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Notes:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
    <li><strong>Received recommended IV antibiotics with recommended dosage</strong> indicates that the full recommended treatment regimen (whether monotherapy or dual therapy) was given, with all dosages aligned with WHO AWaRe Book guidance.</li>  <br>
    <li><strong>Received at least one recommended IV antibiotic with one has recommended dosage</strong> refers to cases where only part of the recommended dual therapy was given, and only one antibiotic was at the recommended dosage. </li> <br>
    <li><strong>Received at least one recommended IV antibiotic with none have recommended dosage</strong> includes cases who received either the full recommended regimen with no recommended dosages, or only part of it (e.g., one agent from a dual therapy) with none of the dosages aligned with WHO AWaRe Book guidance. </li> 
  </ul>
</div>

***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice & Dosage Appropriateness for IAIs
</h2>
This section evaluates the **appropriateness of IV antibiotic drug dosage** for patients with IAIs, in line with the WHO AWaRe Book guidance.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}
# Exclude Hospital-Wide and non-recommended options
final_summary2_IA_filtered <- final_summary2 %>%
  filter(`Department name` != "Hospital-Wide",
         Dose_Result != "Received IV antibiotics not among recommended options")

# Calculate total eligible IAI patients
total_approp_iv_given <- final_summary2_IA_filtered %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Handle case with no eligible patients
if (total_approp_iv_given == 0 || is.na(total_approp_iv_given)) {
  final_summary_html2 <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating the <strong>appropriateness of IV antibiotic dosage</strong> for IAI.<br><br>
    <em>This may indicate that no patients met the inclusion criteria, or that no patients received recommended IV antibiotics during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html2)

} else {

  # Intro text card
  intro_text2 <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible IAI patients who received recommended (<em>or partially recommended</em>) IV antibiotic choice based on WHO AWaRe Book (<strong>{total_approp_iv_given}</strong> out of {total_eligible})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Relevant categories to include
  all_categories2 <- c(
    "Received recommended IV antibiotics with recommended dosage",
    "Received at least one recommended IV antibiotic with only one has recommended dosage",
    "Received at least one recommended IV antibiotic with none have recommended dosage"
  )

  # Get all combinations
  dept_list <- unique(final_summary2$`Department name`)
  complete_summary <- expand_grid(
    `Department name` = dept_list,
    Dose_Result = all_categories2
  ) %>%
    left_join(final_summary2, by = c("Department name", "Dose_Result")) %>%
    filter(Dose_Result %in% all_categories2) %>%
    mutate(
      Patients = replace_na(Patients, 0),
      Total = ave(Patients, `Department name`, FUN = sum),
      Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1))
    )

  # Icon function
  get_icon <- function(label) {
    label_lower <- tolower(trimws(label))
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("<span style='color:#28a745;'>‚úÖ</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("<span style='color:#e6b800;'>‚ö†Ô∏è</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with none have recommended dosage") {
      return("<span style='color:#d00;'>‚ùå</span>")
    } else {
      return("üõà")
    }
  }

  # Description function
  get_description <- function(label) {
    label_lower <- tolower(label)
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("Received recommended IV antibiotics with recommended dosage")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("Received at least one recommended IV antibiotic with only one has recommended dosage")
    } else if (label_lower == "received at least one recommended iv antibiotic with none have recommended dosage") {
      return("Received at least one recommended IV antibiotic with none have recommended dosage")
    } else {
      return(paste("Received:", label))
    }
  }

  # Generate HTML summary blocks
  formatted_blocks2 <- complete_summary %>%
    group_by(`Department name`) %>%
    summarise(
      block = {
        dept <- first(`Department name`)
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"
        total_patients <- max(Total, na.rm = TRUE)

        list_items <- purrr::map_chr(all_categories2, function(label) {
          row_data <- complete_summary %>%
            filter(`Department name` == dept, Dose_Result == label)
          count <- row_data$Patients
          prop <- row_data$Proportion
          icon <- get_icon(label)
          description <- get_description(label)

          glue::glue(
            "<li>{icon} <strong>{description}</strong> (as per WHO AWaRe Book): 
            <strong>{scales::percent(prop / 100, accuracy = 0.1)}</strong> 
            ({count} out of {total_patients})</li>"
          )
        })

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_patients} patients)</span><br><br>
          <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
          {paste(list_items, collapse = '')}
          </ul>
          </div>"
        )
      },
      .groups = "drop"
    ) %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Final render
  final_summary_html2 <- HTML(paste0(intro_text2, paste(formatted_blocks2$block, collapse = "\n")))
  htmltools::browsable(final_summary_html2)
}



```

