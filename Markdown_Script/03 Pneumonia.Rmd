---
title: "[3] Community-acquired Pneumonia (CAP): WHO AWaRe QIs analysis against gPPS data"
author: "CNPI AMR"
date: "Last compiled on `r format(Sys.time(), '%A %d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    df_print: paged
    highlight: tango
    fig_width: 10
    fig_height: 6
    fig_caption: true
    code_folding: hide
editor_options:
  markdown:
    wrap: 72
---


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
  üìä Report Overview
</h1>
<p style="font-size: 1.15em; color: #444; margin-top: -0.4em; margin-bottom: 1em;">
This report presents a summary of the AWaRe-based quality indicator analysis based on gPPS inpatient data for Community-Acquired Pneumonia (CAP)

</p>

This analytical script implements **WHO AWaRe (Access, Watch, Reserve)** antibiotic use **quality indicators (QIs)** for treating **community-acquired pneumonia (CAP)** in adult inpatients with **community-acquired infections (CAIs)**. It utilises standardised data from the Global PPS (gPPS), specifically extracted from Excel-based outputs received by participating hospitals.

<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
<strong>Community-Acquired Pneumonia</strong> (Based on WHO AWaRe Book)<br>
‚ñ∏ <strong>gPPS diagnostic code:</strong> <code>Pneu</code><br>
‚ñ∏ <strong>gPPS definition:</strong> Includes pneumonia and other lower respiratory tract infections (LRTIs)
</div>

The aim is to assess the use of **empirical antibiotic** for respiratory infections, benchmarked against WHO AWaRe guidance, and to provide structured feedback at both the hospital and ward levels. These insights support **antimicrobial stewardship efforts** by highlighting patterns of suboptimal prescribing and identifying opportunities for targeted quality improvement.

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üéØ WHO AWaRe QIs for CAP
</h2>

Within the scope of the gPPS data structure, **TWO** QIs has been identified as compatible for evaluating empirical prescribing for pneumonia in adult CAI cases:

**Case Definition:**
<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_RESP_WATCH_ABX</strong>: Proportion of patients presenting with bacterial CAP given <strong>IV/oral Watch antibiotics</strong>.

2. <strong>H_RESP_APPROP_ABX</strong>: Proportion of patients presenting with any CAP given the appropriate IV antibiotics according to the WHO AWaRe Antibiotic</strong>.

</div>

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üí¨ General Notes:
</h2>

- Analysis includes only **adult patients (‚â•18 years)** with **CAIs** on **empirical** treatment.

- **IV and oral antibiotic administration** are included. IV was inferred using gPPS `"Route"` code <code>P</code> (Parenteral).
- It was assumed that WHO recommendations for CAP align with the gPPS diagnostic code <code>Pneu</code>
- **QIs** were mapped and interpreted based on clinical assumptions aligning the WHO AWaRe Book with available gPPS codes.

---

<div style="background-color: #fff4e5; border-left: 6px solid #ffc107; padding: 12px; margin-top: 10px;"> üí° <strong>Reminder:</strong> Caution is advised when interpreting results from small sample sizes (<10 patients) </div> 


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üîç Initial Eligible Cases Check
</h1>

This section assesses whether there are enough eligible cases to support meaningful analysis.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
#  Environment & Data Setup 
rm(list = ls())

# Define required packages
packages <- c(
  "dplyr", 
  "tidyverse", 
  "readxl", 
  "glue",
  "purrr",
  "tidyr",
  "htmltools", 
  "ggtext", 
  "forcats",
  "scales",
  "kableExtra"
)

# Install missing packages
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) install.packages(new_packages)

# Load all packages
invisible(lapply(packages, library, character.only = TRUE))

# Read data
data_info <- read_excel(
  "HA-Global-PPS_example_dummy data.xlsx",
  sheet = "Survey",
  col_types = c("guess", "date", "guess", "date")  # to read dates 
)
data_deps <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Department forms")
data_patients_all <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Patient forms")
data_lookup <- read_excel("QIs-Lookup.xlsx")

# Clean and select patient data
data_patients <- data_patients_all %>%
  select("Survey Number", "Department name", "Age years", "Weight", "ATC5", "Single Unit Dose", "Unit", "N Doses/day", "Route", "AWaRe", "Diagnosis code", "Indication", "Treatment")


data_patients[data_patients == ""] <- NA

data_patients <- data_patients %>%
  mutate(
    AWaRe = ifelse(
      toupper(AWaRe) == "NOT_RECOMMENDED",
      "NOT RECOMMENDED",
      AWaRe
    )
  )

AWaRe_abx <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")

#  Filter Eligible Pneumonia Cases 


data_pneu <- data_patients %>%
  filter(`Diagnosis code` == "Pneu") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

eligible_pneu_n <- data_pneu %>%
  filter(AWaRe_compatible) %>%
  distinct(`Survey Number`) %>%
  nrow()
# Format survey dates (assuming they are stored similarly)
survey_start <- format(data_info[[2]][3], "%d %b %Y")
survey_end <- format(data_info[[4]][3], "%d %b %Y")

# Feedback Summary (HTML) for CAP
html_feedback <- HTML(glue(
"<div style='background-color: #f0f8ff; border: 1px solid #add8e6; padding: 15px; border-radius: 5px; font-family: sans-serif;'>

  <p style='margin-bottom: 10px;'>
    <strong>üìÖ Survey period:</strong> {survey_start} to {survey_end}
  </p>

  <p>
    This script applies <strong>WHO AWaRe Quality Indicators</strong> to adult inpatients who received empirical antibiotics for community-acquired pneumonia (CAP).
  </p>

  <ul>
    <li><strong>Diagnostic code:</strong> Pneu</li>
    <li><strong>Total eligible cases:</strong> {eligible_pneu_n}</li>
  </ul>

  {if(eligible_pneu_n == 0){
    '<div style=\"background-color:#fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>üö´ No eligible cases found:</strong> There were no eligible cases for evaluation during this survey period. Please verify data availability.
    </div>'
  } else if(eligible_pneu_n < 10){
    '<div style=\"background-color:#ffe0e0; border: 1px solid #ffb3b3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚ö†Ô∏è Caution:</strong> Few eligible cases detected. Interpret results with caution.
    </div>'
  } else {
    '<div style=\"background-color:#e0ffe0; border: 1px solid #b3ffb3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚úÖ Good to go!</strong> Sufficient eligible cases available to proceed with full evaluation.
    </div>'
  }}

</div>"
))

# Render feedback
htmltools::browsable(html_feedback)


```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üßæ Summary of CAP Eligible Patients for QI Assessment
</h1>

Eligible patients for **WHO AWaRe QI** assessment are defined as **adult inpatients (‚â•18 years)** who received **empirical antibiotics** for **CAP**.

This section presents both **prescription-level** and **patient-level** summaries to establish how much of the dataset is relevant for QI evaluation. It helps frame the proportion of all prescriptions that are relevant to CAP.


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üë• Patient-Level Summary
</h2>

This table reports on unique patients in each eligibility group. It reflects the clinical burden of CAP and the proportion of patients suitable for QI evaluation.

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of patients on antibiotics: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong><br>
Total number of eligible patients on antibiotics: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "Pneu") %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total patients on antibiotics
total_patients <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Patient-level summary
patient_summary <- data.frame(
  Category = c(
    "Number of adult patients (‚â•18 years) who received empirical antibiotic treatment for CAI",
    "Number of all patients with a diagnosis of pneumonia on any antibiotics",
    "**Number of eligible patients:** Adult patients (‚â•18 years) with a diagnosis of CAP who were treated empirically with antibiotics"
  ),
  Count = c(
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Diagnosis code` == "Pneu", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "Pneu", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_patients)
  )

# Render patient-level table
knitr::kable(
  patient_summary,
  col.names = c("Patient Category", "Number of Patients", "Proportion of All Patients"),
  format = "html",
  align = "lcr"
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")

```

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìë Prescription-Level Summary
</h2>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of antibiotic prescriptions: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% nrow()`</strong><br>
Total number of eligible antibiotic prescriptions: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "Pneu") %>% nrow()`</strong>

</div>



```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total prescriptions
total_prescriptions <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  nrow()

# Prescription-level summary
prescription_summary <- data.frame(
  Category = c(
    "Number of empirical antibiotic prescriptions administered to adult patients (‚â•18 years) for CAI",
    "Number of all antibiotic prescriptions for patients diagnosed with pneumonia",
    "**Number of eligible antibiotic prescriptions:** Antibiotics empirically prescribed for adult patients (‚â•18 years) with CAP"
  ),
  Count = c(
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Diagnosis code` == "Pneu", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "Pneu", AWaRe %in% AWaRe_abx) %>% nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_prescriptions)
  )

# Render prescription-level table
knitr::kable(
  prescription_summary,
  col.names = c("Prescription Category", "Number of Prescriptions", "Proportion of All Prescriptions"),
  format = "html",
  align = "lcr"
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")
```

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìò WHO AWaRe-QIs Overview
</h1>
This script evaludates **Two** indicators:

<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_RESP_WATCH_ABX</strong>: Proportion of patients presenting with bacterial CAP given
 *IV/oral Watch antibiotics*.
2. <strong>H_RESP_APPROP_ABX</strong>: Proportion of patients presenting with any CAP given the *appropriate IV antibiotics* according to the WHO AWaRe Antibiotic</strong>.
</div>


<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üîç WHO AWaRe Book Recommendation</strong><br><br>

  <strong>Mild to Moderate Cases:</strong><br>
  ‚Ä¢ First choice: Amoxicillin 1 g q8h (ORAL)<br>
  ‚Ä¢ First choice: Phenoxymethylpenicillin 500 mg q6h (ORAL)<br>
  ‚Ä¢ Second choice: Amoxicillin + Clavulanic acid 875/125 mg q8h (ORAL)<br>
  ‚Ä¢ Second choice: Doxycycline 100 mg q12h (ORAL)<br><br>

  <strong>Severe Cases:</strong><br>
  ‚Ä¢ First choice: Cefotaxime 2 g q8h (IV/IM)<br>
  ‚Ä¢ First choice: Ceftriaxone 2 g q24h (IV) or 1 g q24h (IM)<br>
  ‚Ä¢ Second choice: Amoxicillin + Clavulanic acid 1 g/200 mg q8h (IV); Higher dose option: 1 g/200 mg q6h (IV)<br>
     ‚Ä¢ Consider adding: Clarithromycin 500 mg q12h (ORAL or IV) if CURB-65 ‚â•2<br>

</div>

<div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin-top: 10px; margin-bottom: 18px;">
<strong>üìò WHO AWaRe Notes:</strong>
<ul>
  <li>For mild to moderate CAP, access group antibiotics are typically recommended and are generally administered orally. For severe cases, treatment typically involves IV antibiotics, and most recommendations fall under the Watch group.</li>
  <li>They may be considered only when clinical severity is high (e.g., CURB-65 score ‚â•2), or pathogen coverage necessitates escalation </li>
</ul>
</div>

***

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 1 - IV/Oral Watch Antibiotic Use
</h1>

This section evaluates one WHO AWaRe indicator:

> **H_RESP_WATCH_ABX:** Proportion of patients with bacterial CAP given *IV/oral Watch antibiotics*


***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of IV/Oral Antibiotic Use for CAP
</h2>

This section summarises use of IV/Oral antibiotics for patients with CAP across hospital departments
        
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Filter CAP patients & flag eligibility
data_pneu <- data_patients %>%
  filter(`Diagnosis code` == "Pneu") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Filter eligible patients only
data_pneu_eligible <- data_pneu %>%
  filter(AWaRe_compatible == TRUE)

# One row per patient per AWaRe + Route group (fixed)
summary_watch <- data_pneu_eligible %>%
  mutate(
    Route_Group = case_when(
      Route %in% c("P", "O") ~ "IV_ORAL",
      TRUE ~ "OTHER"
    ),
    WATCH_IV_ORAL = (AWaRe == "WATCH" & Route_Group == "IV_ORAL"),
    WATCH_OTHER   = (AWaRe == "WATCH" & Route_Group == "OTHER"),
    NON_WATCH     = (AWaRe != "WATCH")
  ) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    WATCH_IV_ORAL = any(WATCH_IV_ORAL),
    WATCH_OTHER   = any(WATCH_OTHER),
    NON_WATCH     = any(NON_WATCH),
    .groups = "drop"
  )




# Department-level summary
summary_watch_dept <- summary_watch %>%
  group_by(`Department name`) %>%
  summarise(
    Eligible = n(),
    WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
    WATCH_OTHER = sum(WATCH_OTHER),
    NON_WATCH = sum(NON_WATCH),
    Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
    Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
    Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1),
    .groups = "drop"
  )

# Add hospital-level summary
summary_watch_total <- summary_watch %>%
  summarise(
    `Department name` = "Hospital-Wide",
    Eligible = n(),
    WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
    WATCH_OTHER = sum(WATCH_OTHER),
    NON_WATCH = sum(NON_WATCH),
    Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
    Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
    Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1)
  )

# Combine summaries
summary_watch_final <- bind_rows(summary_watch_total, summary_watch_dept)

# Total patients
total_CAP <- data_pneu %>% distinct(`Survey Number`) %>% nrow()
eligible_CAP <- data_pneu_eligible %>% distinct(`Survey Number`) %>% nrow()

# Handle case: no eligible CAP patients
if (eligible_CAP == 0 || is.na(eligible_CAP)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating CAP antibiotic use.<br><br>
    <em>This may indicate no adult patients with empirical CAP treatment met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {

  # Intro block
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible CAP patients who received any antibiotics (<strong>{eligible_CAP}</strong> out of {total_CAP})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Build formatted summary blocks
  formatted_blocks <- summary_watch_final %>%
    mutate(block = pmap_chr(
      list(
        `Department name`,
        Prop_WATCH_IV_ORAL, WATCH_IV_ORAL,
        Prop_WATCH_OTHER, WATCH_OTHER,
        Prop_NON_WATCH, NON_WATCH,
        Eligible
      ),
      function(dept, ivoral_p, ivoral_n, other_p, other_n, nonwatch_p, nonwatch_n, total_n) {
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

          <ul style='margin-left: 1.2em; line-height: 1.8; padding-left: 0; list-style-type: none;'>
            <li>
              <span style='display: inline-block; background-color: #007bff; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>1</span>
              <strong>Received a WATCH antibiotic via IV or Oral route</strong>: <strong>{scales::percent(ivoral_p / 100, accuracy = 0.1)}</strong> ({ivoral_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #17a2b8; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>2</span>
              <strong>Received a WATCH antibiotic via other route</strong>: <strong>{scales::percent(other_p / 100, accuracy = 0.1)}</strong> ({other_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #ffc107; color: black; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>3</span>
              <strong>Received a NON-WATCH antibiotic</strong>: <strong>{scales::percent(nonwatch_p / 100, accuracy = 0.1)}</strong> ({nonwatch_n} out of {total_n})
            </li>
          </ul>

          </div>"
        )
      }
    ))

  # Reorder Hospital-Wide first
  formatted_blocks <- formatted_blocks %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Final output
  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks$block, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}


```


***

<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The proportions are based on the number of unique CAP patients per department for each specific combination of WHO AWaRe antibiotic category and route of administration. A patient contributes to the count for each distinct AWaRe category and route combination they received. Receiving the same combination multiple times does not increase the count for that combination for that patient.
  <br>
</div>


***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by AWaRe Classification
</h2>

This visual summarises the proportion of antibiotic prescription for CAP across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#  Summarise AWaRe category by department
aware_summary <- data_pneu_eligible %>%
  group_by(`Department name`, Survey_ID = `Survey Number`, AWaRe) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, AWaRe) %>%
  summarise(Patients = n(), .groups = "drop")

# Create hospital-level summary
hospital_row <- aware_summary %>%
  group_by(AWaRe) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital")

# Define AWaRe levels
aware_levels_stack <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")
aware_levels_legend <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")

# Ensure all AWaRe levels are represented per department (even if 0)
all_combos2 <- expand_grid(
  `Department name` = unique(c(aware_summary$`Department name`, "Hospital")),
  AWaRe = aware_levels_stack
)

aware_summary_all <- all_combos2 %>%
  left_join(bind_rows(aware_summary, hospital_row), by = c("Department name", "AWaRe")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()


aware_summary_all$AWaRe <- factor(aware_summary_all$AWaRe, levels = aware_levels_stack)

# Format Hospital-Wide label and PlotLabel for axis
aware_summary_all <- aware_summary_all %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

aware_summary_all$PlotLabel <- factor(
  aware_summary_all$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(aware_summary_all$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

# Plot
ggplot(aware_summary_all, aes(x = PlotLabel, y = Proportion, fill = AWaRe)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +

  geom_text(
    data = aware_summary_all %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.03, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0, size = 3.5, color = "gray30"
  ) +

  scale_fill_manual(
    breaks = aware_levels_legend,
    values = c(
      "ACCESS" = "#1b9e77",
      "WATCH" = "#ff7f00",
      "RESERVE" = "#e41a1c",
      "NOT RECOMMENDED" = "#8c510a",
      "UNCLASSIFIED" = "gray70"
    )
  ) +
  coord_flip(ylim = c(0, 1.08)) +
  labs(
    title = "Proportion of CAP Patients on Antibiotics by AWaRe",
    x = "Department",
    y = "Proportion of Patients",
    fill = "AWaRe Category"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 10),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 12),
    panel.border = element_rect(color = "gray70", fill = NA),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.margin = margin(10, 10, 10, 10)
  )



```



<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
     <li>This count in this visual represents the number of unique patients who were prescribed at least one antibiotic within a specific WHO AWaRe category (Access, Watch, or Reserve) during their encounter. A patient is counted once for each distinct AWaRe category they received an antibiotic from. </li>    
     <br>
    <li>The AWaRe classification divides antibiotics into three categories: Access, Watch, and Reserve. Access antibiotics are first-line treatments with a low risk of resistance, typically recommended for common infections. Watch antibiotics are associated with a higher risk of resistance and require careful monitoring. Reserve antibiotics are reserved for critical cases involving resistant infections, typically used only when other options are ineffective.</li> 
  </ul>
</div>

***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by Route of Administration
</h2>

This visual summarises the proportion of CAP Patients on Watch Antibiotics across hospital departments by Route of Administration


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Filter eligible CAP patients receiving WATCH antibiotics
watch_route_summary <- data_pneu_eligible %>%
  filter(AWaRe == "WATCH") %>%
  mutate(
    Route_Clean = case_when(
      Route %in% c("P", "O") ~ "IV/Oral",
      TRUE ~ "Others"
    )
  ) %>%
  group_by(`Department name`, `Survey Number`, Route_Clean) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, Route_Clean) %>%
  summarise(Patients = n_distinct(`Survey Number`), .groups = "drop") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  )


# Add hospital-level row
hospital_watch_summary <- watch_route_summary %>%
  group_by(Route_Clean) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(
    `Department name` = "Hospital-Wide",
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  select(names(watch_route_summary))  # Match column order

# Combine with main data
watch_route_final <- bind_rows(watch_route_summary, hospital_watch_summary)

# Ensure all department √ó route combinations are present
route_levels <- c("IV/Oral", "Others")
all_combos3 <- expand_grid(
  `Department name` = unique(watch_route_final$`Department name`),
  Route_Clean = route_levels
)

# Rebuild full dataset with 0s where missing
watch_route_final <- all_combos3 %>%
  left_join(watch_route_final, by = c("Department name", "Route_Clean")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total > 0, Patients / Total, 0)
  )


# Create PlotLabel with HTML styling
watch_route_final <- watch_route_final %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

# Reorder PlotLabel so Hospital-Wide appears first
watch_route_final$PlotLabel <- factor(
  watch_route_final$PlotLabel,
  levels = c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(watch_route_final$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  )
)


# Plot
ggplot(watch_route_final, aes(x = PlotLabel, y = Proportion, fill = Route_Clean)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.2, color = "black"
  ) +

  geom_text(
    data = watch_route_final %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0.5, size = 3.3, color = "gray30"
  ) +

  scale_fill_manual(
    values = c(
      "IV/Oral" = "#3B8EDE",
      "Others" = "#e41a1c"
    ),
    labels = c("IV/Oral" = "IV or Oral", "Others" = "Other Routes")
  ) +

  labs(
    title = "Route of Administration for WATCH Antibiotics (CAP Patients)",
    subtitle = "Among eligible patients only",
    x = "Department",
    y = "Proportion of Patients",
    fill = "Route"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_markdown(angle = 45, hjust = 1),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "gray70", fill = NA)
  )

```


<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> This visual shows the proportion of unique CAP patients in each department who received at least one antibiotic from the WHO <strong>Watch</strong> category, considering the route of administration. A patient is counted once for each distinct route through which they received a Watch antibiotic.
  <br>
</div>



***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 2 ‚Äì IV Antibiotic Choice & Dosage Appropriateness
</h1>

> <strong>H_RESP_APPROP_ABX:</strong> Proportion of patients presenting with any CAP given the appropriate IV antibiotics according to the WHO AWaRe Antibiotic Book.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Data preparation: antibiotic choice appropriateness

#  Prepare the data (Select CAP data only)
data_Pneu_choice <- data_patients %>%
  filter(`Diagnosis code` == "Pneu") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

#  Lookup ABX names for CAP QI
lookup_names <- data_lookup %>%
  filter(Code == "H_RESP_APPROP_ABX") %>%
  select(starts_with("ABX-ATC")) %>%
  unlist(use.names = FALSE)

#  Flag matched prescriptions
data_Pneu_choice <- data_Pneu_choice %>%
  mutate(
    Drug_Match = ATC5 %in% lookup_names
  )

#  Extract lookup info 
lookup_Pneu_choice <- data_lookup %>%
  filter(Code == "H_RESP_APPROP_ABX")

# Create long format from lookup
lookup_long <- tibble(
  Drug = unlist(lookup_Pneu_choice %>% select(starts_with("ABX-ATC")), use.names = FALSE),
  Choice = unlist(lookup_Pneu_choice %>% select(starts_with("ABX-CHOICE")), use.names = FALSE)
) %>%
  filter(!is.na(Drug)) %>%
  distinct()

# Merge choice info with patient-level data
data_Pneu_choice <- data_Pneu_choice %>%
  left_join(lookup_long, by = c("ATC5" = "Drug"))

# Patient Summary for CAP (Pneu)
patient_summary_Pneu <- data_Pneu_choice %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    Abx_names = list(unique(ATC5)),

    Match_1_P   = any(ATC5 == lookup_names[1] & Route == "P"),
    Match_2_P   = any(ATC5 == lookup_names[2] & Route == "P"),
    Match_3_P   = any(ATC5 == lookup_names[3] & Route == "P"),
    Match_3_O   = any(ATC5 == lookup_names[3] & Route == "O"),
    Match_4_P   = any(ATC5 == lookup_names[4] & Route == "P"),
    Match_5_O   = any(ATC5 == lookup_names[5] & Route == "O"),
    Match_6_O   = any(ATC5 == lookup_names[6] & Route == "O"),
    Match_7_O   = any(ATC5 == lookup_names[7] & Route == "O"),
    Match_8_O   = any(ATC5 == lookup_names[8] & Route == "O"),

    Any_Oral    = any(Route == "O"),
    Any_IV      = any(Route == "P"),
    N_ABX       = n_distinct(ATC5),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    Num_recommended_IV_given   = sum(c_across(c(Match_1_P, Match_2_P, Match_3_P, Match_4_P))),
    Num_recommended_ORAL_given = sum(c_across(c(Match_5_O, Match_6_O, Match_7_O, Match_8_O))),
    All_IV_names_flat = paste0(unlist(Abx_names), collapse = ","),

    # Full match for CAP (IV)
    Received_full_recommended_IV = (
      (
        (Match_1_P & Num_recommended_IV_given == 1 & N_ABX == 1) |
        (Match_2_P & Num_recommended_IV_given == 1 & N_ABX == 1) |
        (Match_4_P & Num_recommended_IV_given == 1 & N_ABX == 1)
      ) |
      (
        ((Match_1_P & Match_3_P) |
         (Match_2_P & Match_3_P) |
         (Match_4_P & Match_3_P)) &
         Num_recommended_IV_given == 2 & N_ABX == 2
      )|
      (
        ((Match_1_P & Match_3_O) |
         (Match_2_P & Match_3_O) |
         (Match_4_P & Match_3_O)) &
         Num_recommended_IV_given == 1 & N_ABX == 2
      )
    ),

  # No match - IV
    Received_no_recommended_IV = (Any_IV & Num_recommended_IV_given == 0),
  
 
   # Partial match - IV
    Received_partial_recommended_IV = Any_IV &
                                      Num_recommended_IV_given > 0 &
                                      !Received_full_recommended_IV,

    
    # Full match for CAP (ORAL)
    Received_full_recommended_ORAL = (
      (Match_5_O & Num_recommended_ORAL_given == 1 & N_ABX == 1) |
      (Match_6_O & Num_recommended_ORAL_given == 1 & N_ABX == 1) |
      (Match_7_O & Num_recommended_ORAL_given == 1 & N_ABX == 1) |
      (Match_8_O & Num_recommended_ORAL_given == 1 & N_ABX == 1)
    ),

    # No match - ORAL
    Received_no_recommended_ORAL = Any_Oral & Num_recommended_ORAL_given == 0 & !Received_full_recommended_IV,


    # Partial match - ORAL
    Received_partial_recommended_ORAL = Any_Oral &
                                        Num_recommended_ORAL_given > 0 &
                                        !Received_full_recommended_ORAL,
    
    # Received any IV that is not full/partial/no recommended
    Received_any_IV = Any_IV &
                        !Received_full_recommended_ORAL &
                        !Received_partial_recommended_ORAL &
                        !Received_no_recommended_ORAL,

    # Received any ORAL that is not full/partial/no recommended
    Received_any_ORAL = Any_Oral &
                      !Received_full_recommended_IV &
                      !Received_partial_recommended_IV &
                      !Received_no_recommended_IV,
    
    # Catch all - anything else that doesn't fit above (e.g., non-P/ORAL routes)
    Other_non_IV_or_oral = !Received_full_recommended_IV &
                            !Received_full_recommended_ORAL &
                            !Received_partial_recommended_IV &
                            !Received_partial_recommended_ORAL &
                            !Received_no_recommended_IV &
                            !Received_no_recommended_ORAL
  ) %>%
  ungroup()


#  Get not eligible patients with department info
not_eligible_patients_Pneu <- data_Pneu_choice %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(Ineligible = all(AWaRe_compatible == FALSE), .groups = "drop") %>%
  filter(Ineligible)

#  Create summary table with Department name
eligible_long_Pneu <- patient_summary_Pneu %>%
  select(`Survey Number`, `Department name`, Received_full_recommended_IV, Received_full_recommended_ORAL, Received_partial_recommended_IV, Received_partial_recommended_ORAL, Received_no_recommended_IV, Received_no_recommended_ORAL, Received_any_IV, Received_any_ORAL, Other_non_IV_or_oral) %>%
  pivot_longer(
    cols = -c(`Survey Number`, `Department name`),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(Value = as.logical(Value)) %>%
  filter(Value) %>%
  group_by(`Department name`, Indicator) %>%
  summarise(Patients = n(), .groups = "drop")

# Get all possible combinations of departments and indicators
all_combos <- expand_grid(
  `Department name` = unique(patient_summary_Pneu$`Department name`),
  Indicator = c("Received_full_recommended_IV", "Received_full_recommended_ORAL", "Received_partial_recommended_IV", "Received_partial_recommended_ORAL", "Received_no_recommended_IV",  "Received_any_IV", "Received_any_ORAL", "Received_no_recommended_ORAL", "Other_non_IV_or_oral", "Not_Eligible")
)

# Left join and replace NAs with 0
eligible_long_Pneu <- all_combos %>%
  left_join(eligible_long_Pneu, by = c("Department name", "Indicator")) %>%
  mutate(Patients = replace_na(Patients, 0))


# Add not eligible
ineligible_summary_Pneu <- not_eligible_patients_Pneu %>%
  count(`Department name`) %>%
  mutate(Indicator = "Not_Eligible") %>%
  rename(Patients = n)

# Combine
qi_long_Pneu <- bind_rows(eligible_long_Pneu, ineligible_summary_Pneu)

# Calculate total per department
dept_totals <- qi_long_Pneu %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

# Final summary table with proportions
qi_summary_Pneu <- qi_long_Pneu %>%
  left_join(dept_totals, by = "Department name") %>%
  mutate(
    Indicator = case_when(
      Indicator == "Received_full_recommended_IV" ~ "Received recommended IV antibiotics",
      Indicator == "Received_full_recommended_ORAL" ~ "Received recommended ORAL antibiotics",
      Indicator == "Received_partial_recommended_IV" ~ "Partially received recommended IV antibiotics",
      Indicator == "Received_partial_recommended_ORAL" ~ "Partially received recommended ORAL antibiotics",
      Indicator == "Received_no_recommended_IV" ~ "Received IV antibiotics not among recommended options",
      Indicator == "Received_no_recommended_ORAL" ~ "Received ORAL antibiotics not among recommended options",
      Indicator == "Received_any_IV" ~ "Received IV antibiotics only",
      Indicator == "Received_any_ORAL" ~ "Received ORAL antibiotics only",
      Indicator == "Other_non_IV_or_oral" ~ "Received other non-IV/oral antibiotics",
      Indicator == "Not_Eligible" ~ "Not eligible for AWaRe CAP QIs",
      TRUE ~ Indicator
    ),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  select(`Department name`, Indicator, Patients, Total, Proportion)

#  Add Hospital Total row 
hospital_data <- qi_summary_Pneu %>%
  group_by(Indicator) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  select(`Department name`, Indicator, Patients)

# Combine with original data
qi_summary_Pneu <- bind_rows(qi_summary_Pneu, hospital_data)

# Recalculate totals and proportions
qi_summary_Pneu <- qi_summary_Pneu %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()

# Format "Hospital" label to bold
qi_summary_Pneu <- qi_summary_Pneu %>%
  mutate(`Department name` = ifelse(`Department name` == "Hospital-Wide", "Hospital-Wide", `Department name`))

```


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness for CAP
</h2>


This section assesses whether adult inpatients with **CAP** were prescribed the appropriate empirical IV/ ORAL antibiotics based on the WHO AWaRe Antibiotic Book.


```{r echo=FALSE, warning=FALSE, message=FALSE}

# Label definitions
indicator_labels <- c(
  "Received_full_recommended_IV"     = "Received recommended IV antibiotics",
  "Received_full_recommended_ORAL"     = "Received recommended ORAL antibiotics",
  "Received_partial_recommended_IV"  = "Partially received recommended IV antibiotics",
  "Received_partial_recommended_IV"  = "Partially received recommended ORAL antibiotics",
  "Received_no_recommended_IV"       = "Received IV antibiotics not among recommended options",
  "Received_no_recommended_ORAL"       = "Received ORAL antibiotics not among recommended options",
  "Received_any_IV"                  = "Received IV antibiotics only",
  "Received_any_ORAL"                  = "Received ORAL antibiotics only",
  "Other_non_IV_or_oral"       = "Received other non-IV/oral antibiotics",
  "Not_Eligible"                     = "Not eligible for AWaRe CAP QIs"
)

# Color codes
drug_choice_colors <- c(
  "Received recommended IV antibiotics"      = "#1F77B4",
  "Received recommended ORAL antibiotics"      = "#1F77B4",
  "Partially received recommended IV antibiotics" = "#4FA9DC",
  "Partially received recommended ORAL antibiotics" = "#4FA9DC",
  "Received IV antibiotics not among recommended options"    = "#EF476F",
  "Received ORAL antibiotics not among recommended options"    = "#EF476F",
  "Received IV antibiotics only" = "#F9D99E",
  "Received ORAL antibiotics only" =  "#F9D99E",
  "Received other non-IV/oral antibiotics"        = "#D3D3D3",
  "Not eligible for AWaRe CAP QIs"             = "#A9A9A9"
)

# Prepare PlotLabel and reorder
qi_summary_Pneu <- qi_summary_Pneu %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(
      PlotLabel,
      levels = c("<b style='color:#0072B2;'>Hospital-Wide</b>",
                 sort(setdiff(unique(`Department name`), "Hospital-Wide-Wide")))
    ),
    Indicator = factor(
      Indicator,
      levels = c(
        "Received recommended IV antibiotics",
        "Received recommended ORAL antibiotics",
        "Partially received recommended IV antibiotics",
        "Partially received recommended ORAL antibiotics",
        "Received IV antibiotics not among recommended options",
        "Received ORAL antibiotics not among recommended options",
        "Received IV antibiotics only",
        "Received ORAL antibiotics only",
        "Received other non-IV/oral antibiotics",
        "Not eligible for AWaRe CAP QIs"
      )
    )
  )

# Define groups
iv_indicators <- c(
  "Received recommended IV antibiotics",
  "Partially received recommended IV antibiotics",
  "Received IV antibiotics not among recommended options",
  "Received ORAL antibiotics only"
)

oral_indicators <- c(
  "Received recommended ORAL antibiotics",
  "Partially received recommended ORAL antibiotics",
  "Received ORAL antibiotics not among recommended options",
  "Received IV antibiotics only"
)

shared_indicators <- c(
  "Received other non-IV/oral antibiotics",
  "Not eligible for AWaRe CAP QIs"
)

# Subset the data
# For IV plot
relevant_indicators_iv <- c(iv_indicators, shared_indicators)

qi_summary_Pneu_IV <- qi_summary_Pneu %>%
  filter(Indicator %in% relevant_indicators_iv) %>%
  group_by(PlotLabel) %>%
  mutate(Total = sum(Patients[Indicator %in% relevant_indicators_iv])) %>%
  ungroup() %>%
  filter(Total > 0)

# For ORAL plot
relevant_indicators_oral <- c(oral_indicators, shared_indicators)

qi_summary_Pneu_ORAL <- qi_summary_Pneu %>%
  filter(Indicator %in% relevant_indicators_oral) %>%
  group_by(PlotLabel) %>%
  mutate(Total = sum(Patients[Indicator %in% relevant_indicators_oral])) %>%
  ungroup() %>%
  filter(Total > 0)

# Plot template
plot_template <- function(data_input, plot_title) {
  ggplot(data_input, aes(x = PlotLabel, y = Proportion, fill = Indicator)) +
    annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
             fill = "gray95", alpha = 0.5) +
    geom_bar(stat = "identity", position = "fill", width = 0.85) +
    geom_text(
      aes(label = ifelse(Patients > 0, Patients, "")),
      position = position_fill(vjust = 0.5),
      size = 3, color = "black"
    ) +
    geom_text(
      data = data_input %>% distinct(PlotLabel, Total),
      aes(x = PlotLabel, y = 1.05, label = paste0("n=", Total)),
      inherit.aes = FALSE,
      size = 3, color = "gray30", hjust = 0.5
    ) +
    scale_fill_manual(
      values = drug_choice_colors,
      labels = indicator_labels
    ) +
    scale_y_continuous(limits = c(0, 1.09), expand = c(0, 0)) +
    labs(
      title = plot_title,
      subtitle = "Each bar shows treatment appropriateness distribution per WHO AWaRe Book (counts shown within segments)",
      x = "Department",
      y = "Proportion of Patients",
      fill = "Treatment Appropriateness Category"
    ) +
    theme_minimal(base_size = 9) +
    theme(
      axis.text.x = element_markdown(size = 8, angle = 45, hjust = 1),
      axis.text.y = element_text(size = 8),
      axis.title = element_text(face = "bold", size = 10),
      legend.position = "right",
      legend.title = element_text(face = "bold", size = 9),
      legend.text = element_text(size = 8, margin = margin(b = 4)),
      plot.title = element_text(face = "bold", hjust = 0.5, size = 11),
      plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
      panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
      plot.margin = margin(10, 10, 10, 10)
    ) +
    guides(fill = guide_legend(nrow = 7, title.position = "top"))
}


# Render plots
plot_template(qi_summary_Pneu_IV, "IV Antibiotic Appropriateness for CAP")
plot_template(qi_summary_Pneu_ORAL, "ORAL Antibiotic Appropriateness for CAP")

```




<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
     <li>Because gPPS data do not include clinical severity for CAP cases, we used the route of antibiotic administration as a proxy: the prescription of oral antibiotics was interpreted as treatment for mild or moderate CAP, while the prescription of IV antibiotics was taken to indicate severe CAP. This assumption aligns with WHO AWaRe Book recommendations, which advise oral antibiotics for mild/moderate cases and parenteral antibiotics for severe cases. </li>    
     <br>
    <li>Cases in which oral clarithromycin was added to a WHO AWaRe-recommended IV regimen (Cefotaxime, Ceftriaxone, or Amoxicillin‚ÄìClavulanic acid) were also classified as receiving <strong> recommended IV antibiotics</strong>, as clarithromycin is part of the recommended combination for severe CAP (IF CURB-65 ‚â•2) when the primary antibiotic is given intravenously.</li> 
  </ul>
</div>



---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by AWaRe Classification
</h2>

This visual summarises the proportion of IV/ORAL antibiotic choice appropriateness for CAP across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve). 
 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Classify antibiotics into AWaRe groups
data_Pneu_AWaRe <- data_Pneu_choice %>%
  mutate(
    AWaRe2 = case_when(
      ATC5 %in% c("J01CA04", "J01CE02", "J01CR02", "J01AA02") ~ "ACCESS", 
      ATC5 %in% c("J01DD01", "J01DD04", "J01FA09") ~ "WATCH", 
      TRUE ~ NA_character_
    )
  )

# Identify primary and secondary antibiotics
data_Pneu_AWaRe <- data_Pneu_AWaRe %>%
  filter(AWaRe_compatible, Route %in% c("P", "O"), !is.na(AWaRe2))


# Filter only valid cases
aware_expanded <- data_Pneu_AWaRe %>%
  select(`Survey Number`, `Department name`, AWaRe2) %>%
  distinct()

# Summarise by department and AWaRe2
AWaRe_long <- aware_expanded %>%
  group_by(`Department name`, AWaRe2) %>%
  summarise(Patients = n(), .groups = "drop")

# Add totals and proportions per department
AWaRe_dept_totals <- AWaRe_long %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

AWaRe_long <- AWaRe_long %>%
  left_join(AWaRe_dept_totals, by = "Department name") %>%
  mutate(Proportion = round(Patients / Total, 3))

# Add Hospital-Wide totals
AWaRe_hospital_data <- aware_expanded %>%
  group_by(AWaRe2) %>%
  summarise(Patients = n(), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide")

AWaRe_long <- bind_rows(AWaRe_long, AWaRe_hospital_data)

# Recalculate totals and proportions with Hospital-Wide
AWaRe_long <- AWaRe_long %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()



# --- Plotting ----


#  Ensure AWaRe2 factor has full levels
aware_levels_all <- c("ACCESS","WATCH")
aware_levels_stack <- c("WATCH", "ACCESS")

AWaRe_long <- AWaRe_long %>%
  mutate(AWaRe2 = factor(AWaRe2, levels = aware_levels_stack))

#  Add dummy rows for missing categories (for legend consistency)
missing_levels <- setdiff(aware_levels_all, unique(AWaRe_long$AWaRe2))
if (length(missing_levels) > 0) {
  dummy_rows <- expand.grid(
    `Department name` = unique(AWaRe_long$`Department name`)[1],
    AWaRe2 = missing_levels
  ) %>%
    mutate(Proportion = 0, Total = 0)
  
  AWaRe_long <- bind_rows(AWaRe_long, dummy_rows)
}

#  Format PlotLabel with markdown styling for Hospital-Wide
AWaRe_long <- AWaRe_long %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

AWaRe_long$PlotLabel <- factor(
  AWaRe_long$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(AWaRe_long$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

#  Create color palette
aware_colors <- c(
  "ACCESS"       = "#1b9e77",
  "WATCH"   = "#ff7f00"
)

#  Create plot
ggplot(AWaRe_long, aes(x = PlotLabel, y = Proportion, fill = AWaRe2)) +
  
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +
  
  geom_text(
    data = AWaRe_long %>%
      distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = ifelse(Total > 0, paste0("n=", Total), "")),
    inherit.aes = FALSE,
    size = 4, color = "gray30", hjust = 0
  ) +
  
  scale_fill_manual(
    breaks = aware_levels_all,
    values = aware_colors,
    drop = FALSE,
    name = "AWaRe Classification"
  ) +
  
  coord_flip() +
  expand_limits(y = 1.05) +
  
  labs(
    title = "Use of Recommended IV/ORAL Antibiotics by AWaRe Classification for CAP",
    subtitle = "Proportions by department (percentages shown inside bars)",
    x = "Department",
    y = "Proportion of Patients"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.border = element_rect(color = "gray70", fill = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(margin = margin(r = 4)),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  
  guides(
    fill = guide_legend(nrow = 1, byrow = T, title.position = "top")
  )

```



<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The AWaRe classification divides antibiotics into three categories: Access, Watch, and Reserve. Access antibiotics are first-line treatments with a low risk of resistance, typically recommended for common infections. Watch antibiotics are associated with a higher risk of resistance and require careful monitoring. Reserve antibiotics are reserved for critical cases involving resistant infections, typically used only when other options are ineffective </strong>.
  <br>
</div>

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by line of treatment
</h2>

This visual summarises the proportion of antibiotic choice appropriateness for CAP across hospital departments by line of treatment (First choice, Second choice)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Define the helper function to process and prepare data per route and antimicrobial filter
prepare_choice_summary <- function(data, route_filter, plot_title, drug_filter) {
  # Filter for relevant route and antimicrobial names
  choice_summary <- data %>%
    filter(
      AWaRe_compatible == TRUE,
      Route == route_filter,
      ATC5 %in% drug_filter,
      Choice != "Both",
      !is.na(Choice)
    ) %>%
    group_by(`Department name`, Choice) %>%
    summarise(Prescriptions = n(), .groups = "drop") %>%
    group_by(`Department name`) %>%
    mutate(
      Total = sum(Prescriptions),
      Proportion = Prescriptions / Total
    ) %>%
    ungroup()
  
  # Hospital-Wide totals
  hospital_summary <- choice_summary %>%
    group_by(Choice) %>%
    summarise(Prescriptions = sum(Prescriptions), .groups = "drop") %>%
    mutate(`Department name` = "Hospital-Wide") %>%
    group_by(`Department name`) %>%
    mutate(
      Total = sum(Prescriptions),
      Proportion = Prescriptions / Total
    ) %>%
    ungroup()
  
  # Combine department and hospital-level summaries
  choice_summary <- bind_rows(choice_summary, hospital_summary)
  
  # Ensure all departments √ó choices exist
  choice_levels <- c("First choice", "Second choice")
  dept_list <- unique(choice_summary$`Department name`)
  
  complete_data <- expand_grid(
    `Department name` = dept_list,
    Choice = choice_levels
  ) %>%
    left_join(choice_summary, by = c("Department name", "Choice")) %>%
    mutate(
      Prescriptions = replace_na(Prescriptions, 0),
      Total = ave(Prescriptions, `Department name`, FUN = sum),
      Proportion = ifelse(Total > 0, Prescriptions / Total, 0)
    )
  
  # Markdown highlight for Hospital-Wide
  complete_data <- complete_data %>%
    mutate(
      PlotLabel = ifelse(
        `Department name` == "Hospital-Wide",
        "<b style='color:#0072B2;'>Hospital-Wide</b>",
        `Department name`
      )
    )
  
  # Reorder Hospital-Wide to appear first
  complete_data$PlotLabel <- factor(
    complete_data$PlotLabel,
    levels = rev(c(
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      sort(setdiff(unique(complete_data$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
    ))
  )
  
  # stacking order
  complete_data$Choice <- factor(complete_data$Choice, levels = c("Second choice", "First choice"))
  
  # Return both data and title
  list(data = complete_data, title = plot_title)
}

# Define antimicrobial lists for filtering
oral_drugs <- c(
  "J01CA04",
  "J01CE02",
  "J01CR02",
  "J01AA02"
)

iv_drugs <- c(
  "J01DD01",
  "J01DD04",
  "J01CR02"
)

# Prepare IV and ORAL results with filters
iv_result <- prepare_choice_summary(
  data = data_Pneu_choice,
  route_filter = "P",
  plot_title = "Use of Recommended IV Antibiotics by Line of Treatment",
  drug_filter = iv_drugs
)

oral_result <- prepare_choice_summary(
  data = data_Pneu_choice,
  route_filter = "O",
  plot_title = "Use of Recommended Oral Antibiotics by Line of Treatment",
  drug_filter = oral_drugs
)

# Define plotting function
plot_choice_summary <- function(summary_data, plot_title, subtitle_text) {
  ggplot(summary_data, aes(x = PlotLabel, y = Proportion, fill = Choice)) +
    annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
             fill = "gray95", alpha = 0.5) +
    geom_bar(stat = "identity", position = "fill", width = 0.85) +
    geom_text(
      aes(label = ifelse(Proportion > 0.05, percent(Proportion, accuracy = 1), "")),
      position = position_fill(vjust = 0.5),
      size = 3.5, color = "black"
    ) +
    geom_text(
      data = summary_data %>% distinct(PlotLabel, Total),
      aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
      inherit.aes = FALSE,
      size = 3.3, color = "gray30", hjust = 0
    ) +
    scale_fill_manual(
      breaks = c("First choice", "Second choice"),
      values = c("First choice" = "#8E44AD", "Second choice" = "#00BCD4"),
      drop = FALSE,
      name = "Treatment Choice"
    ) +
    coord_flip(ylim = c(0, 1.06)) +
    labs(
      title = plot_title,
      subtitle = subtitle_text,
      x = "Department",
      y = "Proportion of Patients"
    ) +
    theme_minimal(base_size = 11) +
    theme(
      axis.text.y = element_markdown(size = 10),
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5, color = "gray30"),
      panel.border = element_rect(color = "gray70", fill = NA),
      legend.position = "bottom",
      legend.title = element_text(face = "bold"),
      legend.text = element_text(size = 9),
      plot.margin = margin(10, 10, 10, 10)
    ) +
    guides(
      fill = guide_legend(nrow = 1, byrow = TRUE, title.position = "top")
    )
}

# Render the plots
plot_choice_summary(
  iv_result$data,
  iv_result$title,
  "Proportion of CAP patients prescribed First vs Second choice empirical treatment (IV route)"
)

plot_choice_summary(
  oral_result$data,
  oral_result$title,
  "Proportion of CAP patients prescribed First vs Second choice empirical treatment (Oral route)"
)

```

<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> Patients who received IV/ORAL Clarithromycin alone were not included in this analysis, as it serves as adjunct therapy for CAP (IF CURB-65 ‚â•2) and does not independently define the treatment line for severe CAP according to the WHO AWaRe Book.</div>
  
---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice Appropriateness for CAP
</h2>

***

<h3> üìã IV Antibiotic Choice Appropriateness for CAP </h3>
This section summarises the proportion of IV antibiotic **choice appropriateness** for CAP across hospital departments based on the WHO AWaRe Book.
  
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}

# Total eligible CAP patients (excluding "Not eligible")
total_eligible_IV <- qi_summary_Pneu_IV %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator != "Not eligible for AWaRe CAP QIs") %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Total receiving any IV antibiotic in relevant categories
total_iv <- qi_summary_Pneu_IV %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  )) %>% 
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Extract relevant subset
relevant_data <- qi_summary_Pneu_IV %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  ))

# If no relevant data, return message
if (nrow(relevant_data) == 0 || total_iv == 0 || is.na(total_iv)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for CAP.<br><br>
    <em>This may indicate that no patients received IV antibiotics, no patients with CAP, or that none met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Summarise department-level proportions
  summary_data_Pneu_IV <- relevant_data %>%
    group_by(`Department name`, Indicator) %>%
    summarise(Patients = sum(Patients), .groups = "drop") %>%
    pivot_wider(
      names_from = Indicator,
      values_from = Patients,
      values_fill = 0
    ) %>%
    mutate(
      Total = `Received recommended IV antibiotics` +
              `Partially received recommended IV antibiotics` +
              `Received IV antibiotics not among recommended options`,
      Prop_Recommended   = `Received recommended IV antibiotics` / Total,
      Prop_Partial       = `Partially received recommended IV antibiotics` / Total,
      Prop_Not_Recommended = `Received IV antibiotics not among recommended options` / Total
    ) %>%
    filter(Total > 0)

  # If pivoted data is empty (e.g., all NA/missing), fallback again
  if (nrow(summary_data_Pneu_IV) == 0) {
    final_summary_html <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
      ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for CAP.<br><br>
  <em>This may indicate that no patients received IV antibiotics, no patients with CAP, or that none met the inclusion criteria during the reporting period.</em>
      </div>"
    ))
    htmltools::browsable(final_summary_html)

  } else {
    # Intro block
    intro_text <- glue::glue(
      "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
      üíä <strong>Denominator:</strong> Number of eligible CAP patients who received any IV antibiotic (<strong>{total_iv}</strong> out of <strong>{total_eligible_IV}</strong>)
      </div><br><br>
      <strong>Summary:</strong><br><br>"
    )

    # Format department blocks
    formatted_blocks <- summary_data_Pneu_IV %>%
      mutate(
        block = pmap_chr(
          list(
            `Department name`,
            Prop_Recommended, `Received recommended IV antibiotics`,
            Prop_Partial, `Partially received recommended IV antibiotics`,
            Prop_Not_Recommended, `Received IV antibiotics not among recommended options`,
            Total
          ),
          function(dept, prop_rec, n_rec, prop_part, n_part, prop_not, n_not, total_n) {
            color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
            bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

            glue::glue(
              "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

              <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

              <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
                <li>‚úÖ <strong>Received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_rec, accuracy = 0.1)}</strong> 
                  ({n_rec} out of {total_n})
                </li>
                <li>‚ö†Ô∏è <strong>Partially received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_part, accuracy = 0.1)}</strong> 
                  ({n_part} out of {total_n})
                </li>
                <li>‚ùå <strong>Received IV antibiotics not among recommended options</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_not, accuracy = 0.1)}</strong> 
                  ({n_not} out of {total_n})
                </li>
              </ul>
              </div>"
            )
          }
        )
      ) %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order) %>%
      pull(block)

    # Combine HTML
    final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks, collapse = "\n")))
    htmltools::browsable(final_summary_html)
  }
}

```
***

<h3> üìã ORAL Antibiotic Choice Appropriateness for CAP </h3>
This section summarises the proportion of ORAL antibiotic **choice appropriateness** for CAP across hospital departments based on the WHO AWaRe Book.
  
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}

# Total eligible CAP patients (excluding "Not eligible")
total_eligible_ORAL <- qi_summary_Pneu_ORAL %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator != "Not eligible for AWaRe CAP QIs") %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Total receiving any IV antibiotic in relevant categories
total_iv <- qi_summary_Pneu_ORAL %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator %in% c(
    "Received recommended ORAL antibiotics",
    "Partially received recommended ORAL antibiotics",
    "Received ORAL antibiotics not among recommended options"
  )) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Extract relevant subset
relevant_data <- qi_summary_Pneu_ORAL %>%
  filter(Indicator %in% c(
    "Received recommended ORAL antibiotics",
    "Partially received recommended ORAL antibiotics",
    "Received ORAL antibiotics not among recommended options"
  ))

# If no relevant data, return message
if (nrow(relevant_data) == 0 || total_iv == 0 || is.na(total_iv)) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing ORAL antibiotic choice appropriateness for CAP.<br><br>
    <em>This may indicate that no patients received ORAL antibiotics, no patients with CAP, or that none met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Summarise department-level proportions
  summary_data_Pneu_ORAL <- relevant_data %>%
    group_by(`Department name`, Indicator) %>%
    summarise(Patients = sum(Patients), .groups = "drop") %>%
    pivot_wider(
      names_from = Indicator,
      values_from = Patients,
      values_fill = 0
    ) %>%
    mutate(
      Total = `Received recommended ORAL antibiotics` +
              `Partially received recommended ORAL antibiotics` +
              `Received ORAL antibiotics not among recommended options`,
      Prop_Recommended   = `Received recommended ORAL antibiotics` / Total,
      Prop_Partial       = `Partially received recommended ORAL antibiotics` / Total,
      Prop_Not_Recommended = `Received ORAL antibiotics not among recommended options` / Total
    ) %>%
    filter(Total > 0)

  # If pivoted data is empty (e.g., all NA/missing), fallback again
  if (nrow(summary_data_Pneu_ORAL) == 0) {
    final_summary_html <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
      ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing ORAL antibiotic choice appropriateness for CAP.<br><br>
  <em>This may indicate that no patients received ORAL antibiotics, no patients with CAP, or that none met the inclusion criteria during the reporting period.</em>
      </div>"
    ))
    htmltools::browsable(final_summary_html)

  } else {
    # Intro block
    intro_text <- glue::glue(
      "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
      üíä <strong>Denominator:</strong> Number of eligible CAP patients who received any ORAL antibiotic (<strong>{total_iv}</strong> out of <strong>{total_eligible_ORAL}</strong>)
      </div><br><br>
      <strong>Summary:</strong><br><br>"
    )

    # Format department blocks
    formatted_blocks <- summary_data_Pneu_ORAL %>%
      mutate(
        block = pmap_chr(
          list(
            `Department name`,
            Prop_Recommended, `Received recommended ORAL antibiotics`,
            Prop_Partial, `Partially received recommended ORAL antibiotics`,
            Prop_Not_Recommended, `Received ORAL antibiotics not among recommended options`,
            Total
          ),
          function(dept, prop_rec, n_rec, prop_part, n_part, prop_not, n_not, total_n) {
            color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
            bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

            glue::glue(
              "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

              <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

              <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
                <li>‚úÖ <strong>Received recommended ORAL antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_rec, accuracy = 0.1)}</strong> 
                  ({n_rec} out of {total_n})
                </li>
                <li>‚ö†Ô∏è <strong>Partially received recommended ORAL antibiotics</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_part, accuracy = 0.1)}</strong> 
                  ({n_part} out of {total_n})
                </li>
                <li>‚ùå <strong>Received ORAL antibiotics not among recommended options</strong> (as per WHO AWaRe Book): 
                  <strong>{scales::percent(prop_not, accuracy = 0.1)}</strong> 
                  ({n_not} out of {total_n})
                </li>
              </ul>
              </div>"
            )
          }
        )
      ) %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order) %>%
      pull(block)

    # Combine HTML
    final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks, collapse = "\n")))
    htmltools::browsable(final_summary_html)
  }
}

```

***


<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The partially recommended category</strong> refers to cases where patients received only part of the recommended antibiotic regimen. This includes cases where recommended antibiotics were combined with others outside the intended combination.</div>
  
  
  ---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice & Dosage Appropriateness for CAP
</h2>

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Data preparation: antibiotic choice & dosage appropriateness

#   Filter Pneu Patients and Add AWaRe Eligibility 
data_Pneu2 <- data_patients %>%
  filter(`Diagnosis code` == "Pneu") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx, TRUE, FALSE
    )
  )

#   Lookup Drug & Dose Info for H_RESP_APPROP_ABX 
lookup2 <- data_lookup %>% filter(Code == "H_RESP_APPROP_ABX")
lookup_names2 <- unlist(lookup2[1, c("ABX-ATC-1", "ABX-ATC-2", "ABX-ATC-3", "ABX-ATC-4", "ABX-ATC-5", "ABX-ATC-6", "ABX-ATC-7", "ABX-ATC-8")], use.names = FALSE)
lookup_names2 <- toupper(trimws(lookup_names2))


#  Compute Total Daily Dose with MU ‚Üí IU conversion 
data_Pneu2 <- data_Pneu2 %>%
  mutate(
    # Normalise unit label and apply appropriate factor
    Unit_Factor = case_when(
      Unit == "mg" ~ 1,
      Unit == "g" ~ 1000,
      Unit == "IU" ~ 1,
      Unit == "MU" ~ 1e6,  # Convert MU (Million Units) to IU factor
      TRUE ~ NA_real_
    ),

    # Final total dose: always multiply single dose √ó freq √ó factor (includes MU)
    Total_Daily_Dose = as.numeric(`Single Unit Dose`) * as.numeric(`N Doses/day`) * Unit_Factor
  )


#  Match Drug + Dose + Route (with special case for drug 4 & 6) 

convert_unit <- function(unit) {
  case_when(
    unit == "mg" ~ 1,
    unit == "g" ~ 1000,
    unit == "IU" ~ 1,
    unit == "MU" ~ 1e6,
    TRUE ~ NA_real_
  )
}

# Helper to get expected dose
get_expected_dose <- function(i) {
  dose <- as.numeric(lookup2[[paste0("ABX-DOSE-", i)]][1])
  freq <- as.numeric(lookup2[[paste0("ABX-DAY-DOSE-", i)]][1])
  unit <- lookup2[[paste0("ABX-UNIT-", i)]][1]
  dose * freq * convert_unit(unit)
}

# Extract basic info
drug_names <- sapply(1:8, function(i) toupper(trimws(lookup2[[paste0("ABX-ATC-", i)]][1])))
routes <- sapply(1:8, function(i) toupper(trimws(lookup2[[paste0("ABX-ROUTE-", i)]][1])))
expected_doses <- sapply(1:8, get_expected_dose)

# Special logic for Drug 4  (main + alt dose)
expected_4_main <- expected_doses[4]
expected_4_alt <- as.numeric(lookup2[["ABX-DOSE-4"]][1]) *
                  as.numeric(lookup2[["ABX-DAY-DOSE-4a"]][1]) *
                  convert_unit(lookup2[["ABX-UNIT-4"]][1])

# Special logic for Drug 6 (main + alt dose)
expected_6_main <- expected_doses[6]
expected_6_alt <- as.numeric(lookup2[["ABX-DOSE-6a"]][1]) *
                  as.numeric(lookup2[["ABX-DAY-DOSE-6"]][1]) *
                  convert_unit(lookup2[["ABX-UNIT-6a"]][1])

# Perform matching in one go
data_Pneu2 <- data_Pneu2 %>%
  mutate(
    Match_Drug_Dose_1 = ATC5 == drug_names[1] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[1]) < 1,

    Match_Drug_Dose_2 = ATC5 == drug_names[2] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[2]) < 1,

    Match_Drug_Dose_3 = ATC5 == drug_names[3] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[3]) < 1,

    Match_Drug_Dose_4 = ATC5 == drug_names[4] & Route == "P" &
                        (
                          abs(Total_Daily_Dose - expected_4_main) < 1 |
                          abs(Total_Daily_Dose - expected_4_alt) < 1
                        ),
    
    Match_Drug_Dose_5 = ATC5 == drug_names[5] & Route == "O" &
                        abs(Total_Daily_Dose - expected_doses[5]) < 1,
    
    
    Match_Drug_Dose_6 = ATC5 == drug_names[6] & Route == "O" &
                        (
                          abs(Total_Daily_Dose - expected_6_main) < 1 |
                          abs(Total_Daily_Dose - expected_6_alt) < 1
                        ),
    
    Match_Drug_Dose_7 = ATC5 == drug_names[7] & Route == "O" &
                        abs(Total_Daily_Dose - expected_doses[7]) < 1,    
    
    Match_Drug_Dose_8 = ATC5 == drug_names[8] & Route == "O" &
                        abs(Total_Daily_Dose - expected_doses[8]) < 1
  )



```



```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
## Data preparation: IV Antibiotic Choice & Dosage Appropriateness for CAP

# Summarise at Patient Level for IV
patient_summary2_IV <- data_Pneu2 %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    
    Match_1_P   = any(ATC5 == lookup_names2[1] & Route == "P"),
    Match_2_P   = any(ATC5 == lookup_names2[2] & Route == "P"),
    Match_3_P   = any(ATC5 == lookup_names2[3] & Route == "P"),
    Match_3_O   = any(ATC5 == lookup_names2[3] & Route == "O"),
    Match_4_P   = any(ATC5 == lookup_names2[4] & Route == "P"),

    Dose_1 = any(Match_Drug_Dose_1),
    Dose_2 = any(Match_Drug_Dose_2),
    Dose_3 = any(Match_Drug_Dose_3),
    Dose_4 = any(Match_Drug_Dose_4),

    Any_IV = any(Route == "P"),
    .groups = "drop"
  ) %>%
  mutate(
    # Define presence of any recommended IV antibiotic
    Any_Recommended_IV_Given = Match_1_P | Match_2_P | Match_3_P | Match_4_P,

    # Define if any recommended dosage among recommended IV ones
    Any_Recommended_Dose_Correct_IV = (Match_1_P & Dose_1) |
                                   (Match_2_P & Dose_2) |
                                   (Match_3_P & Dose_3) |
                                   (Match_4_P & Dose_4),
    
    # Define if all recommended IV antibiotics given had recommended doses
    All_Matched_And_Dosed_IV = (
      ((Match_1_P & Dose_1) & (!Match_3_P)) |
      ((Match_1_P & Dose_1) & ((Match_3_P | Match_3_O) & Dose_3)) |
      ((Match_2_P & Dose_2) & (!Match_3_P)) |
      ((Match_2_P & Dose_2) & ((Match_3_P | Match_3_O) & Dose_3)) |
      ((Match_4_P & Dose_4) & (!Match_3_P)) |
      ((Match_4_P & Dose_4) & ((Match_3_P | Match_3_O) & Dose_3))
    ),
    
    Dose_Result = case_when(
      # Fully recommended recommended IV and all at recommended dosage
      All_Matched_And_Dosed_IV ~ "Received recommended IV antibiotics with recommended dosage",
      
      # At least one recommended IV with recommended dosage
      Any_Recommended_IV_Given & Any_Recommended_Dose_Correct_IV & !All_Matched_And_Dosed_IV ~
        "Received at least one recommended IV antibiotic with only one has recommended dosage",

            # Received recommended IV but none were at recommended dose
      Any_Recommended_IV_Given & !Any_Recommended_Dose_Correct_IV ~
        "Received at least one recommended IV antibiotic with none have recommended dosage",

      # Received IV but none were from recommended list
      Any_IV & !Any_Recommended_IV_Given ~
        "Received IV antibiotics not among recommended options",

      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Dose_Result))

# Create Summary Table by Department (with 0s for missing combos)
all_categories_IV <- unique(patient_summary2_IV$Dose_Result)

iv_dose_counts <- patient_summary2_IV %>%
  group_by(`Department name`, Dose_Result) %>%
  summarise(Patients = n(), .groups = "drop")

all_combos2_IV <- expand_grid(
  `Department name` = unique(patient_summary2_IV$`Department name`),
  Dose_Result = all_categories_IV
)

iv_dose_summary <- all_combos2_IV %>%
  left_join(iv_dose_counts, by = c("Department name", "Dose_Result")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Add Hospital-Wide Summary Row
iv_hospital_row <- iv_dose_summary %>%
  group_by(Dose_Result) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Combine and Sort Final Output
final_summary2_IV <- bind_rows(iv_dose_summary, iv_hospital_row) %>%
  arrange(`Department name`, Dose_Result)
```


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
## Data preparation: ORAL Antibiotic Choice & Dosage Appropriateness for CAP

# Summarise at Patient Level for ORAL 
patient_summary2_Oral <- data_Pneu2 %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    Match_1_P = any(ATC5 == lookup_names2[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names2[2] & Route == "P"),
    Match_3_O = any(ATC5 == lookup_names2[3] & Route == "O"),
    Match_4_P = any(ATC5 == lookup_names2[4] & Route == "P"),
    Match_5_O = any(ATC5 == lookup_names2[5] & Route == "O"),
    Match_6_O = any(ATC5 == lookup_names2[6] & Route == "O"),
    Match_7_O = any(ATC5 == lookup_names2[7] & Route == "O"),
    Match_8_O = any(ATC5 == lookup_names2[8] & Route == "O"),

    Dose_3 = any(Match_Drug_Dose_3),
    Dose_5 = any(Match_Drug_Dose_5),
    Dose_6 = any(Match_Drug_Dose_6),
    Dose_7 = any(Match_Drug_Dose_7),
    Dose_8 = any(Match_Drug_Dose_8),

    Any_Oral = any(Route == "O"),
    N_ABX = n(),  # You need this if you're using it later in `mutate()`
    .groups = "drop"
  ) %>%
  mutate(
    Any_Recommended_ORAL_Given = Match_5_O | Match_6_O | Match_7_O | Match_8_O,

    Any_Recommended_Dose_Correct_ORAL = (Match_5_O & Dose_5) |
                                        (Match_6_O & Dose_6) |
                                        (Match_7_O & Dose_7) |
                                        (Match_8_O & Dose_8),

    All_Matched_And_Dosed_ORAL = (Match_5_O & Dose_5) |
                                 (Match_6_O & Dose_6) |
                                 (Match_7_O & Dose_7) |
                                 (Match_8_O & Dose_8),

    IV_ORAL_Combined = (
      ((Match_1_P & Match_3_O) |
       (Match_2_P & Match_3_O) |
       (Match_4_P & Match_3_O)) &
       N_ABX == 2
    ),

    Dose_Result = case_when(
      All_Matched_And_Dosed_ORAL ~ "Received recommended ORAL antibiotic with recommended dosage",
      Any_Recommended_ORAL_Given & !Any_Recommended_Dose_Correct_ORAL ~
        "Received recommended ORAL antibiotic without recommended dosage",
      Any_Oral & !Any_Recommended_ORAL_Given & !IV_ORAL_Combined ~
        "Received ORAL antibiotics not among recommended options",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Dose_Result))


# Create Summary Table by Department (with 0s for missing combos)
all_categories_Oral <- unique(patient_summary2_Oral$Dose_Result)

Oral_dose_counts <- patient_summary2_Oral %>%
  group_by(`Department name`, Dose_Result) %>%
  summarise(Patients = n(), .groups = "drop")

all_combos2_Oral <- expand_grid(
  `Department name` = unique(patient_summary2_Oral$`Department name`),
  Dose_Result = all_categories_Oral
)

Oral_dose_summary <- all_combos2_Oral %>%
  left_join(Oral_dose_counts, by = c("Department name", "Dose_Result")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Add Hospital-Wide Summary Row
Oral_hospital_row <- Oral_dose_summary %>%
  group_by(Dose_Result) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Combine and Sort Final Output
final_summary2_Oral <- bind_rows(Oral_dose_summary, Oral_hospital_row) %>%
  arrange(`Department name`, Dose_Result)
```


This visual summarises the proportion of IV/ ORAL antibiotic choice & dosage appropriateness for CAP across hospital departments based on the WHO AWaRe Book.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Function to process and plot by route
plot_dose_result_by_route <- function(data, route_categories, route_type_label, fill_colors) {
  # Filter only relevant categories
  summary_filtered <- data %>%
    filter(Dose_Result %in% route_categories)

  # Set as ordered factor
  summary_filtered$Dose_Result <- factor(summary_filtered$Dose_Result, levels = route_categories)

# Keep only departments with non-zero total patients
dept_with_data <- summary_filtered %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients, na.rm = TRUE), .groups = "drop") %>%
  filter(Total > 0) %>%
  pull(`Department name`)

# Fill missing dept-category combos
complete_summary <- expand_grid(
  `Department name` = dept_with_data,
  Dose_Result = route_categories
) %>%
  left_join(summary_filtered, by = c("Department name", "Dose_Result")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1)),
    Dose_Result = factor(Dose_Result, levels = route_categories)
  )
  # Format department labels
  complete_summary <- complete_summary %>%
    mutate(
      PlotLabel = ifelse(`Department name` == "Hospital-Wide",
                         "<b style='color:#0072B2;'>Hospital-Wide</b>",
                         `Department name`),
      PlotLabel = factor(PlotLabel, levels = c("<b style='color:#0072B2;'>Hospital-Wide</b>",
                                               sort(setdiff(unique(`Department name`), "Hospital-Wide"))))
    )

  # Plot
  ggplot(complete_summary, aes(x = PlotLabel, y = Proportion, fill = Dose_Result)) +
    annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1, fill = "gray95", alpha = 0.5) +
    geom_bar(stat = "identity", position = "fill", width = 0.85) +
    geom_text(aes(label = ifelse(Proportion > 5, paste0(Proportion, "%"), "")),
              position = position_fill(vjust = 0.5),
              size = 3, color = "black") +
    geom_text(
      data = complete_summary %>% distinct(PlotLabel, Total),
      aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
      inherit.aes = FALSE,
      size = 3, color = "gray30", hjust = 0
    ) +
    scale_fill_manual(
      values = fill_colors,
      drop = FALSE
    ) +
    coord_flip(ylim = c(0, 1.05)) +
    labs(
      title = paste("Antibiotic Choice and Dosage Appropriateness for", route_type_label, "Route"),
      subtitle = "Categories reflect combined appropriateness of antibiotic choice and dosage (n = raw patient counts)",
      x = "Department",
      y = "Proportional Stacked Bars",
      fill = "Treatment Classification"
    ) +
    theme_minimal(base_size = 10) +
    theme(
      axis.text.y = ggtext::element_markdown(size = 8),
      axis.title = element_text(face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(face = "bold"),
      legend.text = element_text(margin = margin(r = 2)),
      plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
      plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
      panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
      plot.margin = margin(10, 80, 10, 10)
    ) +
    guides(fill = guide_legend(nrow = 4, byrow = FALSE, title.position = "top"))
}


# ---- Define IV categories and colors ----
all_categories2_IV <- c(
  "Received recommended IV antibiotics with recommended dosage",
  "Received at least one recommended IV antibiotic with only one has recommended dosage",
  "Received at least one recommended IV antibiotic with none have recommended dosage",
  "Received IV antibiotics not among recommended options"
)

iv_colors <- c(
  "Received recommended IV antibiotics with recommended dosage" = "#084594",
  "Received at least one recommended IV antibiotic with only one has recommended dosage" = "#6BAED6",
  "Received at least one recommended IV antibiotic with none have recommended dosage" = "#FC9272",
  "Received IV antibiotics not among recommended options" = "#D3D3D3"
)

# üÜï Use the IV dataset
plot_dose_result_by_route(final_summary2_IV, all_categories2_IV, "IV", iv_colors)


# ---- Define ORAL categories and colors ----
all_categories2_ORAL <- c(
  "Received recommended ORAL antibiotic with recommended dosage",
  "Received recommended ORAL antibiotic without recommended dosage",
  "Received ORAL antibiotics not among recommended options"
)

oral_colors <- c(
  "Received recommended ORAL antibiotic with recommended dosage" = "#084594",
  "Received recommended ORAL antibiotic without recommended dosage" = "#FC9272",
  "Received ORAL antibiotics not among recommended options" = "#D3D3D3"
)

# üÜï Use the ORAL dataset
plot_dose_result_by_route(final_summary2_Oral, all_categories2_ORAL, "O", oral_colors)

```


<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Notes:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
    <li><strong>Received recommended IV antibiotics with recommended dosage</strong> indicates that the full recommended treatment regimen (whether monotherapy or dual therapy) was given, with all dosages aligned with WHO AWaRe Book guidance.</li>  <br>
    <li><strong>Received at least one recommended IV antibiotic with one has recommended dosage</strong> refers to cases where only part of the recommended dual therapy was given, and only one antibiotic was at the recommended dosage. </li> <br>
    <li><strong>Received at least one recommended IV antibiotic with none have recommended dosage</strong> includes cases who received either the full recommended regimen with no recommended dosages, or only part of it (e.g., one agent from a dual therapy) with none of the dosages aligned with WHO AWaRe Book guidance. </li> 
  </ul>
</div>

***
<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Notes:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
    <li>Cases where oral clarithromycin was given alongside a recommended IV antibiotic (Cefotaxime, Ceftriaxone, or Amoxicillin‚ÄìClavulanic acid) were considered appropriate IV treatment. Because clarithromycin is part of the recommended combination for severe CAP (CURB-65 ‚â•2), these cases were excluded from the oral antibiotic appropriateness assessment</li>  <br>
    <li>The combined total of patients in the oral and IV antibiotic choice/dosage appropriateness assessment summaries may exceed the overall number of patients, as some were prescribed both oral and IV treatments ‚Äî so they are included in both summaries. </li> <br>
  </ul>
</div>


***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice & Dosage Appropriateness for CAP
</h2>

***
<h3> üìã IV Antibiotic Choice Appropriateness for CAP </h3>

This section evaluates the **appropriateness of IV antibiotic drug dosage** for patients with CAP, in line with the WHO AWaRe Book guidance.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}
# Exclude Hospital-Wide and non-recommended options
final_summary2_Pneu_IV <- final_summary2_IV %>%
  filter(`Department name` != "Hospital-Wide",
         !Dose_Result == "Received IV antibiotics not among recommended options")

# Calculate total eligible CAP patients
total_approp_iv_given <- final_summary2_Pneu_IV %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Handle case with no eligible patients
if (total_approp_iv_given == 0 || is.na(total_approp_iv_given)) {
  final_summary_html2 <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating the <strong>appropriateness of IV antibiotic dosage</strong> for CAP.<br><br>
    <em>This may indicate that no patients met the inclusion criteria, or that no patients received recommended IV antibiotics during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html2)

} else {

  # Intro text card
  intro_text2 <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible CAP patients who received recommended (<em>or partially recommended</em>) IV antibiotic choice based on WHO AWaRe Book (<strong>{total_approp_iv_given}</strong> out of {total_eligible_IV})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Relevant categories to include
  all_categories2 <- c(
    "Received recommended IV antibiotics with recommended dosage",
    "Received at least one recommended IV antibiotic with only one has recommended dosage",
    "Received at least one recommended IV antibiotic with none have recommended dosage"
  )

  # Get all combinations
  dept_list <- unique(final_summary2_IV$`Department name`)
  complete_summary <- expand_grid(
    `Department name` = dept_list,
    Dose_Result = all_categories2
  ) %>%
    left_join(final_summary2_IV, by = c("Department name", "Dose_Result")) %>%
    filter(Dose_Result %in% all_categories2) %>%
    mutate(
      Patients = replace_na(Patients, 0),
      Total = ave(Patients, `Department name`, FUN = sum),
      Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1))
    )

  # Icon function
  get_icon <- function(label) {
    label_lower <- tolower(trimws(label))
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("<span style='color:#28a745;'>‚úÖ</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("<span style='color:#e6b800;'>‚ö†Ô∏è</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with none have recommended dosage") {
      return("<span style='color:#d00;'>‚ùå</span>")
    } else {
      return("üõà")
    }
  }

  # Description function
  get_description <- function(label) {
    label_lower <- tolower(label)
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("Received recommended IV antibiotics with recommended dosage")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("Received at least one recommended IV antibiotic with only one has recommended dosage")
    } else if (label_lower == "received at least one recommended iv antibiotic with none have recommended dosage") {
      return("Received at least one recommended IV antibiotic with none have recommended dosage")
    } else {
      return(paste("Received:", label))
    }
  }

  # Generate HTML summary blocks
  formatted_blocks2 <- complete_summary %>%
    group_by(`Department name`) %>%
    summarise(
      block = {
        dept <- first(`Department name`)
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"
        total_patients <- max(Total, na.rm = TRUE)

        list_items <- purrr::map_chr(all_categories2, function(label) {
          row_data <- complete_summary %>%
            filter(`Department name` == dept, Dose_Result == label)
          count <- row_data$Patients
          prop <- row_data$Proportion
          icon <- get_icon(label)
          description <- get_description(label)

          glue::glue(
            "<li>{icon} <strong>{description}</strong> (as per WHO AWaRe Book): 
            <strong>{scales::percent(prop / 100, accuracy = 0.1)}</strong> 
            ({count} out of {total_patients})</li>"
          )
        })

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_patients} patients)</span><br><br>
          <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
          {paste(list_items, collapse = '')}
          </ul>
          </div>"
        )
      },
      .groups = "drop"
    ) %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Final render
  final_summary_html2 <- HTML(paste0(intro_text2, paste(formatted_blocks2$block, collapse = "\n")))
  htmltools::browsable(final_summary_html2)
}

```

***

<h3> üìã ORAL Antibiotic Choice Appropriateness for CAP </h3>

This section evaluates the **appropriateness of ORAL antibiotic drug dosage** for patients with CAP, in line with the WHO AWaRe Book guidance.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}
# Exclude Hospital-Wide row for department-level summaries
final_summary2_ORAL <- final_summary2_Oral %>%
  filter(`Department name` != "Hospital-Wide")


# Define the relevant dose categories
dose_categories2 <- c(
  "Received recommended ORAL antibiotic with recommended dosage",
  "Received recommended ORAL antibiotic without recommended dosage"
)

# Total eligible patients who received any recommended ORAL antibiotics with dosage data
total_approp_oral_given <- final_summary2_ORAL %>%
  filter(Dose_Result %in% dose_categories2) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# If there's no data at all for dosage-related indicators
relevant_dose_data2 <- final_summary2_ORAL %>%
  filter(Dose_Result %in% dose_categories2)

# Calculate total eligible CAP patients
total_approp_oral_given <- relevant_dose_data2 %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

if (nrow(relevant_dose_data2) == 0) {
  final_summary_html3 <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
     ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible CAP patients for assessing ORAL antibiotic dosage appropriateness.<br><br>
   <em>  This may indicate that no patients met the inclusion criteria, or no patients received recommended ORAL antibiotics during the reporting period. </em>
    </div>"
  ))
  htmltools::browsable(final_summary_html3)

} else {
  # Build denominator explanation block
  intro_text3 <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible CAP patients who received any recommended ORAL antibiotic choice based on WHO AWaRe Book (<strong>{total_approp_oral_given}</strong> out of {total_eligible_ORAL}).
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Ensure all department-dose result combinations are present
  dept_list2 <- unique(final_summary2_Oral$`Department name`)
  complete_summary2 <- expand_grid(
    `Department name` = dept_list2,
    Dose_Result = dose_categories2
  ) %>%
    left_join(final_summary2_Oral, by = c("Department name", "Dose_Result")) %>%
    mutate(
      Patients = replace_na(Patients, 0),
      Total = ave(Patients, `Department name`, FUN = sum),
      Proportion = ifelse(Total == 0, 0, Patients / Total)
    )

  # Filter out rows with Total = 0 (no eligible patients in that department)
  complete_summary2 <- complete_summary2 %>%
    filter(Total > 0)

  # If after filtering all are zero, return no data message
  if (nrow(complete_summary2) == 0) {
    final_summary_html3 <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
      Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating the <strong>appropriateness of ORAL antibiotic dosage</strong> for CAP <br><br>
   <em>  This may indicate that no patients met the inclusion criteria, or no patients received recommended ORAL antibiotics during the reporting period. </em>
    </div>"
    ))
    htmltools::browsable(final_summary_html3)

  } else {
    # Format HTML blocks per department
    formatted_blocks3 <- complete_summary2 %>%
      group_by(`Department name`) %>%
      summarise(
        block = {
          dept <- first(`Department name`)
          color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
          bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

          glue::glue(
            "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
            <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {first(Total)} patients)</span><br><br>
            <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
              <li>‚úÖ <strong>Received recommended ORAL antibiotic with recommended dosage</strong> (as per WHO AWaRe Book): <strong>{scales::percent(Proportion[Dose_Result == 'Received recommended ORAL antibiotic with recommended dosage'], accuracy = 0.1)}</strong> ({Patients[Dose_Result == 'Received recommended ORAL antibiotic with recommended dosage']} out of {first(Total)})</li>
              <li>‚ùå <strong>Received recommended ORAL antibiotic without recommended dosage</strong> (as per WHO AWaRe Book): <strong>{scales::percent(Proportion[Dose_Result == 'Received recommended ORAL antibiotic without recommended dosage'], accuracy = 0.1)}</strong> ({Patients[Dose_Result == 'Received recommended ORAL antibiotic without recommended dosage']} out of {first(Total)})</li>
            </ul>
            </div>"
          )
        },
        .groups = "drop"
      )

    # Reorder to show Hospital-Wide first
    formatted_blocks3 <- formatted_blocks3 %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order, `Department name`) %>%
      select(-order)

    # Final HTML output
    final_summary_html3 <- HTML(paste0(intro_text3, paste(formatted_blocks3$block, collapse = "\n")))
    htmltools::browsable(final_summary_html3)
  }
}
```
