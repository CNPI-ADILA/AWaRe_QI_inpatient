---
title: "[2] Meningitis: WHO AWaRe QIs analysis against gPPS data"
author: "CNPI AMR"
date: "Last compiled on `r format(Sys.time(), '%A %d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    df_print: paged
    highlight: tango
    fig_width: 10
    fig_height: 6
    fig_caption: true
    code_folding: hide
editor_options:
  markdown:
    wrap: 72
---


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
  üìä Report Overview
</h1>
<p style="font-size: 1.15em; color: #444; margin-top: -0.4em; margin-bottom: 1em;">
This report presents a summary of the AWaRe-based quality indicator analysis based on gPPS inpatient data for Bacterial Meningitis.

</p>

This analytical script implements **WHO AWaRe (Access, Watch, Reserve)** antibiotic use **quality indicators (QIs)** for treating **bacterial meningitis** in adult inpatients with **community-acquired infections (CAIs)**. It utilises standardised data from the Global PPS (gPPS), specifically extracted from Excel-based outputs received by participating hospitals.

**Case Definition:**
<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
<strong>Bacterial Meningitis</strong> (Based on WHO AWaRe book)<br>
‚ñ∏ <strong>gPPS diagnostic code:</strong> <code>CNS</code><br>
‚ñ∏ <strong>gPPS definition:</strong> Includes central nervous system infections
</div>

The aim is to assess the appropriateness of **empirical antibiotic prescribing** for meningitis, benchmarked against WHO AWaRe Book, and to provide structured feedback at both the hospital and ward levels. These insights support **antimicrobial stewardship efforts** by highlighting patterns of suboptimal prescribing and identifying opportunities for targeted quality improvement.

---


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üéØ WHO AWaRe QIs for Meningitis
</h2>


Within the scope of the gPPS data structure, **ONE** QI has been identified as compatible for evaluating Meningitis-related empirical antibiotic prescriptions in adults with CAIs:


<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_MEN_APPROP_ABX</strong>: Proportion of patients presenting with bacterial meningitis given the appropriate IV antibiotics according to the <em>WHO AWaRe Book</em>.<br>

</div>
---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üí¨ General Notes:
</h2>

- Analysis includes only **adult patients (‚â•18 years)** with **CAIs** on **empirical** treatment.

- **Intravenous (IV) administration** was inferred using the gPPS `"Route"` code `"P"` (Parenteral), recognizing that it may include other parenteral routes but predominantly indicates IV use in empirical clinical practice.

- It was assumed that **WHO recommendations for bacterial meningitis** align with the gPPS diagnostic code **`CNS` (central nervous system infections)**; therefore, these cases were assessed using the WHO AWaRe classification.

- **QIs** were mapped and interpreted based on clinical assumptions aligning WHO Book with the available **gPPS diagnostic codes**.

---


<div style="background-color: #fff4e5; border-left: 6px solid #ffc107; padding: 12px; margin-top: 10px;"> üí° <strong>Reminder:</strong> Caution is advised when interpreting results from small sample sizes (<10 patients) </div> 


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üîç Initial Eligible Cases Check
</h1>

This section assesses whether there are enough eligible cases to support meaningful analysis.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
rm(list = ls()) #clear global environment

# Define required packages
packages <- c(
  "dplyr", 
  "tidyverse", 
  "readxl", 
  "glue",
  "purrr",
  "tidyr",
  "htmltools", 
  "ggtext", 
  "forcats",
  "scales",
  "kableExtra"
)

# Install missing packages
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) install.packages(new_packages)

# Load all packages
invisible(lapply(packages, library, character.only = TRUE))

# Read data
data_info <- read_excel(
  "HA-Global-PPS_example_dummy data.xlsx",
  sheet = "Survey",
  col_types = c("guess", "date", "guess", "date")  # to read dates 
)
data_deps <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Department forms")
data_patients_all <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Patient forms")
data_lookup <- read_excel("QIs-Lookup.xlsx")


# Select the needed data and merge the sheets to create a simpler version.
data_patients <- data_patients_all %>%
  select("Survey Number", "Department name", "Age years", "Weight", "ATC5", "Single Unit Dose", "Unit", "N Doses/day", "Route", "AWaRe", "Diagnosis code", "Indication", "Treatment")


data_patients[data_patients==""]<-NA     # makes all empty spaces to N/A

data_patients <- data_patients %>%
  mutate(
    AWaRe = ifelse(
      toupper(AWaRe) == "NOT_RECOMMENDED",
      "NOT RECOMMENDED",
      AWaRe
    )
  )


AWaRe_abx <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")


# Flag eligible patients (minimum: 10 patients) for Community-Acquired Meningitis in Adults on Empirical Treatment
data_men <- data_patients %>%
  filter(`Diagnosis code` == "CNS") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Count eligible unique patients
eligible_men_n <- data_men %>%
  filter(AWaRe_compatible) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Format survey dates (assuming row 3, col 2 and 4)
survey_start <- format(data_info[[2]][3], "%d %b %Y")
survey_end <- format(data_info[[4]][3], "%d %b %Y")

# HTML feedback summary for meningitis
html_feedback <- HTML(glue(
"<div style='background-color: #f0f8ff; border: 1px solid #add8e6; padding: 15px; border-radius: 5px; font-family: sans-serif;'>

  <p style='margin-bottom: 10px;'>
    <strong>üìÖ Survey period:</strong> {survey_start} to {survey_end}
  </p>

  <p>
    This script applies <strong>WHO AWaRe Quality Indicators</strong> to adult inpatients receiving empirical antibiotics for community-acquired bacterial meningitis.
  </p>

  <ul>
    <li><strong>Diagnostic code:</strong> CNS</li>
    <li><strong>Total eligible cases:</strong> {eligible_men_n}</li>
  </ul>

  {if(eligible_men_n == 0){
    '<div style=\"background-color:#fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>üö´ No eligible cases found:</strong> There were no eligible cases for evaluation during this survey period. Please verify data availability.
    </div>'
  } else if(eligible_men_n < 10){
    '<div style=\"background-color:#ffe0e0; border: 1px solid #ffb3b3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚ö†Ô∏è Caution:</strong> Few eligible cases detected. Interpret results with caution.
    </div>'
  } else {
    '<div style=\"background-color:#e0ffe0; border: 1px solid #b3ffb3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚úÖ Good to go!</strong> Sufficient eligible cases available to proceed with full evaluation.
    </div>'
  }}

</div>"
))

# Render feedback
htmltools::browsable(html_feedback)


```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üßæ Summary of Meningitis Eligible Patients for QI Assessment
</h1>

Eligible patients for **WHO AWaRe Quality Indicator (QI)** assessment are defined as **adult inpatients (‚â•18 years)** who received **empirical antibiotics** for **CA-meningitis**.

This section presents both **prescription-level** and **patient-level** summaries to establish how much of the dataset is relevant for QI evaluation. It helps frame the proportion of all prescriptions that are relevant to CA-meningitis.



<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üë• Patient-Level Summary
</h2>

This table reports on unique patients in each eligibility group. It reflects the clinical burden of meningitis and the proportion of patients suitable for QI evaluation.

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of patients on antibiotics: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong><br>
Total number of eligible patients on antibiotics: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "CNS") %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total unique patients on antibiotics
total_patients <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Patient-level summary
patient_summary <- data.frame(
  Category = c(
    "Number of adult patients (‚â•18 years) who received empirical antibiotic treatment for CAI",
    "Number of all patients with a diagnosis of meningitis on any antibiotics",
    "**Number of eligible patients:** Adult patients (‚â•18 years) with a diagnosis of CA-meningitis who were treated empirically with antibiotics"
  ),
  Count = c(
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Diagnosis code` == "CNS", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "CNS", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_patients)
  )

# Show table
knitr::kable(
  patient_summary,
  col.names = c("Patient Category", "Number of Patients", "Proportion of All Patients"),
  format = "html",
  align = "lcr"  # Left-align category, center number, right-align proportion
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")  

```



<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìë Prescription-Level Summary
</h2>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of antibiotic prescriptions: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% nrow()`</strong><br>
Total number of eligible antibiotic prescriptions: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "CNS") %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total prescriptions
total_prescriptions <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  nrow()

# Prescription summary table
prescription_summary <- data.frame(
  Category = c(
    "Number of empirical antibiotic prescriptions administered to adult patients (‚â•18 years) for CAI",
    "Number of all antibiotic prescriptions for patients diagnosed with meningitis",
    "**Number of eligible antibiotic prescriptions:** antibiotics empirically prescribed for adult patients (‚â•18 years) with CA-meningitis"
  ),
  Count = c(
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Diagnosis code` == "CNS", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "CNS", AWaRe %in% AWaRe_abx) %>% nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_prescriptions)
  )

# Display table
knitr::kable(
  prescription_summary,
  col.names = c("Prescription Category", "Number of Prescriptions", "Proportion of All Prescriptions"),
  format = "html",
  align = "lcr"  # Left-align category, center number, right-align proportion
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em") 

```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìò WHO AWaRe-QIs Overview
</h1>
This section evaluates one indicator:

<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_MEN_APPROP_ABX</strong>: Proportion of patients presenting with bacterial meningitis given the appropriate IV antibiotics according to the <em>WHO AWaRe Book</em>.<br>

</div>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
<strong>üîç WHO AWaRe Book Recommendation:</strong><br><br>

<strong>First choice:</strong> Cefotaxime (2 g q6h IV) <em>OR</em> Ceftriaxone (2 g q12h IV)<br>
<strong>Second choice:</strong> Amoxicillin (2 g q4h IV) <em>OR</em> Ampicillin (2 g q4h IV) <em>OR</em> Benzylpenicillin (4 million IU [2.4 g] q4h IV) <em>OR</em> Chloramphenicol (1 g q6h IV)
</div>

<div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin-top: 10px; margin-bottom: 18px;">
<strong>üìò WHO AWaRe Notes:</strong>
<ul>
  <li>Empiric treatment is based on patient age, immune status, and local prevalence of <em>S. pneumoniae</em> isolates resistant to third-generation cephalosporins (rare but possible with recent or multiple Œ≤-lactam exposures).</li>
  <li>Consider second choice options only when first choice antibiotics are not available.</li>
  <li>Use chloramphenicol only when no other option is available due to its toxicity.</li>
  <li>Add ampicillin (or IV amoxicillin) to ceftriaxone/cefotaxime if risk factors for <em>Listeria monocytogenes</em> are present (e.g., age ‚â•50, pregnancy).</li>
  <li>Due to the severity of meningitis, all suspected cases should be treated immediately as bacterial until viral causes are confirmed or ruled out.</li>
  <li><em>Listeria</em> is not covered by ceftriaxone or cefotaxime‚Äîuse ampicillin if <em>Listeria</em> is suspected.</li>
  <li>Dexamethasone 0.15 mg/kg q6h is recommended only in high-income settings (no evidence of benefit in others).</li>
</ul>
</div>

---

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

## Data preparation: antibiotic choice appropriateness


# Prepare the data (Select Meningitis data only)
data_men <- data_patients %>%
  filter(`Diagnosis code` == "CNS") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Lookup ABX names for Meningitis QI
lookup_names <- data_lookup %>%
  filter(Code == "H_MEN_APPROP_ABX") %>%
  select(starts_with("ABX-ATC")) %>%
  unlist(use.names = FALSE)

# Flag matched prescriptions
data_men <- data_men %>%
  mutate(
    Drug_Match = ATC5 %in% lookup_names
  )

# Extract lookup info for H_MEN_APPROP_ABX
lookup_men <- data_lookup %>%
  filter(Code == "H_MEN_APPROP_ABX")

# Create long format from lookup
lookup_long <- tibble(
  Drug = unlist(lookup_men %>% select(starts_with("ABX-ATC")), use.names = FALSE),
  Choice = unlist(lookup_men %>% select(starts_with("ABX-CHOICE")), use.names = FALSE)
) %>%
  filter(!is.na(Drug))  # Remove empty rows

# Merge choice info with patient-level data
data_men <- data_men %>%
  left_join(lookup_long, by = c("ATC5" = "Drug"))

#  Add Department info to patient summary
patient_summary <- data_men %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    All_ABX = list(unique(ATC5)),
    
    # Match flags
    Match_1 = any(ATC5 == lookup_names[1]),
    Match_2 = any(ATC5 == lookup_names[2]),
    Match_3 = any(ATC5 == lookup_names[3]),
    Match_4 = any(ATC5 == lookup_names[4]),
    Match_5 = any(ATC5 == lookup_names[5]),
    Match_6 = any(ATC5 == lookup_names[6]),

    Match_1_P = any(ATC5 == lookup_names[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names[5] & Route == "P"),
    Match_6_P = any(ATC5 == lookup_names[6] & Route == "P"),

    N_ABX = n_distinct(ATC5),
    Any_IV = any(Route == "P"),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    Num_Recommended_P = sum(c_across(Match_1_P:Match_6_P)),

    # Fully appropriate: only one antibiotic, and it's recommended
    Appropriate = Num_Recommended_P == 1 & N_ABX == 1,

    # Partial appropriate: ‚â•1 recommended drug, but given with others
    Partial_Appropriate = Num_Recommended_P >= 1 & N_ABX > 1,

    # Inappropriate IV use (no recommended drugs via IV)
    No_Appropriate = Any_IV & !Appropriate & !Partial_Appropriate,

    # All other inappropriate cases (e.g. oral use only or unclear combinations)
    No_Appropriate_others = !Appropriate & !Partial_Appropriate & !No_Appropriate
  ) %>%
  ungroup()


# Get not eligible patients with department info
not_eligible_patients <- data_men %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(Ineligible = all(AWaRe_compatible == FALSE), .groups = "drop") %>%
  filter(Ineligible)

# Create summary table with Department name
eligible_long <- patient_summary %>%
  select(`Survey Number`, `Department name`, Appropriate, Partial_Appropriate, No_Appropriate, No_Appropriate_others) %>%
  pivot_longer(
    cols = -c(`Survey Number`, `Department name`),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(Value = as.logical(Value)) %>%
  filter(Value) %>%
  group_by(`Department name`, Indicator) %>%
  summarise(Patients = n(), .groups = "drop")

# Get all possible combinations of departments and indicators
all_combos <- expand_grid(
  `Department name` = unique(patient_summary$`Department name`),
  Indicator = c("Appropriate", "Partial_Appropriate", "No_Appropriate", "No_Appropriate_others", "Not_Eligible")
)

# Left join and replace NAs with 0
eligible_long <- all_combos %>%
  left_join(eligible_long, by = c("Department name", "Indicator")) %>%
  mutate(Patients = replace_na(Patients, 0))


# Add not eligible
ineligible_summary <- not_eligible_patients %>%
  count(`Department name`) %>%
  mutate(Indicator = "Not_Eligible") %>%
  rename(Patients = n)

# Combine
qi_long <- bind_rows(eligible_long, ineligible_summary)

# Calculate total per department
dept_totals <- qi_long %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

# Final summary table with proportions
qi_summary_men <- qi_long %>%
  left_join(dept_totals, by = "Department name") %>%
  mutate(
    Indicator = case_when(
      Indicator == "Appropriate" ~ "Received recommended IV antibiotics",
      Indicator == "Partial_Appropriate" ~ "Partially received recommended IV antibiotics",
      Indicator == "No_Appropriate" ~ "Received IV antibiotics not among recommended options",
      Indicator == "No_Appropriate_others" ~ "Received other non-IV antibiotics",
      Indicator == "Not_Eligible" ~ "Not eligible for AWaRe meningitis QIs",
      TRUE ~ Indicator
    ), 
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  select(`Department name`, Indicator, Patients, Total, Proportion)

#  Add Hospital-Wide Total row 
hospital_data <- qi_summary_men %>%
  group_by(Indicator) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  select(`Department name`, Indicator, Patients)

# Combine with original data
qi_summary_men <- bind_rows(qi_summary_men, hospital_data)

# Recalculate totals and proportions
qi_summary_men <- qi_summary_men %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()

# Format "Hospital" label to bold
qi_summary_men <- qi_summary_men %>%
  mutate(`Department name` = ifelse(`Department name` == "Hospital-Wide", "Hospital-Wide", `Department name`))
```


<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 1 ‚Äì IV Antibiotic Appropriateness 
</h1>

> **H_MEN_APPROP_ABX:** Proportion of patients presenting with bacterial meningitis given the appropriate IV antibiotics according to the WHO AWaRe Book.


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness for Meningitis
</h2>

This visual summarises the proportion of antibiotic appropriateness for meningitis across hospital departments based on WHO AWaRe Book


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Define label and color lookup
indicator_labels <- c(
  "Appropriate"       = "Received recommended IV antibiotics",
  "Partial_Appropriate"    = "Partially received recommended IV antibiotics",
  "No_Appropriate"    = "Received IV antibiotics not among recommended options",
  "No_Appropriate_others" = "Received other non-IV antibiotics",
  "Not_Eligible"      = "Not eligible for AWaRe meningitis QIs"
)

drug_choice_colors <- c(
  "Received recommended IV antibiotics"             = "#1F77B4",
  "Partially received recommended IV antibiotics"         = "#4FA9DC",
  "Received IV antibiotics not among recommended options"         = "#EF476F",
  "Received other non-IV antibiotics"      = "#D3D3D3",
  "Not eligible for AWaRe meningitis QIs"  = "#A9A9A9"
)

# Create labeled and styled department field
qi_summary_men <- qi_summary_men %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(
      PlotLabel,
      levels = c(
        "<b style='color:#0072B2;'>Hospital-Wide</b>",
        sort(setdiff(unique(`Department name`), "Hospital-Wide"))
      )
    ),
    Indicator = factor(
      Indicator,
      levels = c(
        "Received recommended IV antibiotics",
        "Partially received recommended IV antibiotics",
        "Received IV antibiotics not among recommended options",
        "Received other non-IV antibiotics",
        "Not eligible for AWaRe meningitis QIs"
      )
    )
  )

# Plot using PlotLabel
ggplot(qi_summary_men, aes(x = PlotLabel, y = Proportion, fill = Indicator)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  geom_text(
    aes(label = ifelse(Patients > 0, Patients, "")),
    position = position_fill(vjust = 0.5),
    size = 3, color = "black"
  ) +
  geom_text(
    data = qi_summary_men %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0.6
  ) +
  scale_fill_manual(
    values = drug_choice_colors,
    labels = indicator_labels
  ) +
  scale_y_continuous(limits = c(0, 1.09), expand = c(0, 0)) +
  labs(
    title = "Antibiotic Choice Appropriateness Summary for Meningitis",
    subtitle = "Each bar shows distribution of appropriateness against WHO AWaRe guidelines (n = raw patient counts)",
    x = "Department",
    y = "Proportional Stacked Bars",
    fill = "Treatment Appropriateness Category"
  ) +
  theme_minimal(base_size = 8) +
  theme(
    axis.text.x = element_markdown(size = 8, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 8),
    axis.title = element_text(face = "bold", size = 10),
    legend.position = "right",
    legend.title = element_text(face = "bold", size = 8),
    legend.text = element_text(size = 8, margin = margin(b = 4)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 7, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 6, byrow = FALSE, title.position = "top")
  )



```

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by AWaRe Classification
</h2>

This visual summarises the proportion of antibiotic appropriateness for meningitis across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

## Data Preparation of antibiotic choice appropriateness by AWaRe

# Add Department info to patient summary
patient_summary_AWARE <- data_men %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`, AWaRe) %>%  # Add department here
  summarise(
    N_total = n(),
    N_match = sum(Drug_Match),
    N_p = sum(Route == "P"),
    N_p_match = sum(Route == "P" & Drug_Match),

    # Match flags
    Match_1 = any(ATC5 == lookup_names[1]),
    Match_2 = any(ATC5 == lookup_names[2]),
    Match_3 = any(ATC5 == lookup_names[3]),
    Match_4 = any(ATC5 == lookup_names[4]),
    Match_5 = any(ATC5 == lookup_names[5]),
    Match_6 = any(ATC5 == lookup_names[6]),
    
    # Route-specific match flags
    Match_1_P = any(ATC5 == lookup_names[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names[5] & Route == "P"),
    Match_6_P = any(ATC5 == lookup_names[6] & Route == "P"),
    
    .groups = "drop"
  ) %>%
  mutate(
        Appropriate_IV = (
      (Match_1_P | Match_2_P | Match_3_P | Match_4_P | Match_5_P | Match_6_P) 
    ))


# Create summary table with Department name
AWaRe_long <- patient_summary_AWARE %>%
  select(`Survey Number`, `Department name`, AWaRe, Appropriate_IV) %>%
  pivot_longer(
    cols = -c(`Survey Number`, `Department name`, AWaRe),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  filter(Value) %>%
  group_by(`Department name`, AWaRe, Indicator) %>%
  summarise(Patients = n(), .groups = "drop")

# Calculate total per department
AWaRe_dept_totals <- AWaRe_long %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

# Final summary table with proportions
AWaRe_long <- AWaRe_long %>%
  left_join(AWaRe_dept_totals, by = "Department name")  %>% 
  mutate (Proportion = round(100 * Patients / Total, 1))


#  Add Hospital-Wide Total row 
AWaRe_hospital_data <- AWaRe_long %>%
  group_by(AWaRe) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  select(`Department name`, AWaRe, Patients)

# Combine with original data
AWaRe_long <- bind_rows(AWaRe_long, AWaRe_hospital_data)




#  ---- Ploting ---
# Set the stacking order (in data)
aware_levels_stack <- c("WATCH", "ACCESS")
AWaRe_long$AWaRe <- factor(AWaRe_long$AWaRe, levels = aware_levels_stack)

# Ensure all AWaRe levels are present per department
all_combos3 <- expand_grid(
  `Department name` = unique(AWaRe_long$`Department name`),
  AWaRe = aware_levels_stack
)

AWaRe_long <- all_combos3 %>%
  left_join(AWaRe_long, by = c("Department name", "AWaRe")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = replace_na(Total, 0),
    Proportion = replace_na(Proportion, 0)
  )


# Recalculate totals and proportions
AWaRe_long <- AWaRe_long %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()

# Format "Hospital-Wide" label to bold
AWaRe_long <- AWaRe_long %>%
  mutate(`Department name` = ifelse(`Department name` == "Hospital-Wide", "Hospital-Wide", `Department name`))

# Use a different legend order (for display)
aware_levels_legend <- c("ACCESS", "WATCH")

# Create styled PlotLabel (for axis labels)
AWaRe_long <- AWaRe_long %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(
      PlotLabel,
      levels = rev(c(
        "<b style='color:#0072B2;'>Hospital-Wide</b>",
        sort(setdiff(unique(`Department name`), "Hospital-Wide"))
      ))
    )
  )

# Rebuild the plot
ggplot(AWaRe_long, aes(x = PlotLabel, y = Proportion, fill = AWaRe)) +
  
  # Highlight Hospital-Wide row
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +

  # Stacked proportional bars
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  # % inside segments
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +

  # Total n= above bars
  geom_text(
    data = AWaRe_long %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0
  ) +

  # Color scheme
  scale_fill_manual(
    breaks = c("ACCESS", "WATCH"),
    values = c(
      "ACCESS" = "#1b9e77",
      "WATCH"  = "#ff7f00"
    ),    
    drop = FALSE
  ) +

  # Flip bar orientation
  coord_flip(ylim = c(0, 1.04)) +

  # Labels
  labs(
    title = "Use of Recommended IV Antibiotics by AWaRe Classification",
    subtitle = "Proportions by ward (percentages shown inside bars)",
    x = "Department",
    y = "Proportion of Patients",
    fill = "AWaRe Classification"
  ) +

  # Styling
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_markdown(size = 10),  # enables bold HTML rendering
    axis.text.x = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.border = element_rect(color = "gray70", fill = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 9),
    plot.margin = margin(10, 10, 10, 10)
  )

```
<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The AWaRe classification divides antibiotics into three categories: Access, Watch, and Reserve. Access antibiotics are first-line treatments with a low risk of resistance, typically recommended for common infections. Watch antibiotics are associated with a higher risk of resistance and require careful monitoring. Reserve antibiotics are reserved for critical cases involving resistant infections, typically used only when other options are ineffective </strong>.
  <br>
</div>



---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness by line of treatment
</h2>

This visual summarises the proportion of antibiotic appropriateness for meningitis across hospital departments by line of treatment (First choice, Second choice)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Build the choice summary table
choice_summary <- data_men %>%
  filter(AWaRe_compatible == TRUE, Route == "P", !is.na(Choice)) %>%
  group_by(`Department name`, Choice) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Prescriptions),
    Proportion = Prescriptions / Total
  ) %>%
  ungroup()

# Add Hospital-Wide as a summary row
hospital_summary <- data_men %>%
  filter(AWaRe_compatible == TRUE, Route == "P", !is.na(Choice)) %>%
  group_by(Choice) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Prescriptions),
    Proportion = Prescriptions / Total
  ) %>%
  ungroup()

# Combine
choice_summary <- bind_rows(choice_summary, hospital_summary)

# Ensure all combinations (dept x Choice) are present
choice_levels_stack <- c("Second choice", "First choice")

all_combos <- expand_grid(
  `Department name` = unique(choice_summary$`Department name`),
  Choice = choice_levels_stack
)

choice_summary <- all_combos %>%
  left_join(choice_summary, by = c("Department name", "Choice")) %>%
  mutate(
    Prescriptions = replace_na(Prescriptions, 0),
    Total = replace_na(Total, 0),
    Proportion = replace_na(Proportion, 0)
  )


# Add styled PlotLabel column
choice_summary <- choice_summary %>%
  mutate(
    PlotLabel = ifelse(`Department name` == "Hospital-Wide",
                       "<b style='color:#0072B2;'>Hospital-Wide</b>",
                       `Department name`)
  )

# Factor the PlotLabel in reversed order (Hospital-Wide on top)
ordered_labels <- c(
  "<b style='color:#0072B2;'>Hospital-Wide</b>",
  sort(unique(choice_summary$PlotLabel[choice_summary$PlotLabel != "<b style='color:#0072B2;'>Hospital-Wide</b>"]))
)
choice_summary$PlotLabel <- factor(choice_summary$PlotLabel, levels = rev(ordered_labels))

# Separate label data for geom_text (n=)
label_data <- data_men %>%
  filter(AWaRe_compatible == TRUE, Route == "P", !is.na(Choice)) %>%
  count(`Department name`, name = "Total")

# Add Hospital-Wide total manually
hospital_total <- sum(label_data$Total)

label_data <- bind_rows(
  label_data,
  tibble(
    `Department name` = "Hospital-Wide",
    Total = hospital_total
  )
) %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(PlotLabel, levels = levels(choice_summary$PlotLabel))
  )


# Define stacking/legend order
choice_summary$Choice <- factor(choice_summary$Choice, levels = c("Second choice", "First choice"))
choice_levels_legend <- c("First choice", "Second choice")

# Create plot
ggplot(choice_summary, aes(x = PlotLabel, y = Proportion, fill = Choice)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1, fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +
  geom_text(
    data = label_data,
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0
  ) +
  scale_fill_manual(
    breaks = choice_levels_legend,
    values = c(
      "First choice"  = "#8E44AD",
      "Second choice" = "#00BCD4"
    )
  ) +
  coord_flip(ylim = c(0, 1.04)) +
  labs(
    title = "Use of Recommended IV Antibiotics by Line of Treatment",
    subtitle = "Proportions by ward (percentages shown inside bars)",
    x = "Department",
    y = "Proportion of Patients",
    fill = "Treatment Choice"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = element_markdown(size = 9), 
    axis.text.x = element_text(size = 9),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.border = element_rect(color = "gray70", fill = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    plot.margin = margin(10, 10, 10, 10)
  )

```

---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness for Meningitis
</h2>

This section summarises the proportion of antibiotic choice appropriateness for meningitis across hospital departments based on the WHO AWaRe Book.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Exclude Hospital-Wide for department-level summaries
qi_summary_men_filtered <- qi_summary_men %>%
  filter(`Department name` != "Hospital-Wide")

# Total eligible patients (excluding "Not eligible")
total_eligible <- qi_summary_men_filtered %>%
  filter(!Indicator %in% c("Not eligible for AWaRe meningitis QIs")) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Total patients who received IV antibiotics
total_iv <- qi_summary_men_filtered %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  )) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Extract only relevant indicators
relevant_data <- qi_summary_men_filtered %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  ))

# If no relevant data found ‚Äî display fallback message
if (nrow(relevant_data) == 0) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for community-acquired meningitis. <br><br>
    <em>This may indicate that no patients received IV antibiotics, or that none met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Summarise data per department
  summary_data_men <- relevant_data %>%
    group_by(`Department name`, Indicator) %>%
    summarise(Patients = sum(Patients), .groups = "drop") %>%
    pivot_wider(
      names_from = Indicator,
      values_from = Patients,
      values_fill = 0
    ) %>%
    mutate(
      Total = `Received recommended IV antibiotics` +
              `Partially received recommended IV antibiotics` +
              `Received IV antibiotics not among recommended options`,
      Prop_Full = `Received recommended IV antibiotics` / Total,
      Prop_Partial = `Partially received recommended IV antibiotics` / Total,
      Prop_None = `Received IV antibiotics not among recommended options` / Total
    ) %>%
    filter(Total > 0)

  # Handle case where data exists but all totals are 0
  if (nrow(summary_data_men) == 0) {
    final_summary_html <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for assessing IV antibiotic choice appropriateness for community-acquired meningitis.<br><br>
    <em>This may indicate that no patients received IV antibiotics, or that none met the inclusion criteria during the reporting period.</em>
      </div>"
    ))
    htmltools::browsable(final_summary_html)

  } else {
    # Create Hospital-Wide row by aggregation
    hospital_row <- summary_data_men %>%
      summarise(
        `Department name` = "Hospital-Wide",
        `Received recommended IV antibiotics` = sum(`Received recommended IV antibiotics`),
        `Partially received recommended IV antibiotics` = sum(`Partially received recommended IV antibiotics`),
        `Received IV antibiotics not among recommended options` = sum(`Received IV antibiotics not among recommended options`)
      ) %>%
      mutate(
        Total = `Received recommended IV antibiotics` +
                `Partially received recommended IV antibiotics` +
                `Received IV antibiotics not among recommended options`,
        Prop_Full = `Received recommended IV antibiotics` / Total,
        Prop_Partial = `Partially received recommended IV antibiotics` / Total,
        Prop_None = `Received IV antibiotics not among recommended options` / Total
      )

    # Combine all summaries
    summary_data_combined <- bind_rows(hospital_row, summary_data_men)

    # Intro explanation block
    intro_text <- glue::glue(
      "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
      üíä <strong>Denominator:</strong> Number of eligible patients who received any IV antibiotics for meningitis (<strong>{total_iv}</strong> out of {total_eligible}).
      </div><br><br>
      <strong>Summary:</strong><br><br>"
    )

    # Format per-department blocks
    formatted_blocks <- summary_data_combined %>%
      mutate(block = pmap_chr(
        list(
          `Department name`,
          Prop_Full, `Received recommended IV antibiotics`,
          Prop_Partial, `Partially received recommended IV antibiotics`,
          Prop_None, `Received IV antibiotics not among recommended options`,
          Total
        ),
        function(dept, full_p, full_n, part_p, part_n, none_p, none_n, total_n) {
          color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
          bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

          glue::glue(
            "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
            <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>
            <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
              <li>‚úÖ <strong>Received recommended IV antibiotics</strong> (as per WHO AWaRe Book): <strong>{scales::percent(full_p, accuracy = 0.1)}</strong> ({full_n} out of {total_n})</li>
              <li>‚ö†Ô∏è <strong>Partially received recommended IV antibiotics</strong> (as per WHO AWaRe Book): <strong>{scales::percent(part_p, accuracy = 0.1)}</strong> ({part_n} out of {total_n})</li>
              <li>‚ùå <strong>Received IV antibiotics not among recommended options</strong> (as per WHO AWaRe Book): <strong>{scales::percent(none_p, accuracy = 0.1)}</strong> ({none_n} out of {total_n})</li>
            </ul>
            </div>"
          )
        }
      ))

    # Reorder to show Hospital-Wide first
    formatted_blocks <- formatted_blocks %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order, `Department name`) %>%
      select(-order)

    # Final HTML output
    final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks$block, collapse = "\n")))
    htmltools::browsable(final_summary_html)
  }
}

```

***
<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The partially recommended category</strong> refers to cases in which patients were administered a WHO AWaRe-recommended antibiotic in combination with one or more additional antibiotics, rather than as monotherapy as specified in the guideline. <br>
</div>

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice & Dosage Appropriateness for Meningitis
</h2>


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

## Data preparation: antibiotic choice & dosage appropriateness

#  Filter Meningitis Patients and Add AWaRe Eligibility 
data_men2 <- data_patients %>%
  filter(`Diagnosis code` == "CNS") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

#  Lookup Drug & Dose Info for H_MEN_APPROP_ABX 
lookup2 <- data_lookup %>% filter(Code == "H_MEN_APPROP_ABX")
lookup_names2 <- unlist(lookup2[1, c("ABX-ATC-1", "ABX-ATC-2", "ABX-ATC-3", "ABX-ATC-4", "ABX-ATC-5", "ABX-ATC-6")], use.names = FALSE)
lookup_names2 <- toupper(trimws(lookup_names2))

#  Compute Total Daily Dose with MU ‚Üí IU conversion 
data_men2 <- data_men2 %>%
  mutate(
    Route = toupper(Route),
    
    # Normalise unit label and apply appropriate factor
    Unit_Factor = case_when(
      Unit == "mg" ~ 1,
      Unit == "g" ~ 1000,
      Unit == "IU" ~ 1,
      Unit == "MU" ~ 1e6,  # Convert MU (Million Units) to IU factor
      TRUE ~ NA_real_
    ),

    # Final total dose: always multiply single dose √ó freq √ó factor (includes MU)
    Total_Daily_Dose = as.numeric(`Single Unit Dose`) * as.numeric(`N Doses/day`) * Unit_Factor
  )


#  Match Drug + Dose + Route (with special case for drug 5) 

convert_unit <- function(unit) {
  case_when(
    unit == "mg" ~ 1,
    unit == "g" ~ 1000,
    unit == "IU" ~ 1,
    unit == "MU" ~ 1e6,
    TRUE ~ NA_real_
  )
}

# Helper to get expected dose
get_expected_dose <- function(i) {
  dose <- as.numeric(lookup2[[paste0("ABX-DOSE-", i)]][1])
  freq <- as.numeric(lookup2[[paste0("ABX-DAY-DOSE-", i)]][1])
  unit <- lookup2[[paste0("ABX-UNIT-", i)]][1]
  dose * freq * convert_unit(unit)
}

# Extract basic info
drug_names <- sapply(1:6, function(i) toupper(trimws(lookup2[[paste0("ABX-ATC-", i)]][1])))
routes <- sapply(1:6, function(i) toupper(trimws(lookup2[[paste0("ABX-ROUTE-", i)]][1])))
expected_doses <- sapply(1:6, get_expected_dose)

# Special logic for Drug 5 (main + alt dose)
expected_5_main <- expected_doses[5]
expected_5_alt <- as.numeric(lookup2[["ABX-DOSE-5a"]][1]) *
                  as.numeric(lookup2[["ABX-DAY-DOSE-5"]][1]) *
                  convert_unit(lookup2[["ABX-UNIT-5a"]][1])

# Perform matching in one go
data_men2 <- data_men2 %>%
  mutate(
    Match_Drug_Dose_1 = ATC5 == drug_names[1] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[1]) < 1,

    Match_Drug_Dose_2 = ATC5 == drug_names[2] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[2]) < 1,

    Match_Drug_Dose_3 = ATC5 == drug_names[3] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[3]) < 1,

    Match_Drug_Dose_4 = ATC5 == drug_names[4] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[4]) < 1,

    Match_Drug_Dose_5 = ATC5 == drug_names[5] & Route == "P" &
                        (
                          abs(Total_Daily_Dose - expected_5_main) < 1 |
                          abs(Total_Daily_Dose - expected_5_alt) < 1
                        ),

    Match_Drug_Dose_6 = ATC5 == drug_names[6] & Route == "P" &
                        abs(Total_Daily_Dose - expected_doses[6]) < 1
  )

#  Summaise at Patient Level 
patient_summary2 <- data_men2 %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    Match_1_P = any(ATC5 == lookup_names2[1] & Route == "P"),
    Match_2_P = any(ATC5 == lookup_names2[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names2[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names2[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names2[5] & Route == "P"),
    Match_6_P = any(ATC5 == lookup_names2[6] & Route == "P"),

    Dose_1_OK = any(Match_Drug_Dose_1),
    Dose_2_OK = any(Match_Drug_Dose_2),
    Dose_3_OK = any(Match_Drug_Dose_3),
    Dose_4_OK = any(Match_Drug_Dose_4),
    Dose_5_OK = any(Match_Drug_Dose_5),
    Dose_6_OK = any(Match_Drug_Dose_6),

    Any_IV = any(Route == "P"),
    .groups = "drop"
  ) %>%
  mutate(
    Any_Match = Match_1_P | Match_2_P | Match_3_P | Match_4_P | Match_5_P | Match_6_P,
    Any_Correct_Dose = 
      (Match_1_P & Dose_1_OK) |
      (Match_2_P & Dose_2_OK) |
      (Match_3_P & Dose_3_OK) |
      (Match_4_P & Dose_4_OK) |
      (Match_5_P & Dose_5_OK) |
      (Match_6_P & Dose_6_OK),

    Dose_Result = case_when(
      Any_Correct_Dose ~ "Received recommended IV antibiotic with recommended dosage",
      Any_Match & !Any_Correct_Dose ~ "Received recommended IV antibiotic without recommended dosage",
      Any_IV & !Any_Match ~ "Received IV antibiotics not among recommended options",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Dose_Result))


# Summarise by department 
iv_dose_counts <- patient_summary2 %>%
  count(`Department name`, Dose_Result, name = "Patients")

# Complete combinations: all depts √ó both results
all_combos2 <- expand_grid(
  `Department name` = unique(patient_summary2$`Department name`),
  Dose_Result = c("Received recommended IV antibiotic with recommended dosage", "Received recommended IV antibiotic without recommended dosage", "Received IV antibiotics not among recommended options")
)

# Merge and fill missing
iv_dose_summary2 <- all_combos2 %>%
  left_join(iv_dose_counts, by = c("Department name", "Dose_Result")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(Total = sum(Patients),
         Proportion = round(100 * Patients / Total, 1)) %>%
  ungroup()

#  Hospital-Wide row
hospital_row2 <- iv_dose_summary2 %>%
  group_by(Dose_Result) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(Total = sum(Patients),
         Proportion = round(100 * Patients / Total, 1)) %>%
  ungroup()

#  Final summary table
final_summary2 <- bind_rows(iv_dose_summary2, hospital_row2) %>%
  arrange(`Department name`, Dose_Result)


```


This visual summarises choice & dosage appropriateness for meningitis across hospital departments based on WHO AWaRe Book


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Order factor for bar stacking
final_summary2$Dose_Result <- factor(
  final_summary2$Dose_Result,
  levels = c("Received recommended IV antibiotic with recommended dosage", "Received recommended IV antibiotic without recommended dosage", "Received IV antibiotics not among recommended options")
)

#  Create styled PlotLabel
final_summary2 <- final_summary2 %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

# Define factor order (Hospital-Wide first, rest sorted)
ordered_labels <- c(
  "<b style='color:#0072B2;'>Hospital-Wide</b>",
  sort(unique(final_summary2$PlotLabel[final_summary2$PlotLabel != "<b style='color:#0072B2;'>Hospital-Wide</b>"]))
)
final_summary2$PlotLabel <- factor(final_summary2$PlotLabel, levels = rev(ordered_labels))

#  Extract unique n= label data with PlotLabel applied
label_data <- final_summary2 %>%
  distinct(`Department name`, Total) %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(PlotLabel, levels = levels(final_summary2$PlotLabel))
  )

#  Plot
ggplot(final_summary2, aes(x = PlotLabel, y = Proportion, fill = Dose_Result)) +

  # Highlight hospital-wide row
  annotate("rect",
           xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +

  # Stacked bars
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  # Count % inside bars
  geom_text(
    aes(label = ifelse(Proportion > 0.05, paste0(round(Proportion * 1, 1), "%"), "")),
    position = position_fill(vjust = 0.5),
    size = 3, color = "black"
  ) +

  # n= labels on top
  geom_text(
    data = label_data,
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0
  ) +

  # Custom fill colors
  scale_fill_manual(
    breaks = c("Received recommended IV antibiotic with recommended dosage", "Received recommended IV antibiotic without recommended dosage", "Received IV antibiotics not among recommended options"),
    values = c("Received recommended IV antibiotic with recommended dosage" = "#084594", "Received recommended IV antibiotic without recommended dosage" = "#FC9272", "Received IV antibiotics not among recommended options" = "#D3D3D3")
  ) +

  coord_flip(ylim = c(0, 1.05)) +

  labs(
    title = "Summary of Dosage Appropriateness for Meningitis Cases with Recommended Antibiotic Choices",
    subtitle = "Each bar shows distribution of appropriateness against WHO AWaRe guidelines (n = raw patient counts)",
    x = "Department",
    y = "Proportional Stacked Bars",
    fill = "Treatment Appropriateness Category"
  ) +

  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_markdown(size = 8),  
    axis.title = element_text(face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(margin = margin(r = 2)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 80, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 3, byrow = TRUE, title.position = "top")
  )


```

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice & Dosage Appropriateness for Meningitis
</h2>

This section evaluates the appropriateness of IV antibiotic drug dosage for patients with meningitis, in line with the WHO AWaRe Book guidance.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Exclude Hospital-Wide row for department-level summaries
final_summary2_men_filtered <- final_summary2 %>%
  filter(`Department name` != "Hospital-Wide")

# Define the relevant dose categories
dose_categories <- c(
  "Received recommended IV antibiotic with recommended dosage",
  "Received recommended IV antibiotic without recommended dosage"
)

# Total eligible patients who received any recommended IV antibiotics with dosage data
total_approp_iv_given <- final_summary2_men_filtered %>%
  filter(Dose_Result %in% dose_categories) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# If there's no data at all for dosage-related indicators
relevant_dose_data <- final_summary2_men_filtered %>%
  filter(Dose_Result %in% dose_categories)

if (nrow(relevant_dose_data) == 0) {
  final_summary_html2 <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
     ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible meningitis patients for assessing IV antibiotic dosage appropriateness.<br><br>
   <em>  This may indicate that no patients met the inclusion criteria, or no patients received recommended IV antibiotics during the reporting period. </em>
    </div>"
  ))
  htmltools::browsable(final_summary_html2)

} else {
  # Build denominator explanation block
  intro_text2 <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible meningitis patients who received any recommended (<em>or partially recommended</em>) IV antibiotic choice based on WHO AWaRe Book (<strong>{total_approp_iv_given}</strong> out of {total_eligible}.
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Ensure all department-dose result combinations are present
  dept_list <- unique(final_summary2$`Department name`)
  complete_summary <- expand_grid(
    `Department name` = dept_list,
    Dose_Result = dose_categories
  ) %>%
    left_join(final_summary2, by = c("Department name", "Dose_Result")) %>%
    mutate(
      Patients = replace_na(Patients, 0),
      Total = ave(Patients, `Department name`, FUN = sum),
      Proportion = ifelse(Total == 0, 0, Patients / Total)
    )

  # Filter out rows with Total = 0 (no eligible patients in that department)
  complete_summary <- complete_summary %>%
    filter(Total > 0)

  # If after filtering all are zero, return no data message
  if (nrow(complete_summary) == 0) {
    final_summary_html2 <- HTML(glue::glue(
      "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
      Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients for evaluating the <strong>appropriateness of IV antibiotic dosage</strong> for community-acquired meningitis <br><br>
   <em>  This may indicate that no patients met the inclusion criteria, or no patients received recommended IV antibiotics during the reporting period. </em>
    </div>"
    ))
    htmltools::browsable(final_summary_html2)

  } else {
    # Format HTML blocks per department
    formatted_blocks2 <- complete_summary %>%
      group_by(`Department name`) %>%
      summarise(
        block = {
          dept <- first(`Department name`)
          color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
          bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

          glue::glue(
            "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
            <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {first(Total)} patients)</span><br><br>
            <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
              <li>‚úÖ <strong>Received recommended IV antibiotic with recommended dosage</strong> (as per WHO AWaRe Book): <strong>{scales::percent(Proportion[Dose_Result == 'Received recommended IV antibiotic with recommended dosage'], accuracy = 0.1)}</strong> ({Patients[Dose_Result == 'Received recommended IV antibiotic with recommended dosage']} out of {first(Total)})</li>
              <li>‚ùå <strong>Received recommended IV antibiotic without recommended dosage</strong> (as per WHO AWaRe Book): <strong>{scales::percent(Proportion[Dose_Result == 'Received recommended IV antibiotic without recommended dosage'], accuracy = 0.1)}</strong> ({Patients[Dose_Result == 'Received recommended IV antibiotic without recommended dosage']} out of {first(Total)})</li>
            </ul>
            </div>"
          )
        },
        .groups = "drop"
      )

    # Reorder to show Hospital-Wide first
    formatted_blocks2 <- formatted_blocks2 %>%
      mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
      arrange(order, `Department name`) %>%
      select(-order)

    # Final HTML output
    final_summary_html2 <- HTML(paste0(intro_text2, paste(formatted_blocks2$block, collapse = "\n")))
    htmltools::browsable(final_summary_html2)
  }
}

```

