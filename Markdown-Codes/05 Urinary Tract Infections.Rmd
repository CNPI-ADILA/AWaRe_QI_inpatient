---
title: "[5] Upper Urinary Tract Infection (Upper UTI): WHO AWaRe QIs analysis against gPPS data"
author: "CNPI AMR"
date: "Last compiled on `r format(Sys.time(), '%A %d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    df_print: paged
    highlight: tango
    fig_width: 10
    fig_height: 6
    fig_caption: true
    code_folding: hide
editor_options:
  markdown:
    wrap: 72
---


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
  üìä Report Overview
</h1>
<p style="font-size: 1.15em; color: #444; margin-top: -0.4em; margin-bottom: 1em;">
This report presents a summary of the AWaRe-based quality indicator analysis based on gPPS inpatient data for Upper Urinary Tract Infection (Upper UTI).

</p>

This analytical script implements **WHO AWaRe (Access, Watch, Reserve)** antibiotic use **quality indicators (QIs)** for treating **Upper Urinary Tract Infection (Upper UTIs)** in adult inpatients with **community-acquired infections (CAIs)**. It utilises standardised data from the Global PPS (gPPS), specifically extracted from Excel-based outputs received by participating hospitals.

**Case Definition:**
<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
<strong>Upper Urinary Tract Infection</strong> (Based on WHO AWaRe book)<br>
‚ñ∏ <strong>gPPS diagnostic code:</strong> <code>Pye</code><br>
‚ñ∏ <strong>gPPS definition:</strong> includes pyelonephritis and catheter-associated upper urinary tract infections
</div>

The aim is to assess the appropriateness of **empirical antibiotic prescribing** for upper urinary tract infections, benchmarked against WHO AWaRe Book, and to provide structured feedback at both the hospital and ward levels. These insights support **antimicrobial stewardship efforts** by highlighting patterns of suboptimal prescribing and identifying opportunities for targeted quality improvement.

---


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üéØ WHO AWaRe QIs for Upper UTI
</h2>


Within the scope of the gPPS data structure, **three** QIs have been identified as compatible for evaluating Upper UTI-related empirical antibiotic prescriptions in adults with CAIs:


<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_UUTI_APPROP_DOSAGE</strong>: Proportion of patients presenting with Upper UTIs prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book. <br><br>
2. <strong>H_UUTI_WATCH_ABX</strong>: Proportion of patients with Upper UTI given IV/oral AWaRe Book Watch antibiotics.<br><br>
3. <strong>H_UUTI_IV_ABX</strong>: Proportion of patients presenting with Upper UTI given IV antibiotics.
</div>


---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üí¨ General Notes:
</h2>

- Analysis includes only **adult patients (‚â•18 years)** with **CAIs** on **empirical** treatment.

- **Intravenous (IV) administration** was inferred using the gPPS `"Route"` code `"P"` (Parenteral), recognizing that it may include other parenteral routes but predominantly indicates IV use in empirical clinical practice.

- It was assumed that **WHO recommendations for upper urinary tract infection** align with the gPPS diagnostic code **`Pye`**; therefore, these cases were assessed using the WHO AWaRe classification.

- **Quality Indicators (QIs)** were mapped and interpreted based on clinical assumptions aligning WHO Book with the available **gPPS diagnostic codes**.

---


<div style="background-color: #fff4e5; border-left: 6px solid #ffc107; padding: 12px; margin-top: 10px;"> üí° <strong>Reminder:</strong> Caution is advised when interpreting results from small sample sizes (<10 patients) </div> 


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üîç Initial Eligible Cases Check
</h1>

This section assesses whether there are enough eligible cases to support meaningful analysis.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
rm(list = ls()) #clear global environment

# Define required packages
packages <- c(
  "dplyr", 
  "tidyverse", 
  "readxl", 
  "glue",
  "purrr",
  "scales",
  "tidyr",
  "htmltools", 
  "ggtext", 
  "forcats",
  "kableExtra"
)

# Install missing packages
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) install.packages(new_packages)

# Load all packages
invisible(lapply(packages, library, character.only = TRUE))

# Read the sheets (Patient & Department forms)
data_info <- read_excel(
  "HA-Global-PPS_example_dummy data.xlsx",
  sheet = "Survey",
  col_types = c("guess", "date", "guess", "date")  # to read dates 
)
data_deps <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Department forms")
data_patients_all <- read_excel("HA-Global-PPS_example_dummy data.xlsx", sheet = "Patient forms")
data_lookup <- read_excel("QIs-Lookup.xlsx")


# Select the needed data and merge the sheets to create a simpler version.
data_patients <- data_patients_all %>%
  select("Survey Number", "Department name", "Age years", "Weight", "ATC5", "Single Unit Dose", "Unit", "N Doses/day", "Route", "AWaRe", "Diagnosis code", "Indication", "Treatment")



data_patients[data_patients==""]<-NA     # makes all empty spaces to N/A

data_patients <- data_patients %>%
  mutate(
    AWaRe = ifelse(
      toupper(AWaRe) == "NOT_RECOMMENDED",
      "NOT RECOMMENDED",
      AWaRe
    )
  )

AWaRe_abx <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")


#  Check if sufficient eligible Upper Urinary Tract Infection cases are available 


# Flag eligible patients for Community-Acquired Upper Urinary Tract Infection in Adults on Empirical Treatment
data_UTI <- data_patients %>%
  filter(`Diagnosis code` == "Pye") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Count eligible unique patients
eligible_UTI_n <- data_UTI %>%
  filter(AWaRe_compatible) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Format survey dates (assuming from data_info)
survey_start <- format(data_info[[2]][3], "%d %b %Y")
survey_end <- format(data_info[[4]][3], "%d %b %Y")

# HTML feedback summary for Upper UTI
html_feedback <- HTML(glue(
"<div style='background-color: #f0f8ff; border: 1px solid #add8e6; padding: 15px; border-radius: 5px; font-family: sans-serif;'>

  <p style='margin-bottom: 10px;'>
    <strong>üìÖ Survey period:</strong> {survey_start} to {survey_end}
  </p>

  <p>
    This script applies <strong>WHO AWaRe Quality Indicators</strong> to adult inpatients who received empirical antibiotics for community-acquired upper urinary tract infections (CA-Upper UTI).
  </p>

  <ul>
    <li><strong>Diagnostic code:</strong> Pye</li>
    <li><strong>Total eligible cases:</strong> {eligible_UTI_n}</li>
  </ul>

  {if(eligible_UTI_n == 0){
    '<div style=\"background-color:#fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>üö´ No eligible cases found:</strong> There were no eligible cases for evaluation during this survey period. Please verify data availability.
    </div>'
  } else if(eligible_UTI_n < 10){
    '<div style=\"background-color:#ffe0e0; border: 1px solid #ffb3b3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚ö†Ô∏è Caution:</strong> Few eligible cases detected. Interpret results with caution.
    </div>'
  } else {
    '<div style=\"background-color:#e0ffe0; border: 1px solid #b3ffb3; padding: 10px; border-radius: 3px; margin-top: 10px;\">
      <strong>‚úÖ Good to go!</strong> Sufficient eligible cases available to proceed with full evaluation.
    </div>'
  }}

</div>"
))


# Render feedback
htmltools::browsable(html_feedback)


```

***

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üßæ Summary of Upper UTI Eligible Patients for QI Assessment
</h1>

Eligible patients for **WHO AWaRe QI** assessment are defined as **adult inpatients (‚â•18 years)** who received **empirical antibiotics** for **CA-Upper UTI**.

This section presents both **prescription-level** and **patient-level** summaries to establish how much of the dataset is relevant for QI evaluation. It helps frame the proportion of all prescriptions that are relevant to CA-Upper UTI



<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üë• Patient-Level Summary
</h2>

This table reports on unique patients in each eligibility group. It reflects the clinical burden of Upper UTI and the proportion of patients suitable for QI evaluation.

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of patients on antibiotics: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong><br>
Total number of eligible patients on antibiotics: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "Pye") %>% distinct(.data[["Survey Number"]]) %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total unique patients on antibiotics
total_patients <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  distinct(`Survey Number`) %>%
  nrow()

# Patient-level summary
patient_summary <- data.frame(
  Category = c(
    "Number of adult patients (‚â•18 years) who received empirical antibiotic treatment for CAI",
    "Number of all patients with a diagnosis of Upper UTI on any antibiotics",
    "**Number of eligible patients:** Adult patients (‚â•18 years) with a diagnosis of CA-Upper UTI who were treated empirically with antibiotics"
  ),
  Count = c(
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Diagnosis code` == "Pye", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow(),
    data_patients %>%
      filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "Pye", AWaRe %in% AWaRe_abx) %>%
      distinct(`Survey Number`) %>%
      nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_patients)
  )

# Show table
knitr::kable(
  patient_summary,
  col.names = c("Patient Category", "Number of Patients", "Proportion of All Patients"),
  format = "html",
  align = "lcr"  # Left-align category, center number, right-align proportion
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em")  

```



<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìë Prescription-Level Summary
</h2>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">

<strong>üìä Summary:</strong><br>
Total number of antibiotic prescriptions: <strong>`r data_patients %>% filter(AWaRe %in% AWaRe_abx) %>% nrow()`</strong><br>
Total number of eligible antibiotic prescriptions: <strong>`r data_patients %>% filter(.data[["Age years"]] >= 18, Indication == "CAI", AWaRe %in% AWaRe_abx, Treatment == "EMPIRICAL", .data[["Diagnosis code"]] == "Pye") %>% nrow()`</strong>

</div>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Total prescriptions
total_prescriptions <- data_patients %>%
  filter(AWaRe %in% AWaRe_abx) %>%
  nrow()

# Prescription summary table
prescription_summary <- data.frame(
  Category = c(
    "Number of empirical antibiotic prescriptions administered to adult patients (‚â•18 years) for CAI",
    "Number of all antibiotic prescriptions for patients diagnosed with Upper UTI",
    "**Number of eligible antibiotic prescriptions:** antibiotics empirically prescribed for adult patients (‚â•18 years) with CA-Upper UTI"
  ),
  Count = c(
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Diagnosis code` == "Pye", AWaRe %in% AWaRe_abx) %>% nrow(),
    data_patients %>% filter(`Age years` >= 18, Indication == "CAI", Treatment == "EMPIRICAL", `Diagnosis code` == "Pye", AWaRe %in% AWaRe_abx) %>% nrow()
  )
) %>%
  mutate(
    Percent = sprintf("%.1f%%", 100 * Count / total_prescriptions)
  )

# Display table
knitr::kable(
  prescription_summary,
  col.names = c("Prescription Category", "Number of Prescriptions", "Proportion of All Prescriptions"),
  format = "html",
  align = "lcr"  # Left-align category, center number, right-align proportion
) %>%
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 13
  ) %>%
  kableExtra::column_spec(2:3, width = "8em") 

```

***


<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìò WHO AWaRe-QIs Overview
</h1>

This script evaluates **THREE** WHO AWaRe indicators:


<div style="background-color: #e9f7fa; border-left: 6px solid #17a2b8; padding: 12px; margin-top: 20px; margin-bottom: 20px;">
1. <strong>H_UUTI_APPROP_DOSAGE</strong>: Proportion of patients presenting with Upper UTIs prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book.<br><br>
2. <strong>H_UUTI_WATCH_ABX</strong>: Proportion of patients with Upper UTI given IV/oral AWaRe Book Watch antibiotics..<br><br>
3. <strong>H_UUTI_IV_ABX</strong>: Proportion of patients presenting with Upper UTI given IV antibiotics.
</div>


<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
<strong>üîç WHO AWaRe Book Recommendation:</strong><br><br>

<ul style="list-style-type: none; padding-left: 0; line-height: 1.8;">
  <li><strong>- Ciprofloxacin</strong> (500 mg q12h ORAL)</li>
OR
  <li><strong>- Cefotaxime</strong> (1 g q8h IV/IM) <strong>OR</strong> <strong>Ceftriaxone</strong> (1 g q24h IV/IM)</li>
AND/OR
  <li><strong>- Amikacin</strong> (15 mg/kg q24h IV)</li>
AND/OR 
  <li><strong>Gentamicin</strong> (5 mg/kg q24h IV)</li>
</ul>
</div>

<div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin-top: 10px; margin-bottom: 18px;">
<strong>ü©∫ WHO AWaRe Notes:</strong>
<ul style="line-height: 1.8;">
  <li>This recommendation focuses on community-acquired pyelonephritis in patients with no catheter</li>
  <li>Step down to oral treatment is based on improvement of symptoms</li>
  <li>Consider amikacin or gentamicin where ESBL-producing isolates are highly prevalent</li>
  <li>In very sick patients, amikacin or gentamicin can be given in combination with cefotaxime or ceftriaxone</li>
</ul>
</div>

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">

***

<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 1 ‚Äì IV Antibiotic Choice Appropriateness
</h1>

 > **H_UUTI_APPROP_DOSAGE:** Proportion of patients presenting with Upper UTIs prescribed the recommended total daily dose of IV antibiotics according to the WHO AWaRe Book.
 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#   Data preparation: antibiotic choice appropriateness

#  Prepare the data (Select UTI data only)
data_UTI_choice <- data_patients %>%
  filter(`Diagnosis code` == "Pye") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

#  Lookup ABX names for Upper UTI QI
lookup_names <- data_lookup %>%
  filter(Code == "H_UUTI_APPROP_DOSAGE") %>%
  select(starts_with("ABX-ATC")) %>%
  unlist(use.names = FALSE)

#  Flag matched prescriptions
data_UTI_choice <- data_UTI_choice %>%
  mutate(
    Drug_Match = ATC5 %in% lookup_names
  )

#  Extract lookup info 
lookup_UTI_choice <- data_lookup %>%
  filter(Code == "H_UUTI_APPROP_DOSAGE")

# Create long format from lookup
lookup_long <- tibble(
  Drug = unlist(lookup_UTI_choice %>% select(starts_with("ABX-ATC")), use.names = FALSE),
  Choice = unlist(lookup_UTI_choice %>% select(starts_with("ABX-CHOICE")), use.names = FALSE)
) %>%
  filter(!is.na(Drug))  # Remove empty rows

# Merge choice info with patient-level data
data_UTI_choice <- data_UTI_choice %>%
  left_join(lookup_long, by = c("ATC5" = "Drug"))

# Add Department info to patient summary
patient_summary_UTI <- data_UTI_choice %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>% 
  summarise(

    Abx_names = list(unique(ATC5[Route == "P"])),

    # Match flags
    Match_2 = any(ATC5 == lookup_names[2]),
    Match_3 = any(ATC5 == lookup_names[3]),
    Match_4 = any(ATC5 == lookup_names[4]),
    Match_5 = any(ATC5 == lookup_names[5]),
    
    # Route-specific match flags
    Match_2_P = any(ATC5 == lookup_names[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names[5] & Route == "P"),
    
    Any_Oral = any(Route == "O"),  # Any oral antibiotic regardless of match
    Any_IV = any(Route == "P"),  # Any IV antibiotic regardless of match
    N_ABX = n_distinct(ATC5),
    
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    Num_recommended_given = sum(c_across(Match_2_P:Match_5_P)),
    All_IV_names_flat = paste0(unlist(Abx_names), collapse = ","),

    # Full match = recommended pair given and no extra IV abx
    Received_full_recommended_IV = (
  (
    # Monotherapy cases
    (Match_2_P & Num_recommended_given == 1 & N_ABX == 1) |
    (Match_3_P & Num_recommended_given == 1 & N_ABX == 1) |
    (Match_4_P & Num_recommended_given == 1 & N_ABX == 1) |
    (Match_5_P & Num_recommended_given == 1 & N_ABX == 1) 
  ) |
  (
    # Dual therapy cases
    ( (Match_2_P & Match_4_P) |
      (Match_2_P & Match_5_P) |
      (Match_3_P & Match_4_P) |
      (Match_3_P & Match_5_P)) &
     Num_recommended_given == 2 & N_ABX == 2
  )
),

   # No match at all with recommended options
    Received_no_recommended_IV = Any_IV & Num_recommended_given == 0,

    # Partial = recommended abx used, but not in full combo or with extra abx
    Received_partial_recommended_IV = Any_IV & !Received_full_recommended_IV & !Received_no_recommended_IV,

    # flag patients who only got oral or non-matching routes
    Received_oral_only = Any_Oral & !Any_IV,
    Other_non_IV_or_oral = !Received_full_recommended_IV & !Received_partial_recommended_IV & 
                           !Received_no_recommended_IV & !Received_oral_only
  ) %>%
  ungroup()


#  Get not eligible patients with department info
not_eligible_patients_UTI <- data_UTI_choice %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(Ineligible = all(AWaRe_compatible == FALSE), .groups = "drop") %>%
  filter(Ineligible)

#  Create summary table with Department name
eligible_long_UTI <- patient_summary_UTI %>%
  select(`Survey Number`, `Department name`, Received_full_recommended_IV, Received_partial_recommended_IV, Received_no_recommended_IV, Received_oral_only, Other_non_IV_or_oral) %>%
  pivot_longer(
    cols = -c(`Survey Number`, `Department name`),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(Value = as.logical(Value)) %>%
  filter(Value) %>%
  group_by(`Department name`, Indicator) %>%
  summarise(Patients = n(), .groups = "drop")

# Get all possible combinations of departments and indicators
all_combos <- expand_grid(
  `Department name` = unique(patient_summary_UTI$`Department name`),
  Indicator = c("Received_full_recommended_IV", "Received_partial_recommended_IV", "Received_no_recommended_IV", "Received_oral_only", "Other_non_IV_or_oral", "Not_Eligible")
)

# Left join and replace NAs with 0
eligible_long_UTI <- all_combos %>%
  left_join(eligible_long_UTI, by = c("Department name", "Indicator")) %>%
  mutate(Patients = replace_na(Patients, 0))


# Add not eligible
ineligible_summary_UTI <- not_eligible_patients_UTI %>%
  count(`Department name`) %>%
  mutate(Indicator = "Not_Eligible") %>%
  rename(Patients = n)

# Combine
qi_long_UTI <- bind_rows(eligible_long_UTI, ineligible_summary_UTI)

# Calculate total per department
dept_totals <- qi_long_UTI %>%
  group_by(`Department name`) %>%
  summarise(Total = sum(Patients), .groups = "drop")

# Final summary table with proportions
qi_summary_UTI <- qi_long_UTI %>%
  left_join(dept_totals, by = "Department name") %>%
  mutate(
    Indicator = case_when(
      Indicator == "Received_full_recommended_IV" ~ "Received recommended IV antibiotics",
      Indicator == "Received_partial_recommended_IV" ~ "Partially received recommended IV antibiotics",
      Indicator == "Received_no_recommended_IV" ~ "Received IV antibiotics not among recommended options",
      Indicator == "Received_oral_only" ~ "Received oral antibiotics",
      Indicator == "Other_non_IV_or_oral" ~ "Received other non-IV/oral antibiotics",
      Indicator == "Not_Eligible" ~ "Not eligible for AWaRe Upper UTIs QIs",
      TRUE ~ Indicator
    ),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  select(`Department name`, Indicator, Patients, Total, Proportion)

#  Add Hospital Total row 
hospital_data <- qi_summary_UTI %>%
  group_by(Indicator) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  select(`Department name`, Indicator, Patients)

# Combine with original data
qi_summary_UTI <- bind_rows(qi_summary_UTI, hospital_data)

# Recalculate totals and proportions
qi_summary_UTI <- qi_summary_UTI %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()

# Format "Hospital" label to bold
qi_summary_UTI <- qi_summary_UTI %>%
  mutate(`Department name` = ifelse(`Department name` == "Hospital-Wide", "Hospital-Wide", `Department name`))

```
 

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice Appropriateness for Upper UTI
</h2>

This section assesses whether adult inpatients with **CA-Upper UTI** were prescribed the appropriate empirical IV antibiotics based on the WHO AWaRe Antibiotic Book.

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Label definitions
indicator_labels <- c(
  "Received_full_recommended_IV"     = "Received recommended IV antibiotics",
  "Received_partial_recommended_IV"  = "Partially received recommended IV antibiotics",
  "Received_no_recommended_IV"       = "Received IV antibiotics not among recommended options",
  "Received_oral_only"               = "Received oral antibiotics",
  "Other_non_IV_or_oral"       = "Received other non-IV/oral antibiotics",
  "Not_Eligible"                     = "Not eligible for AWaRe Upper UTIs QIs"
)

# Color codes
drug_choice_colors <- c(
  "Received recommended IV antibiotics"      = "#1F77B4",
  "Partially received recommended IV antibiotics" = "#4FA9DC",
  "Received IV antibiotics not among recommended options"    = "#EF476F",
  "Received oral antibiotics"                     = "#F9D99E",
  "Received other non-IV/oral antibiotics"        = "#D3D3D3",
  "Not eligible for AWaRe Upper UTIs QIs"             = "#A9A9A9"
)


# Prepare PlotLabel with Hospital-Wide highlighted and ordered first
qi_summary_UTI <- qi_summary_UTI %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(
      PlotLabel,
      levels = c(
        "<b style='color:#0072B2;'>Hospital-Wide</b>",
        sort(setdiff(unique(`Department name`), "Hospital-Wide"))
      )
    ),
    Indicator = factor(
      Indicator,
      levels = c(
        "Received recommended IV antibiotics",
        "Partially received recommended IV antibiotics",
        "Received IV antibiotics not among recommended options",
        "Received oral antibiotics",
        "Received other non-IV/oral antibiotics",
        "Not eligible for AWaRe Upper UTIs QIs"
      )
    )
  )

# Create the plot
ggplot(qi_summary_UTI, aes(x = PlotLabel, y = Proportion, fill = Indicator)) +

  # Highlight Hospital-Wide bar
  annotate("rect",
           xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +

  # Proportional stacked bars
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  # Inside counts
  geom_text(
    aes(label = ifelse(Patients > 0, Patients, "")),
    position = position_fill(vjust = 0.5),
    size = 3, color = "black"
  ) +

  # Total n= above bars
  geom_text(
    data = qi_summary_UTI %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0.6
  ) +

  # Color scheme and legend
  scale_fill_manual(values = drug_choice_colors, labels = indicator_labels) +
  scale_y_continuous(limits = c(0, 1.09), expand = c(0, 0)) +

  # Labels and styling
  labs(
    title = "Antibiotic Choice Appropriateness Summary for Upper UTI",
    subtitle = "Each bar shows distribution of appropriateness against WHO AWaRe guidelines (n = raw patient counts)",
    x = "Department",
    y = "Proportional Stacked Bars",
    fill = "Treatment Appropriateness Category"
  ) +

  theme_minimal(base_size = 8) +
  theme(
    axis.text.x = ggtext::element_markdown(size = 8, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 8),
    axis.title = element_text(face = "bold", size = 10),
    legend.position = "right",
    legend.title = element_text(face = "bold", size = 8),
    legend.text = element_text(size = 8, margin = margin(b = 4)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 7, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 10, 10, 10)
  ) +

  guides(
    fill = guide_legend(nrow = 7, byrow = FALSE, title.position = "top")
  )

```


***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice Appropriateness for Upper UTI
</h2>

This visual summarises the proportion of antibiotic choice appropriateness for Upper UTI across hospital departments based on the WHO AWaRe Book.


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}

# Total eligible patients (excluding 'Not eligible' group)
total_eligible <- qi_summary_UTI %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator != "Not eligible for AWaRe Upper UTIs QIs") %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Total receiving any IV antibiotic (via eligible categories)
total_iv <- qi_summary_UTI %>%
  filter(`Department name` != "Hospital-Wide") %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  )) %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Filter relevant data
relevant_data <- qi_summary_UTI %>%
  filter(Indicator %in% c(
    "Received recommended IV antibiotics",
    "Partially received recommended IV antibiotics",
    "Received IV antibiotics not among recommended options"
  ))

# If no relevant patients, show no-data summary
if (is.na(total_iv) || total_iv == 0 || nrow(relevant_data) == 0) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients with IV antibiotic data for upper UTIs.<br><br>
    <em>This may indicate that no patients received IV antibiotics, or none met the inclusion criteria during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Build proportion summary
  summary_data_UTI <- relevant_data %>%
    group_by(`Department name`, Indicator) %>%
    summarise(Patients = sum(Patients), .groups = "drop") %>%
    pivot_wider(
      names_from = Indicator,
      values_from = Patients,
      values_fill = 0
    ) %>%
    mutate(
      Total = `Received recommended IV antibiotics` +
              `Partially received recommended IV antibiotics` +
              `Received IV antibiotics not among recommended options`,
      Prop_Recommended = `Received recommended IV antibiotics` / Total,
      Prop_Partial = `Partially received recommended IV antibiotics` / Total,
      Prop_Not_Recommended = `Received IV antibiotics not among recommended options` / Total
    ) %>%
    filter(Total > 0)

  # Intro block
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible upper UTI patients who received any IV antibiotic 
    (<strong>{total_iv}</strong> out of <strong>{total_eligible}</strong>)
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Format summary blocks
  formatted_blocks <- summary_data_UTI %>%
    mutate(
      block = pmap_chr(
        list(
          `Department name`,
          Prop_Recommended, `Received recommended IV antibiotics`,
          Prop_Partial, `Partially received recommended IV antibiotics`,
          Prop_Not_Recommended, `Received IV antibiotics not among recommended options`,
          Total
        ),
        function(dept, prop_rec, n_rec, prop_part, n_part, prop_not, n_not, total_n) {
          color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
          bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

          glue::glue(
            "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

            <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

            <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
              <li>‚úÖ <strong>Received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                <strong>{scales::percent(prop_rec, accuracy = 0.1)}</strong> 
                ({n_rec} out of {total_n})
              </li>

              <li>‚ö†Ô∏è <strong>Partially received recommended IV antibiotics</strong> (as per WHO AWaRe Book): 
                <strong>{scales::percent(prop_part, accuracy = 0.1)}</strong> 
                ({n_part} out of {total_n})
              </li>

              <li>‚ùå <strong>Received IV antibiotics not among recommended options</strong> (as per WHO AWaRe Book): 
                <strong>{scales::percent(prop_not, accuracy = 0.1)}</strong> 
                ({n_not} out of {total_n})
              </li>
            </ul>

            </div>"
          )
        }
      )
    ) %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order) %>%
    pull(block)

  # Final HTML output
  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}




```


---

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Choice & Dosage Appropriateness for Upper UTIs
</h2>
 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}


# Data preparation: antibiotic choice & dosage appropriateness

#   Filter Upper UTI Patients and Add AWaRe Eligibility 
data_UTI2 <- data_patients %>%
  filter(`Diagnosis code` == "Pye") %>%
  mutate(
    Route = toupper(Route),
    ATC5 = trimws(toupper(ATC5)),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx, TRUE, FALSE
    )
  )

data_UTI2 <- data_UTI2 %>%
  mutate(Weight = as.numeric(Weight))

#   Lookup Drug & Dose Info for H_UUTI_APPROP_DOSAGE 
lookup2 <- data_lookup %>% filter(Code == "H_UUTI_APPROP_DOSAGE")
lookup_names2 <- unlist(lookup2[1, c("ABX-ATC-1", "ABX-ATC-2", "ABX-ATC-3", "ABX-ATC-4", "ABX-ATC-5")], use.names = FALSE)
lookup_names2 <- toupper(trimws(lookup_names2))

#   Compute Total Daily Dose for each row  
data_UTI2 <- data_UTI2 %>%
  mutate(
    Unit_Factor = case_when(
      Unit == "mg" ~ 1,
      Unit == "g"  ~ 1000,
      TRUE         ~ NA_real_
    ),
    Total_Daily_Dose = as.numeric(`Single Unit Dose`) * as.numeric(`N Doses/day`) * Unit_Factor
  )

#   Match Drug + Dose + Route 
for (i in 1:5) {
  name_col <- paste0("ABX-ATC-", i)
  dose_col <- paste0("ABX-DOSE-", i)
  freq_col <- paste0("ABX-DAY-DOSE-", i)
  unit_col <- paste0("ABX-UNIT-", i)
  route_col <- paste0("ABX-ROUTE-", i)

  dose_match_col <- paste0("Match_Drug_Dose_", i)

  # standarised lookup info
  
    # Lookup values
  drug_lookup <- toupper(trimws(lookup2[[name_col]]))
  unit_value <- lookup2[[unit_col]]
  dose <- as.numeric(lookup2[[dose_col]])
  freq <- as.numeric(lookup2[[freq_col]])
  
    # Convert units to mg
  unit_factor <- case_when(
    unit_value == "mg" ~ 1,
    unit_value == "g" ~ 1000,
    unit_value == "mg/kg" ~ 1,
    TRUE ~ NA_real_
  )
  
    # Expected dose
  expected_dose <- if (!is.na(unit_value) && unit_value == "mg/kg") {
    dose * freq * data_UTI2$Weight * unit_factor
  } else {
    dose * freq * unit_factor
  }
  
 # Expected dose & match against actual dose with tolerance for mg/kg
data_UTI2[[dose_match_col]] <- ifelse(
  data_UTI2$ATC5 == drug_lookup &
  (
    # Use ¬±10% tolerance if mg/kg
    if (!is.na(unit_value) && unit_value == "mg/kg") {
      abs(data_UTI2$Total_Daily_Dose - expected_dose) / expected_dose <= 0.10
    } else {
      abs(data_UTI2$Total_Daily_Dose - expected_dose) < 1  # strict match for others
    }
  ),
  TRUE, FALSE
)

}


#   Summarise at Patient Level 
patient_summary2 <- data_UTI2 %>%
  filter(AWaRe_compatible) %>%
  group_by(`Survey Number`, `Department name`) %>%
  summarise(
    
    Match_2_P = any(ATC5 == lookup_names2[2] & Route == "P"),
    Match_3_P = any(ATC5 == lookup_names2[3] & Route == "P"),
    Match_4_P = any(ATC5 == lookup_names2[4] & Route == "P"),
    Match_5_P = any(ATC5 == lookup_names2[5] & Route == "P"),

    Dose_2 = any(Match_Drug_Dose_2),
    Dose_3 = any(Match_Drug_Dose_3),
    Dose_4 = any(Match_Drug_Dose_4),
    Dose_5 = any(Match_Drug_Dose_5),
    
    Any_IV = any(Route == "P"),

    .groups = "drop"
  ) %>%
mutate(
  
  # Define presence of any recommended IV antibiotic
    Any_Recommended_IV_Given =  Match_2_P | Match_3_P |Match_4_P | Match_5_P,

  # Define if any recommended dosage among recommended ones
    Any_Recommended_Dose_Correct = (Match_2_P & Dose_2) |
                                   (Match_3_P & Dose_3) |
                                   (Match_4_P & Dose_4) |
                                   (Match_5_P & Dose_5),
 
  
  # Define if all recommended IV antibiotics given had recommended doses
    All_Matched_And_Dosed = (
      ((Match_2_P & Dose_2) & (!Match_4_P & !Match_5_P)) |
      ((Match_3_P & Dose_3) & (!Match_4_P & !Match_5_P)) |
      ((Match_4_P & Dose_4) & (!Match_2_P & !Match_3_P)) |
      ((Match_5_P & Dose_5) & (!Match_2_P & !Match_3_P)) |
      ((Match_2_P & Dose_2) & (Match_4_P & Dose_4)) |
      ((Match_2_P & Dose_2) & (Match_5_P & Dose_5)) |
      ((Match_3_P & Dose_3) & (Match_4_P & Dose_4)) |
      ((Match_3_P & Dose_3) & (Match_5_P & Dose_5)) 
      ),

  Dose_Result = case_when(
      # Fully recommended recommended IVs and all at recommended dosage
      All_Matched_And_Dosed ~ "Received recommended IV antibiotics with recommended dosage",

      # At least one recommended IV with recommended dosage
      Any_Recommended_IV_Given & Any_Recommended_Dose_Correct & !All_Matched_And_Dosed ~
        "Received at least one recommended IV antibiotic with only one has recommended dosage",

      # Received recommended IV(s) but none were at recommended dose
      Any_Recommended_IV_Given & !Any_Recommended_Dose_Correct ~
        "Received at least one recommended IV antibiotic with none have recommended dosage",

      # Received IV but none were from recommended list
      Any_IV & !Any_Recommended_IV_Given ~
        "Received IV antibiotics not among recommended options",

      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Dose_Result))


# Create Summary Table by Department (with 0s for missing combos)
all_categories <- unique(patient_summary2$Dose_Result)

iv_dose_counts2 <- patient_summary2 %>%
  group_by(`Department name`, Dose_Result) %>%
  summarise(Patients = n(), .groups = "drop")

all_combos2 <- expand_grid(
  `Department name` = unique(patient_summary2$`Department name`),
  Dose_Result = all_categories
)

iv_dose_summary2 <- all_combos2 %>%
  left_join(iv_dose_counts2, by = c("Department name", "Dose_Result")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Add Hospital-Wide Summary Row
hospital_row2 <- iv_dose_summary2 %>%
  group_by(Dose_Result) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = round(100 * Patients / Total, 1)
  ) %>%
  ungroup()

# Combine and Sort Final Output
final_summary2 <- bind_rows(iv_dose_summary2, hospital_row2) %>%
  arrange(`Department name`, Dose_Result)

```




This visual summarises the proportion of antibiotic choice & dosage appropriateness for Upper UTI across hospital departments based on the WHO AWaRe Book.
 
 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# Define all Dose_Result categories
all_categories2 <- c(
  "Received recommended IV antibiotics with recommended dosage",
  "Received at least one recommended IV antibiotic with only one has recommended dosage",
  "Received at least one recommended IV antibiotic with none have recommended dosage",
  "Received IV antibiotics not among recommended options"
)

# Set Dose_Result as an ordered factor
final_summary2$Dose_Result <- factor(final_summary2$Dose_Result, levels = all_categories2)

# Fill in all missing Department √ó Category combos (0 patients)
complete_summary <- expand_grid(
  `Department name` = unique(final_summary2$`Department name`),
  Dose_Result = all_categories2
) %>%
  left_join(final_summary2, by = c("Department name", "Dose_Result")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1)),
    Dose_Result = factor(Dose_Result, levels = all_categories2)  # ensure factor level order
  )

# Format Department labels
complete_summary <- complete_summary %>%
  mutate(
    PlotLabel = ifelse(`Department name` == "Hospital-Wide",
                       "<b style='color:#0072B2;'>Hospital-Wide</b>",
                       `Department name`),
    PlotLabel = factor(PlotLabel, levels = c("<b style='color:#0072B2;'>Hospital-Wide</b>",
                                             sort(setdiff(unique(`Department name`), "Hospital-Wide"))))
  )

# Plot
ggplot(complete_summary, aes(x = PlotLabel, y = Proportion, fill = Dose_Result)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1, fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  geom_text(aes(label = ifelse(Proportion > 5, paste0(Proportion, "%"), "")),
            position = position_fill(vjust = 0.5),
            size = 3, color = "black") +
  geom_text(
    data = complete_summary %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.015, label = paste0("n=", Total)),
    inherit.aes = FALSE,
    size = 3, color = "gray30", hjust = 0
  ) +
  scale_fill_manual(
    values = c(
    "Received recommended IV antibiotics with recommended dosage" = "#084594",
    "Received at least one recommended IV antibiotic with only one has recommended dosage" = "#6BAED6",
    "Received at least one recommended IV antibiotic with none have recommended dosage" = "#FC9272",
    "Received IV antibiotics not among recommended options" = "#D3D3D3"
    ),
    drop = FALSE
  ) +
  coord_flip(ylim = c(0, 1.05)) +
  labs(
    title = "Antibiotic Choice and Dosage Appropriateness for Upper UTI Cases",
    subtitle = "Categories reflect appropriateness of single or combined antibiotic regimens (n = patient counts)",
    x = "Department",
    y = "Proportional Stacked Bars",
    fill = "Treatment Classification"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 8),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(margin = margin(r = 2)),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 8, color = "gray30"),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.8),
    plot.margin = margin(10, 80, 10, 10)
  ) +
  guides(
    fill = guide_legend(nrow = 4, byrow = F, title.position = "top")
  )


```

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">
  <strong>üí° Notes:</strong>
  <ul style='margin-top: 8px; padding-left: 20px; line-height: 1.6;'>
    <li><strong>Received recommended IV antibiotics with recommended dosage</strong> indicates that the full recommended treatment regimen (whether monotherapy or dual therapy) was given, with all dosages aligned with WHO AWaRe Book guidance.</li>  <br>
    <li><strong>Received at least one recommended IV antibiotic with one has recommended dosage</strong> refers to cases where only part of the recommended dual therapy was given, and only one antibiotic was at the recommended dosage. </li> <br>
    <li><strong>Received at least one recommended IV antibiotic with none have recommended dosage</strong> includes cases who received either the full recommended regimen with no recommended dosages, or only part of it (e.g., one agent from a dual therapy) with none of the dosages aligned with WHO AWaRe Book guidance. </li> 
  </ul>
</div>

***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of Antibiotic Choice & Dosage Appropriateness for Upper UTI
</h2>
This section evaluates the **appropriateness of IV antibiotic drug dosage** for patients with Upper UTIs, in line with the WHO AWaRe Book guidance.

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE, fig.dim = c(8, 6)}
# Exclude Hospital-Wide + non-recommended for total count
final_summary2_UTI_filtered <- final_summary2 %>%
  filter(`Department name` != "Hospital-Wide",
         Dose_Result != "Received IV antibiotics not among recommended options")

# Calculate total eligible patients
total_approp_iv_given <- final_summary2_UTI_filtered %>%
  summarise(Total = sum(Patients, na.rm = TRUE)) %>%
  pull(Total)

# Handle zero eligible patients (gracefully show message)
if (is.na(total_approp_iv_given) || total_approp_iv_given == 0) {
  final_summary_html2 <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients with appropriate IV antibiotic data for <strong>upper UTIs</strong>.<br><br>
    <em>This may indicate that no patients met the inclusion criteria, or that no patients received recommended IV antibiotics during the reporting period.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html2)
} else {
  # Intro block
  intro_text2 <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible Upper UTI patients who received recommended (<em>or partially recommended</em>) IV antibiotic choice based on WHO AWaRe Book (<strong>{total_approp_iv_given}</strong> out of {total_eligible})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # Categories to summarize
  all_categories2 <- c(
    "Received recommended IV antibiotics with recommended dosage",
    "Received at least one recommended IV antibiotic with only one has recommended dosage",
    "Received at least one recommended IV antibiotic with none have recommended dosage"
  )

  dept_list <- unique(final_summary2$`Department name`)

  complete_summary <- expand_grid(
    `Department name` = dept_list,
    Dose_Result = all_categories2
  ) %>%
    left_join(final_summary2, by = c("Department name", "Dose_Result")) %>%
    filter(Dose_Result %in% all_categories2) %>%
    mutate(
      Patients = replace_na(Patients, 0),
      Total = ave(Patients, `Department name`, FUN = sum),
      Proportion = ifelse(Total == 0, 0, round(100 * Patients / Total, 1))
    )

  # Icons
  get_icon <- function(label) {
    label_lower <- tolower(trimws(label))
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("<span style='color:#28a745;'>‚úÖ</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("<span style='color:#e6b800;'>‚ö†Ô∏è</span>")
    } else if (label_lower == "received at least one recommended iv antibiotic with none have recommended dosage") {
      return("<span style='color:#d00;'>‚ùå</span>")
    } else {
      return("üõà")
    }
  }

  get_description <- function(label) {
    label_lower <- tolower(label)
    if (label_lower == "received recommended iv antibiotics with recommended dosage") {
      return("Received recommended IV antibiotics with recommended dosage")
    } else if (label_lower == "received at least one recommended iv antibiotic with only one has recommended dosage") {
      return("Received at least one recommended IV antibiotic with only one has recommended dosage")
    } else if (label_lower == "received at least one recommended IV antibiotic with none have recommended dosage") {
      return("Received at least one recommended IV antibiotic with none have recommended dosage")
    } else {
      return(paste("Received:", label))
    }
  }

  # Generate department-wise HTML blocks
  formatted_blocks2 <- complete_summary %>%
    group_by(`Department name`) %>%
    summarise(
      block = {
        dept <- first(`Department name`)
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"
        total_patients <- max(Total, na.rm = TRUE)

        list_items <- purrr::map_chr(all_categories2, function(label) {
          row_data <- complete_summary %>%
            filter(`Department name` == dept, Dose_Result == label)
          count <- row_data$Patients
          prop <- row_data$Proportion
          icon <- get_icon(label)
          description <- get_description(label)

          glue::glue(
            "<li>{icon} <strong>{description}</strong> (as per WHO AWaRe Book): 
            <strong>{scales::percent(prop / 100, accuracy = 0.1)}</strong> 
            ({count} out of {total_patients})</li>"
          )
        })

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_patients} patients)</span><br><br>
          <ul style='margin-left: 1.2em; line-height: 1.7; padding-left: 0; list-style-type: none;'>
          {paste(list_items, collapse = '')}
          </ul>
          </div>"
        )
      },
      .groups = "drop"
    ) %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Final render
  final_summary_html2 <- HTML(paste0(intro_text2, paste(formatted_blocks2$block, collapse = "\n")))
  htmltools::browsable(final_summary_html2)
}
```

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 2 - IV/Oral Watch Antibiotic Use
</h1>


> **H_UUTI_WATCH_ABX:** Proportion of patients with all Upper UTIs given IV/oral Watch antibiotics.

***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of IV/Oral Antibiotic Use for Upper UTI
</h2>

This section summarises use of IV/Oral antibiotics for patients with Upper UTI across hospital departments
        
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
# Filter Upper UTI patients & flag eligibility
data_UTI <- data_patients %>%
  filter(`Diagnosis code` == "Pye") %>%
  mutate(
    Route = toupper(Route),
    AWaRe_compatible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

# Filter eligible patients only
data_UTI_eligible <- data_UTI %>%
  filter(AWaRe_compatible == TRUE)

# Total patients
total_UUTI <- data_UTI %>% distinct(`Survey Number`) %>% nrow()
eligible_UUTI <- data_UTI_eligible %>% distinct(`Survey Number`) %>% nrow()

# Handle 0 eligible patients gracefully
if (eligible_UUTI == 0) {
  final_summary_html <- HTML(glue::glue(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients with valid IV/Oral antibiotic data for <strong>Upper UTIs</strong>.<br><br>
    <em>This may indicate that no patients received antibiotics, or none met inclusion criteria.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {
  # Only include intro text if eligible patients exist
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíä <strong>Denominator:</strong> Number of eligible Upper UTI patients who received any antibiotic 
    (<strong>{eligible_UUTI}</strong> out of {total_UUTI})
    </div><br><br>
    <strong>Summary:</strong><br><br>"
  )

  # One row per patient per AWaRe + Route group
  summary_watch <- data_UTI_eligible %>%
    mutate(
      Route_Group = case_when(
        Route %in% c("P", "O") ~ "IV_ORAL",
        TRUE ~ "OTHER"
      ),
      WATCH_IV_ORAL = (AWaRe == "WATCH" & Route_Group == "IV_ORAL"),
      WATCH_OTHER   = (AWaRe == "WATCH" & Route_Group == "OTHER"),
      NON_WATCH     = (AWaRe != "WATCH")
    ) %>%
    group_by(`Survey Number`, `Department name`) %>%
    summarise(
      WATCH_IV_ORAL = any(WATCH_IV_ORAL),
      WATCH_OTHER   = any(WATCH_OTHER),
      NON_WATCH     = any(NON_WATCH),
      .groups = "drop"
    )

  # Department-level summary
  summary_watch_dept <- summary_watch %>%
    group_by(`Department name`) %>%
    summarise(
      Eligible = n(),
      WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
      WATCH_OTHER = sum(WATCH_OTHER),
      NON_WATCH = sum(NON_WATCH),
      Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
      Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
      Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1),
      .groups = "drop"
    )

  # Hospital-wide summary
  summary_watch_total <- summary_watch %>%
    summarise(
      `Department name` = "Hospital-Wide",
      Eligible = n(),
      WATCH_IV_ORAL = sum(WATCH_IV_ORAL),
      WATCH_OTHER = sum(WATCH_OTHER),
      NON_WATCH = sum(NON_WATCH),
      Prop_WATCH_IV_ORAL = round(100 * WATCH_IV_ORAL / Eligible, 1),
      Prop_WATCH_OTHER = round(100 * WATCH_OTHER / Eligible, 1),
      Prop_NON_WATCH = round(100 * NON_WATCH / Eligible, 1)
    )

  summary_watch_final <- bind_rows(summary_watch_total, summary_watch_dept)

  # Build formatted summary blocks
  formatted_blocks <- summary_watch_final %>%
    mutate(block = pmap_chr(
      list(
        `Department name`,
        Prop_WATCH_IV_ORAL, WATCH_IV_ORAL,
        Prop_WATCH_OTHER, WATCH_OTHER,
        Prop_NON_WATCH, NON_WATCH,
        Eligible
      ),
      function(dept, ivoral_p, ivoral_n, other_p, other_n, nonwatch_p, nonwatch_n, total_n) {
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>

          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>

          <ul style='margin-left: 1.2em; line-height: 1.8; padding-left: 0; list-style-type: none;'>
            <li>
              <span style='display: inline-block; background-color: #007bff; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>1</span>
              <strong>Received a WATCH antibiotic via IV or Oral route</strong>: <strong>{scales::percent(ivoral_p / 100, accuracy = 0.1)}</strong> ({ivoral_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #17a2b8; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>2</span>
              <strong>Received a WATCH antibiotic via other route</strong>: <strong>{scales::percent(other_p / 100, accuracy = 0.1)}</strong> ({other_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #ffc107; color: black; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>3</span>
              <strong>Received a NON-WATCH antibiotic</strong>: <strong>{scales::percent(nonwatch_p / 100, accuracy = 0.1)}</strong> ({nonwatch_n} out of {total_n})
            </li>
          </ul>
          </div>"
        )
      }
    ))

  formatted_blocks <- formatted_blocks %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  # Final render
  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks$block, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}

```


***

<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The proportions are based on the number of unique Upper UTI patients per department for each specific combination of WHO AWaRe antibiotic category and route of administration. A patient contributes to the count for each distinct AWaRe category and route combination they received. Receiving the same combination multiple times does not increase the count for that combination for that patient.
  <br>
</div>


***



<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by AWaRe Classification
</h2>

This visual summarises the proportion of antibiotic prescription for Upper UTI across hospital departments by WHO AWaRe Classification (Access, Watch, Reserve)

 
```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#  Summarise AWaRe category by department
aware_summary <- data_UTI_eligible %>%
  group_by(`Department name`, Survey_ID = `Survey Number`, AWaRe) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, AWaRe) %>%
  summarise(Patients = n(), .groups = "drop")

#  Create hospital-level summary
hospital_row <- aware_summary %>%
  group_by(AWaRe) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide")

#  Define AWaRe levels
aware_levels_stack <- c("UNCLASSIFIED", "NOT RECOMMENDED", "RESERVE", "WATCH", "ACCESS")
aware_levels_legend <- c("ACCESS", "WATCH", "RESERVE", "NOT RECOMMENDED", "UNCLASSIFIED")

#  Ensure all AWaRe levels are represented per department (even if 0)
all_combos2 <- expand_grid(
  `Department name` = unique(c(aware_summary$`Department name`, "Hospital-Wide")),
  AWaRe = aware_levels_stack
)

aware_summary_all <- all_combos2 %>%
  left_join(bind_rows(aware_summary, hospital_row), by = c("Department name", "AWaRe")) %>%
  mutate(Patients = replace_na(Patients, 0)) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  ungroup()


aware_summary_all$AWaRe <- factor(aware_summary_all$AWaRe, levels = aware_levels_stack)

#  Format Hospital-Wide label and PlotLabel for axis
aware_summary_all <- aware_summary_all %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

aware_summary_all$PlotLabel <- factor(
  aware_summary_all$PlotLabel,
  levels = rev(c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(aware_summary_all$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  ))
)

#  Plot
ggplot(aware_summary_all, aes(x = PlotLabel, y = Proportion, fill = AWaRe)) +
  annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 1,
           fill = "gray95", alpha = 0.5) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +
  
  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.5, color = "black"
  ) +

  geom_text(
    data = aware_summary_all %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.03, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0, size = 3.5, color = "gray30"
  ) +

  scale_fill_manual(
    breaks = aware_levels_legend,
    values = c(
      "ACCESS" = "#1b9e77",
      "WATCH" = "#ff7f00",
      "RESERVE" = "#e41a1c",
      "NOT RECOMMENDED" = "#8c510a",
      "UNCLASSIFIED" = "gray70"
    )
  ) +
  coord_flip(ylim = c(0, 1.08)) +
  labs(
    title = "Proportion of Upper UTI Patients on Antibiotics by AWaRe",
    x = "Department",
    y = "Proportion of Patients",
    fill = "AWaRe Category"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.y = ggtext::element_markdown(size = 10),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 12),
    panel.border = element_rect(color = "gray70", fill = NA),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.margin = margin(10, 10, 10, 10)
  )


```

<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The AWaRe classification divides antibiotics into three categories: Access, Watch, and Reserve. Access antibiotics are first-line treatments with a low risk of resistance, typically recommended for common infections. Watch antibiotics are associated with a higher risk of resistance and require careful monitoring. Reserve antibiotics are reserved for critical cases involving resistant infections, typically used only when other options are ineffective </strong>.
  <br>
</div>

<div style="background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 12px; margin-top: 10px;">  <strong>üí° Note:</strong> This count in this visual represents the number of unique patients who were prescribed at least one antibiotic within a specific WHO AWaRe category (Access, Watch, or Reserve) during their encounter. A patient is counted once for each distinct AWaRe category they received an antibiotic from.
  <br>
</div>



***
<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by Route of Administration
</h2>

This visual summarises the proportion of Upper UTI Patients on Watch Antibiotics across hospital departments by Route of Administration


```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}
#  Filter eligible Upper UTI patients receiving WATCH antibiotics
watch_route_summary <- data_UTI_eligible %>%
  filter(AWaRe == "WATCH") %>%
  mutate(
    Route_Clean = case_when(
      Route %in% c("P", "O") ~ "IV/Oral",
      TRUE ~ "Others"
    )
  ) %>%
  group_by(`Department name`, `Survey Number`, Route_Clean) %>%
  summarise(Prescriptions = n(), .groups = "drop") %>%
  group_by(`Department name`, Route_Clean) %>%
  summarise(Patients = n_distinct(`Survey Number`), .groups = "drop") %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Patients),
    Proportion = Patients / Total
  )


#  Add hospital-level row
hospital_watch_summary <- watch_route_summary %>%
  group_by(Route_Clean) %>%
  summarise(Patients = sum(Patients), .groups = "drop") %>%
  mutate(
    `Department name` = "Hospital-Wide",
    Total = sum(Patients),
    Proportion = Patients / Total
  ) %>%
  select(names(watch_route_summary))  # Match column order

# Combine with main data
watch_route_final <- bind_rows(watch_route_summary, hospital_watch_summary)

# Ensure all department √ó route combinations are present
route_levels <- c("IV/Oral", "Others")
all_combos3 <- expand_grid(
  `Department name` = unique(watch_route_final$`Department name`),
  Route_Clean = route_levels
)

# Rebuild full dataset with 0s where missing
watch_route_final <- all_combos3 %>%
  left_join(watch_route_final, by = c("Department name", "Route_Clean")) %>%
  mutate(
    Patients = replace_na(Patients, 0),
    Total = ave(Patients, `Department name`, FUN = sum),
    Proportion = ifelse(Total > 0, Patients / Total, 0)
  )


#  Create PlotLabel with HTML styling
watch_route_final <- watch_route_final %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    )
  )

# Reorder PlotLabel so Hospital-Wide appears first
watch_route_final$PlotLabel <- factor(
  watch_route_final$PlotLabel,
  levels = c(
    "<b style='color:#0072B2;'>Hospital-Wide</b>",
    sort(setdiff(unique(watch_route_final$PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
  )
)


#  Plot
ggplot(watch_route_final, aes(x = PlotLabel, y = Proportion, fill = Route_Clean)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85) +

  geom_text(
    aes(label = ifelse(Proportion > 0.05, scales::percent(Proportion, accuracy = 1), "")),
    position = position_fill(vjust = 0.5),
    size = 3.2, color = "black"
  ) +

  geom_text(
    data = watch_route_final %>% distinct(PlotLabel, Total),
    aes(x = PlotLabel, y = 1.05, label = paste0("n = ", Total)),
    inherit.aes = FALSE,
    hjust = 0.5, size = 3.3, color = "gray30"
  ) +

  scale_fill_manual(
    values = c(
      "IV/Oral" = "#3B8EDE",
      "Others" = "#e41a1c"
    ),
    labels = c("IV/Oral" = "IV or Oral", "Others" = "Other Routes")
  ) +

  labs(
    title = "Route of Administration for WATCH Antibiotics (Upper UTI Patients)",
    subtitle = "Among eligible patients only",
    x = "Department",
    y = "Proportion of Patients",
    fill = "Route"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_markdown(angle = 45, hjust = 1),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "gray70", fill = NA)
  )

```


<div style='background-color: #f8f9fa; padding: 10px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> This visual shows the proportion of unique Upper UTI patients in each department who received at least one antibiotic from the WHO <strong>Watch</strong> category, considering the route of administration. A patient is counted once for each distinct route through which they received a Watch antibiotic.
  <br>
</div>

<hr style="border-top: 3px dashed #28a745; margin-top: 25px; margin-bottom: 15px;">


<h1 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìå Indicator 3 ‚Äì IV Antibiotic Use
</h1>

> **H_UUTI_IV_ABX:** Proportion of patients presenting with Upper UTI given IV antibiotics.


<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìù Summary of IV Antibiotic Use for Upper UTI
</h2>

This section evaluates whether patients with **CA-Upper UTI** received empiric IV antibiotics.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#  Filter Upper UTI patients & flag eligibility
data_UUTI <- data_patients %>%
  filter(`Diagnosis code` == "Pye") %>%
  mutate(
    Route = toupper(Route),
    Eligible = ifelse(
      `Age years` >= 18 & Indication == "CAI" & Treatment == "EMPIRICAL" & AWaRe %in% AWaRe_abx,
      TRUE, FALSE
    )
  )

#  Keep eligible patients only
data_UUTI_eligible <- data_UUTI %>%
  filter(Eligible == TRUE)

#  Define global denominator values
total_UUTI <- data_UUTI %>% distinct(`Survey Number`) %>% nrow()
eligible_UUTI <- data_UUTI_eligible %>% distinct(`Survey Number`) %>% nrow()

# ==== HANDLE NO ELIGIBLE PATIENTS ====
if (eligible_UUTI == 0) {
  final_summary_html <- HTML(paste0(
    "<div style='background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 14px; margin-top: 10px;'>
    ‚ö†Ô∏è <strong>No summary available</strong> ‚Äî there are currently no eligible patients with valid IV antibiotic data for <strong>Upper UTIs</strong>.<br><br>
    <em>This may indicate that no patients received antibiotics, or none met inclusion criteria.</em>
    </div>"
  ))
  htmltools::browsable(final_summary_html)

} else {

  #  Build HTML-formatted intro block (only if eligible patients exist)
  intro_text <- glue::glue(
    "<div style='background-color: #f8f9fa; border-left: 5px solid #17a2b8; padding: 14px; margin-top: 10px; margin-bottom: 10px;'>
    üíâ <strong>Denominator:</strong> Number of eligible Upper UTI patients who received any antibiotic (<strong>{eligible_UUTI}</strong> out of {total_UUTI})
    </div><br><br>"
  )

  #  Summarise whether IV route was used
  summary_iv <- data_UUTI_eligible %>%
    group_by(`Survey Number`, `Department name`) %>%
    summarise(
      Received_IV = any(Route == "P"),
      .groups = "drop"
    )

  summary_iv_dept <- summary_iv %>%
    group_by(`Department name`) %>%
    summarise(
      Eligible = n(),
      Received_IV = sum(Received_IV),
      Not_IV = Eligible - Received_IV,
      Prop_IV = round(100 * Received_IV / Eligible, 1),
      Prop_Not = round(100 * Not_IV / Eligible, 1),
      .groups = "drop"
    )

  summary_iv_total <- summary_iv %>%
    summarise(
      `Department name` = "Hospital-Wide",
      Eligible = n(),
      Received_IV = sum(Received_IV),
      Not_IV = Eligible - Received_IV,
      Prop_IV = round(100 * Received_IV / Eligible, 1),
      Prop_Not = round(100 * Not_IV / Eligible, 1)
    )

  summary_iv_final <- bind_rows(summary_iv_total, summary_iv_dept)

  formatted_blocks3 <- summary_iv_final %>%
    mutate(block = pmap_chr(
      list(`Department name`, Prop_IV, Received_IV, Prop_Not, Not_IV, Eligible),
      function(dept, iv_p, iv_n, not_p, not_n, total_n) {
        color <- if (dept == "Hospital-Wide") "#0072B2" else "#6c757d"
        bg <- if (dept == "Hospital-Wide") "#f0f0f0" else "#ffffff"

        glue::glue(
          "<div style='background-color: {bg}; border-left: 5px solid {color}; padding: 14px; margin-bottom: 20px;'>
          <strong>üè• {dept}</strong> <span style='color: #888;'>(n = {total_n} patients)</span><br><br>
          <ul style='margin-left: 1.2em; line-height: 1.8; padding-left: 0; list-style-type: none;'>
            <li>
              <span style='display: inline-block; background-color: #007bff; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>1</span>
              <strong>Received IV antibiotic</strong>: <strong>{scales::percent(iv_p / 100, accuracy = 0.1)}</strong> ({iv_n} out of {total_n})
            </li>
            <li>
              <span style='display: inline-block; background-color: #ffc107; color: black; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 12px; margin-right: 8px;'>2</span>
              <strong>Did not receive IV antibiotic</strong>: <strong>{scales::percent(not_p / 100, accuracy = 0.1)}</strong> ({not_n} out of {total_n})
            </li>
          </ul>
          </div>"
        )
      }
    ))

  formatted_blocks3 <- formatted_blocks3 %>%
    mutate(order = ifelse(`Department name` == "Hospital-Wide", 0, 1)) %>%
    arrange(order, `Department name`) %>%
    select(-order)

  final_summary_html <- HTML(paste0(intro_text, paste(formatted_blocks3$block, collapse = "\n")))
  htmltools::browsable(final_summary_html)
}


```


***

<div style='background-color: #f8f9fa; padding: 12px; border-left: 5px solid #17a2b8;'>
  <strong>üí° Note:</strong> The proportions shown reflect the number of unique adult patients with Upper UTIs who received antibiotics via the IV or non-IV (e.g., oral or other) route. Each patient is counted only once per route category, even if multiple antibiotics were prescribed via the same route.
</div>

***

<h2 style="color: #4a4a4a; font-weight: bold; margin-top: 1.5em;">
üìà Antibiotic Prescription by Route of Administration
</h2>

This visual summarises the proportion of patients with Upper UTI who received an IV antibiotic across hospital departments by route of administration

```{r echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, error=FALSE}

#  Classify each eligible Upper UTI prescription route
summary_iv_route <- data_UUTI_eligible %>%
  mutate(
    Route_Group = case_when(
      Route == "P" ~ "IV",
      Route == "O" ~ "Oral",
      TRUE ~ "Other"
    )
  ) %>%
  distinct(`Survey Number`, `Department name`, Route_Group) %>%
  count(`Department name`, Route_Group, name = "Count")

#  Ensure all combinations exist (even with 0s)
dept_list <- unique(data_UUTI_eligible$`Department name`)
route_levels <- c("IV", "Oral", "Other")

complete_grid <- expand.grid(
  `Department name` = dept_list,
  Route_Group = route_levels,
  stringsAsFactors = FALSE
)

summary_iv_route <- complete_grid %>%
  left_join(summary_iv_route, by = c("Department name", "Route_Group")) %>%
  mutate(Count = replace_na(Count, 0))

#  Add hospital-wide summary
hospital_route_summary <- summary_iv_route %>%
  group_by(Route_Group) %>%
  summarise(Count = sum(Count), .groups = "drop") %>%
  mutate(`Department name` = "Hospital-Wide")

#  Combine and prepare for plotting
plot_data <- bind_rows(summary_iv_route, hospital_route_summary) %>%
  group_by(`Department name`) %>%
  mutate(
    Total = sum(Count),
    Proportion = ifelse(Total == 0, 0, Count / Total),
    Label = ifelse(Proportion > 0.05, paste0(round(Proportion * 100), "%\n(n=", Count, ")"), "")
  ) %>%
  ungroup() %>%
  mutate(
    PlotLabel = ifelse(
      `Department name` == "Hospital-Wide",
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      `Department name`
    ),
    PlotLabel = factor(PlotLabel, levels = c(
      "<b style='color:#0072B2;'>Hospital-Wide</b>",
      sort(setdiff(unique(PlotLabel), "<b style='color:#0072B2;'>Hospital-Wide</b>"))
    )),
    Route_Group = factor(Route_Group, levels = route_levels)
  )

#  Donut-style faceted pie chart
ggplot(plot_data, aes(x = 2, y = Proportion, fill = Route_Group)) +
  geom_bar(stat = "identity", width = 0.1) +
  coord_polar(theta = "y") +
  facet_wrap(~ PlotLabel, nrow = 2, strip.position = "bottom", drop = FALSE) +
  geom_text(aes(label = Label), position = position_stack(vjust = 0.5), size = 2.5, color = "white") +
  scale_fill_manual(
    values = c("IV" = "#4682B4", "Oral" = "#CD5C5C", "Other" = "#A9A9A9")
  ) +
  theme_void(base_size = 10) +
  theme(
    strip.text = ggtext::element_markdown(face = "bold", size = 8),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Route of Antibiotic Use by Department (Upper UTI)",
    fill = "Route"
  )


```



***
